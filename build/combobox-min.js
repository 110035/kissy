/*
Copyright 2013, KISSY UI Library v1.30
MIT Licensed
build time: May 30 17:52
*/
KISSY.add("combobox/base",function(c,f,i,k,j,g){function a(){this.get("input")[0].focus();o.call(this)}function b(d,b){var a=d.get("el"),e=d.get("prefixCls")+"combobox-invalid",g=d.get("invalidEl");b?(a.addClass(e),g.attr("title",b),g.show()):(a.removeClass(e),g.hide())}function e(d,b){var a=d.get("menu");if(a&&!a.isController)if(b)a=i.create(a,d),d.setInternal("menu",a);else return null;return a}function q(){var d=e(this);d&&d.get("visible")&&this.alignInternal()}function h(){var d=this;d._focusoutDismissTimer=
setTimeout(function(){d.set("collapsed",!0)},30)}function o(){var d;if(d=this._focusoutDismissTimer)clearTimeout(d),this._focusoutDismissTimer=null}function s(){var d;this._stopNotify||(d=this.getValueInternal(),d===g?this.set("collapsed",!0):(this._savedInputValue=d,this.sendRequest(d)))}function r(d){var b,a=[],g,h,f=e(this,1),d=this.normalizeData(d);f.removeChildren(!0);f.set("highlightedItem",null);if(d&&d.length){for(h=0;h<d.length;h++)b=d[h],a.push(f.addChild(b));if(this.get("highlightMatchItem")){d=
this.getValueInternal();for(h=0;h<a.length;h++)if(a[h].get("textContent")==d){f.set("highlightedItem",a[h]);g=!0;break}}if(!g&&this.get("autoHighlightFirst"))for(h=0;h<a.length;h++)if(!a[h].get("disabled")){f.set("highlightedItem",a[h]);break}this.set("collapsed",!1);q.call(this)}else this.set("collapsed",!0)}var m,j=f.all,n=f.KeyCodes,p={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},l=j(c.Env.host);return m=i.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(d){var b,
a,e;if(d&&d.length){d=d.slice(0,this.get("maxItemCount"));b=this.get("format")?this.get("format").call(this,this.getValueInternal(),d):[];for(e=0;e<d.length;e++)a=d[e],b[e]=c.mix({content:a,textContent:a,value:a},b[e])}return b},bindUI:function(){this.get("input").on("valuechange",s,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(d){this.get("input").val(d)},alignInternal:function(){var d=this.get("menu"),b=c.clone(d.get("align"));b.node=this.get("el");
c.mix(b,p,!1);d.set("align",b)},handleFocus:function(){var d;b(this,!1);(d=this.get("placeholderEl"))&&d.hide()},handleBlur:function(){var d=this,a=d.get("placeholderEl"),e;m.superclass.handleBlur.apply(d,arguments);h.call(d);e=d.get("input");d.validate(function(a,h){a?!d.get("focused")&&h==e.val()&&b(d,a):b(d,!1)});a&&!e.val()&&a.show()},handleMouseDown:function(d){var b,a;m.superclass.handleMouseDown.apply(this,arguments);b=d.target;a=this.get("trigger");if(this.get("hasTrigger")&&(a[0]==b||a.contains(b)))b=
this.get("input"),this.get("collapsed")?(b[0].focus(),this.sendRequest("")):this.set("collapsed",!0),d.preventDefault()},handleKeyEventInternal:function(d){var b,a,h;a=e(this);this.get("input");if(b=this.get("updateInputOnDownUp"))this._stopNotify=c.inArray(d.keyCode,[n.UP,n.DOWN,n.ESC])?1:0;if(a&&a.get("visible")){h=a.handleKeydown(d);if(d.keyCode==n.ESC)return this.set("collapsed",!0),b&&this.setValueInternal(this._savedInputValue),!0;a=a.get("activeItem");b&&c.inArray(d.keyCode,[n.DOWN,n.UP])&&
this.setValueInternal(a.get("textContent"));return d.keyCode==n.TAB&&a&&(a.performActionInternal(),this.get("multiple"))?!0:h}return d.keyCode==n.DOWN||d.keyCode==n.UP?(this.sendRequest(this.getValueInternal()),!0):g},syncUI:function(){var b=this.get("input"),a=this.get("inputValue");a!=g&&b.val(a);this.get("placeholder")&&(b.val()||this.get("placeholderEl").show())},validate:function(b){var a=this.get("validator"),e=this.get("input").val();a?a(e,function(a){b(a,e)}):b(!1,e)},bindMenu:function(){var b=
this,e,g;g=b.get("menu");g.on("click",function(a){a=a.target.get("textContent");b._stopNotify=1;b.setValueInternal(a);b._savedInputValue=a;b.set("collapsed",!0);setTimeout(function(){b._stopNotify=0},50)});l.on("resize",b.__repositionBuffer=c.buffer(q,50),b);e=g.get("el");g=g.get("contentEl");e.on("focusout",h,b);e.on("focusin",o,b);g.on("mouseover",a,b);g.on("mousedown",function(){b._stopNotify=1});g.on("mouseup",function(){b._stopNotify=0});b.bindMenu=c.noop},sendRequest:function(b){this.get("dataSource").fetchData(b,
r,this)},_onSetCollapsed:function(b){if(b)(b=e(this))&&b.hide();else{var b=this.get("el"),a=e(this,1);o.call(this);if(a&&!a.get("visible")){a.render();this.bindMenu();if(this.get("matchElWidth")){a.render();var g=a.get("el"),g=(parseInt(g.css("borderLeftWidth"))||0)+(parseInt(g.css("borderRightWidth"))||0);a.set("width",b[0].offsetWidth-g)}a.show();this.get("input").attr("aria-owns",a.get("el").attr("id"))}}},destructor:function(){var b=this.__repositionBuffer;b&&(l.detach("resize",b,this),b.stop())}},
{ATTRS:{input:{view:1},inputValue:{view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{},setter:function(b){b&&b.isController&&b.setInternal("parent",this)}},defaultChildXClass:{value:"popupmenu"},collapsed:{view:1},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:k}}},
{xclass:"combobox",priority:10})},{requires:["node","component/base","./render","menu"]});KISSY.add("combobox",function(c,f,i,k,j,g){f.LocalDataSource=j;f.RemoteDataSource=g;f.FilterSelect=k;f.MultiValueComboBox=i;return f},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(c,f){function i(a){var b=j,e;b||(b=f.create(k));"textarea"==""+a.type?f.css(b,"width",f.css(a,"width")):f.css(b,"width",9999);c.each(g,function(e){f.css(b,e,f.css(a,e))});j||(e=a.ownerDocument.body,e.insertBefore(b,e.firstChild));return j=b}var k="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",j,g="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(a){var a=f.get(a),b=a.ownerDocument,e,g,h=a.scrollTop,o=a.scrollLeft;if(b.selection)return b=b.selection.createRange(),{left:b.boundingLeft+o+f.scrollLeft(),top:b.boundingTop+h+b.boundingHeight+f.scrollTop()};e=f.offset(a);if("textarea"!=a.type)return e.top+=a.offsetHeight,e;g=i(a);b=a.selectionStart;g.innerHTML=c.escapeHTML(a.value.substring(0,b-1))+"<span>x</span>";f.offset(g,e);e=g.lastChild;a=f.offset(e);a.top+=f.height(e);0<b&&(a.left+=f.width(e));a.top-=h;a.left-=o;return a}},
{requires:["dom"]});KISSY.add("combobox/filter-select",function(c,f){var i=f.extend({validate:function(f){var c=this;i.superclass.validate.call(c,function(g,a){g?f(g,a):c.get("dataSource").fetchData(a,function(b){a:{if(b=c.normalizeData(b))for(var e=0;e<b.length;e++)if(b[e].textContent==a){b=b[e];break a}b=!1}f(b?"":c.get("invalidMessage"),a,b)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return i},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(c){function f(){f.superclass.constructor.apply(this,arguments)}f.ATTRS={data:{value:[]},parse:{value:function(f,k){var j=[],g=0;if(!f)return k;c.each(k,function(a){-1!=a.indexOf(f)&&j.push(a);g++});return j}}};c.extend(f,c.Base,{fetchData:function(f,c,j){var g=this.get("parse"),a=this.get("data"),a=g(f,a);c.call(j,a)}});return f},{requires:["component/base"]});
KISSY.add("combobox/multi-value-combobox",function(c,f,i){function k(b,a){return a&&-1!=b.indexOf(a)}function j(b){var e=b.get("input"),f=e.val(),h=[],c=[],j=b.get("literal"),i=b.get("separator"),b=b.get("separatorType"),m=!1,n=b!=g,e=e.prop("selectionStart"),p,l,d=-1;for(p=0;p<f.length;p++)(l=f.charAt(p),j&&l==j&&(m=!m),m)?c.push(l):(p==e&&(d=h.length),n&&a.test(l))?(c.length&&h.push(c.join("")),c=[],c.push(l)):k(i,l)?b==g?(c.push(l),c.length&&h.push(c.join("")),c=[]):(c.length&&h.push(c.join("")),
c=[],c.push(l)):c.push(l);c.length&&h.push(c.join(""));h.length||h.push("");-1==d&&(b==g&&k(i,l)&&h.push(""),d=h.length-1);return{tokens:h,cursorPosition:e,tokenIndex:d}}var g="suffix",a=/\s|\xa0/;return i.extend({getValueInternal:function(){this.get("input");var b=j(this),a=b.tokens,c=b.tokenIndex,b=this.get("separator"),h=this.get("separatorType"),a=a[c],c=a.length-1;if(h!=g)if(k(b,a.charAt(0)))a=a.slice(1);else return;else h==g&&k(b,a.charAt(c))&&(a=a.slice(0,c));return a},setValueInternal:function(b){var e=
this.get("input"),c=j(this),h=c.tokens,c=Math.max(0,c.tokenIndex),f=this.get("separator"),i=this.get("separatorType"),r=h[c+1]||"",m=h[c];if(i!=g){if(h[c]=m.charAt(0)+b,!r||!a.test(r.charAt(0)))h[c]+=" "}else h[c]=b,b=m.length-1,k(f,m.charAt(b))?h[c]+=m.charAt(b):1==f.length&&(h[c]+=f);b=h.slice(0,c+1).join("").length;e.val(h.join(""));e.prop("selectionStart",b);e.prop("selectionEnd",b)},alignInternal:function(){if(this.get("alignWithCursor")){var b=j(this),a=b.tokens,c=this.get("menu"),g=b.cursorPosition,
k=b.tokenIndex,b=this.get("input"),a=a.slice(0,k).join("").length;0<a&&++a;b.prop("selectionStart",a);b.prop("selectionEnd",a);a=f(b);b.prop("selectionStart",g);b.prop("selectionEnd",g);c.set("xy",[a.left,a.top])}else i.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:g},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox",priority:20})},{requires:["./cursor","./base"]});
KISSY.add("combobox/RemoteDataSource",function(c,f){function i(){i.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}i.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};c.extend(i,c.Base,{fetchData:function(c,i,g){var a=this,b,e=a.get("paramName"),q=a.get("parse"),h=a.get("cache"),o=a.get("allowEmpty");a.io&&(a.io.abort(),a.io=null);if(!c&&!0!==o)return i.call(g,[]);if(h&&(b=a.caches[c]))return i.call(g,b);b=a.get("xhrCfg");b.data=b.data||{};b.data[e]=
c;b.success=function(b){q&&(b=q(c,b));a.setInternal("data",b);h&&(a.caches[c]=b);i.call(g,b)};a.io=f(b)}});return i},{requires:["ajax"]});
KISSY.add("combobox/render",function(c,f,i){var k=c.all,j=f.Render.extend({createDom:function(){var g,a=this.get("input"),b=this.get("prefixCls"),e=this.get("el"),f=this.get("trigger");this.get("srcNode")||(e.append(c.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:b})),g=e.one("."+b+"combobox-input-wrap"),a=a||c.all(c.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',{prefixCls:b})),
g.append(a),this.setInternal("input",a));f||this.setInternal("trigger",c.all(c.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:b})));this.get("trigger").unselectable(i);this.setInternal("invalidEl",k("<div class='"+b+"combobox-invalid-el'><div class='"+b+"combobox-invalid-inner'></div></div>").insertBefore(a.parent(i,i),i));if(f=this.get("placeholder")){if(!(g=a.attr("id")))a.attr("id",g=c.guid("ks-combobox-input"));
this.setInternal("placeholderEl",k('<label for="'+g+'" class="'+b+'combobox-placeholder">'+f+"</label>").appendTo(e))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",c)},_onSetHasTrigger:function(c){var a=this.get("trigger");c?this.get("el").prepend(a):a.remove()},_onSetDisabled:function(c){j.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},
input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")}}});return j},{requires:["component/base"]});
