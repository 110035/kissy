/*
Copyright 2013, KISSY UI Library v1.30
MIT Licensed
build time: Jun 5 15:56
*/
KISSY.add("combobox/base",function(d,c,i,k,j,h){function b(){this.get("input")[0].focus();o.call(this)}function a(e,a){var b=e.get("el"),g=e.get("prefixCls")+"combobox-invalid",h=e.get("invalidEl");a?(b.addClass(g),h.attr("title",a),h.show()):(b.removeClass(g),h.hide())}function g(e,a){var b=e.get("menu");if(b&&!b.isController)if(a)b=i.create(b,e),e.setInternal("menu",b);else return null;return b}function q(){var e=g(this);e&&e.get("visible")&&this.alignInternal()}function f(){var e=this;e._focusoutDismissTimer=
setTimeout(function(){e.set("collapsed",!0)},30)}function o(){var e;if(e=this._focusoutDismissTimer)clearTimeout(e),this._focusoutDismissTimer=null}function s(){var e;this._stopNotify||(e=this.getValueInternal(),e===h?this.set("collapsed",!0):(this._savedInputValue=e,this.sendRequest(e)))}function r(e){var a,b=[],h,f,c=g(this,1),e=this.normalizeData(e);c.removeChildren(!0);c.set("highlightedItem",null);if(e&&e.length){for(f=0;f<e.length;f++)a=e[f],b.push(c.addChild(a));if(this.get("highlightMatchItem")){e=
this.getValueInternal();for(f=0;f<b.length;f++)if(b[f].get("textContent")==e){c.set("highlightedItem",b[f]);h=!0;break}}if(!h&&this.get("autoHighlightFirst"))for(f=0;f<b.length;f++)if(!b[f].get("disabled")){c.set("highlightedItem",b[f]);break}this.set("collapsed",!1);q.call(this)}else this.set("collapsed",!0)}var n,j=c.all,l=c.KeyCodes,p={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},m=j(d.Env.host);return n=i.Controller.extend({_savedInputValue:null,_stopNotify:0,normalizeData:function(e){var a,
b,g;if(e&&e.length){e=e.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueInternal(),e):[];for(g=0;g<e.length;g++)b=e[g],a[g]=d.mix({content:b,textContent:b,value:b},a[g])}return a},bindUI:function(){this.get("input").on("valuechange",s,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(e){this.get("input").val(e)},alignInternal:function(){var e=this.get("menu"),a=d.clone(e.get("align"));a.node=this.get("el");
d.mix(a,p,!1);e.set("align",a)},handleFocus:function(){var e;a(this,!1);(e=this.get("placeholderEl"))&&e.hide()},handleBlur:function(){var e=this,b=e.get("placeholderEl"),g;n.superclass.handleBlur.apply(e,arguments);f.call(e);g=e.get("input");e.validate(function(b,f){b?!e.get("focused")&&f==g.val()&&a(e,b):a(e,!1)});b&&!g.val()&&b.show()},handleMouseDown:function(e){var a,b;n.superclass.handleMouseDown.apply(this,arguments);a=e.target;b=this.get("trigger");if(this.get("hasTrigger")&&(b[0]==a||b.contains(a)))a=
this.get("input"),this.get("collapsed")?(a[0].focus(),this.sendRequest("")):this.set("collapsed",!0),e.preventDefault()},handleKeyEventInternal:function(e){var a,b=e.keyCode,f,c=g(this);this.get("input");if(a=this.get("updateInputOnDownUp"))this._stopNotify=d.inArray(e.keyCode,[l.UP,l.DOWN,l.ESC])?1:0;if(c&&c.get("visible")){f=c.get("activeItem");if(a&&f&&(b==l.DOWN&&f==c.getChildAt(c.get("children").length-1)||b==l.UP&&f==c.getChildAt(0)))return this.setValueInternal(this._savedInputValue),c.set("highlightedItem",
null),!0;b=c.handleKeydown(e);if(e.keyCode==l.ESC)return this.set("collapsed",!0),a&&this.setValueInternal(this._savedInputValue),!0;f=c.get("activeItem");a&&d.inArray(e.keyCode,[l.DOWN,l.UP])&&this.setValueInternal(f.get("textContent"));return e.keyCode==l.TAB&&f&&(f.performActionInternal(),this.get("multiple"))?!0:b}return e.keyCode==l.DOWN||e.keyCode==l.UP?(this.sendRequest(this.getValueInternal()),!0):h},syncUI:function(){var a=this.get("input"),b=this.get("inputValue");b!=h&&a.val(b);this.get("placeholder")&&
(a.val()||this.get("placeholderEl").show())},validate:function(a){var b=this.get("validator"),g=this.get("input").val();b?b(g,function(b){a(b,g)}):a(!1,g)},bindMenu:function(){var a=this,g,c;c=a.get("menu");c.on("click",function(b){b=b.target.get("textContent");a._stopNotify=1;a.setValueInternal(b);a._savedInputValue=b;a.set("collapsed",!0);setTimeout(function(){a._stopNotify=0},50)});m.on("resize",a.__repositionBuffer=d.buffer(q,50),a);g=c.get("el");c=c.get("contentEl");g.on("focusout",f,a);g.on("focusin",
o,a);c.on("mouseover",b,a);c.on("mousedown",function(){a._stopNotify=1});c.on("mouseup",function(){a._stopNotify=0});a.bindMenu=d.noop},sendRequest:function(a){this.get("dataSource").fetchData(a,r,this)},_onSetCollapsed:function(a){if(a)(a=g(this))&&a.hide();else{var a=this.get("el"),b=g(this,1);o.call(this);if(b&&!b.get("visible")){b.render();this.bindMenu();if(this.get("matchElWidth")){b.render();var f=b.get("el"),f=(parseInt(f.css("borderLeftWidth"))||0)+(parseInt(f.css("borderRightWidth"))||0);
b.set("width",a[0].offsetWidth-f)}b.show();this.get("input").attr("aria-owns",b.get("el").attr("id"))}}},destructor:function(){var a=this.__repositionBuffer;a&&(m.detach("resize",a,this),a.stop())}},{ATTRS:{input:{view:1},inputValue:{view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildXClass:{value:"popupmenu"},
collapsed:{view:1},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:k}}},{xclass:"combobox",priority:10})},{requires:["node","component/base","./render","menu"]});
KISSY.add("combobox",function(d,c,i,k,j,h){c.LocalDataSource=j;c.RemoteDataSource=h;c.FilterSelect=k;c.MultiValueComboBox=i;return c},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(d,c){function i(b){var a=j,g;a||(a=c.create(k));"textarea"==""+b.type?c.css(a,"width",c.css(b,"width")):c.css(a,"width",9999);d.each(h,function(g){c.css(a,g,c.css(b,g))});j||(g=b.ownerDocument.body,g.insertBefore(a,g.firstChild));return j=a}var k="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",j,h="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(b){var b=c.get(b),a=b.ownerDocument,g,h,f=b.scrollTop,o=b.scrollLeft;if(a.selection)return a=a.selection.createRange(),{left:a.boundingLeft+o+c.scrollLeft(),top:a.boundingTop+f+a.boundingHeight+c.scrollTop()};g=c.offset(b);if("textarea"!=b.type)return g.top+=b.offsetHeight,g;h=i(b);a=b.selectionStart;h.innerHTML=d.escapeHTML(b.value.substring(0,a-1))+"<span>x</span>";c.offset(h,g);g=h.lastChild;b=c.offset(g);b.top+=c.height(g);0<a&&(b.left+=c.width(g));b.top-=f;b.left-=o;return b}},
{requires:["dom"]});KISSY.add("combobox/filter-select",function(d,c){var i=c.extend({validate:function(c){var d=this;i.superclass.validate.call(d,function(h,b){h?c(h,b):d.get("dataSource").fetchData(b,function(a){a:{if(a=d.normalizeData(a))for(var g=0;g<a.length;g++)if(a[g].textContent==b){a=a[g];break a}a=!1}c(a?"":d.get("invalidMessage"),b,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return i},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(d){function c(){c.superclass.constructor.apply(this,arguments)}c.ATTRS={data:{value:[]},parse:{value:function(c,k){var j=[],h=0;if(!c)return k;d.each(k,function(b){-1!=b.indexOf(c)&&j.push(b);h++});return j}}};d.extend(c,d.Base,{fetchData:function(c,d,j){var h=this.get("parse"),b=this.get("data"),b=h(c,b);d.call(j,b)}});return c},{requires:["component/base"]});
KISSY.add("combobox/multi-value-combobox",function(d,c,i){function k(a,b){return b&&-1!=a.indexOf(b)}function j(a){var g=a.get("input"),c=g.val(),f=[],d=[],j=a.get("literal"),i=a.get("separator"),a=a.get("separatorType"),n=!1,l=a!=h,g=g.prop("selectionStart"),p,m,e=-1;for(p=0;p<c.length;p++)(m=c.charAt(p),j&&m==j&&(n=!n),n)?d.push(m):(p==g&&(e=f.length),l&&b.test(m))?(d.length&&f.push(d.join("")),d=[],d.push(m)):k(i,m)?a==h?(d.push(m),d.length&&f.push(d.join("")),d=[]):(d.length&&f.push(d.join("")),
d=[],d.push(m)):d.push(m);d.length&&f.push(d.join(""));f.length||f.push("");-1==e&&(a==h&&k(i,m)&&f.push(""),e=f.length-1);return{tokens:f,cursorPosition:g,tokenIndex:e}}var h="suffix",b=/\s|\xa0/;return i.extend({getValueInternal:function(){this.get("input");var a=j(this),b=a.tokens,c=a.tokenIndex,a=this.get("separator"),f=this.get("separatorType"),b=b[c],c=b.length-1;if(f!=h)if(k(a,b.charAt(0)))b=b.slice(1);else return;else f==h&&k(a,b.charAt(c))&&(b=b.slice(0,c));return b},setValueInternal:function(a){var c=
this.get("input"),d=j(this),f=d.tokens,d=Math.max(0,d.tokenIndex),i=this.get("separator"),s=this.get("separatorType"),r=f[d+1]||"",n=f[d];if(s!=h){if(f[d]=n.charAt(0)+a,!r||!b.test(r.charAt(0)))f[d]+=" "}else f[d]=a,a=n.length-1,k(i,n.charAt(a))?f[d]+=n.charAt(a):1==i.length&&(f[d]+=i);a=f.slice(0,d+1).join("").length;c.val(f.join(""));c.prop("selectionStart",a);c.prop("selectionEnd",a)},alignInternal:function(){if(this.get("alignWithCursor")){var a=j(this),b=a.tokens,d=this.get("menu"),f=a.cursorPosition,
h=a.tokenIndex,a=this.get("input"),b=b.slice(0,h).join("").length;0<b&&++b;a.prop("selectionStart",b);a.prop("selectionEnd",b);b=c(a);a.prop("selectionStart",f);a.prop("selectionEnd",f);d.set("xy",[b.left,b.top])}else i.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:h},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox",priority:20})},{requires:["./cursor","./base"]});
KISSY.add("combobox/RemoteDataSource",function(d,c){function i(){i.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}i.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};d.extend(i,d.Base,{fetchData:function(d,i,h){var b=this,a,g=b.get("paramName"),q=b.get("parse"),f=b.get("cache"),o=b.get("allowEmpty");b.io&&(b.io.abort(),b.io=null);if(!d&&!0!==o)return i.call(h,[]);if(f&&(a=b.caches[d]))return i.call(h,a);a=b.get("xhrCfg");a.data=a.data||{};a.data[g]=
d;a.success=function(a){q&&(a=q(d,a));b.setInternal("data",a);f&&(b.caches[d]=a);i.call(h,a)};b.io=c(a)}});return i},{requires:["ajax"]});
KISSY.add("combobox/render",function(d,c,i){var k=d.all,j=c.Render.extend({createDom:function(){var c,b=this.get("input"),a=this.get("prefixCls"),g=this.get("el"),j=this.get("trigger");this.get("srcNode")||(g.append(d.substitute('<div class="{prefixCls}combobox-input-wrap"></div>',{prefixCls:a})),c=g.one("."+a+"combobox-input-wrap"),b=b||d.all(d.substitute('<input aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" autocomplete="off" class="{prefixCls}combobox-input" />',{prefixCls:a})),
c.append(b),this.setInternal("input",b));j||this.setInternal("trigger",d.all(d.substitute('<div class="{prefixCls}combobox-trigger"><div class="{prefixCls}combobox-trigger-inner">&#x25BC;</div></div>',{prefixCls:a})));this.get("trigger").unselectable(i);this.setInternal("invalidEl",k("<div class='"+a+"combobox-invalid-el'><div class='"+a+"combobox-invalid-inner'></div></div>").insertBefore(b.parent(i,i),i));if(j=this.get("placeholder")){if(!(c=b.attr("id")))b.attr("id",c=d.guid("ks-combobox-input"));
this.setInternal("placeholderEl",k('<label for="'+c+'" class="'+a+'combobox-placeholder">'+j+"</label>").appendTo(g))}},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",c)},_onSetHasTrigger:function(c){var b=this.get("trigger");c?this.get("el").prepend(b):b.remove()},_onSetDisabled:function(c){j.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",c)}},{ATTRS:{collapsed:{value:!0},hasTrigger:{value:!0},
input:{},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")}}});return j},{requires:["component/base"]});
