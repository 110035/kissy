/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jun 5 15:50
*/
KISSY.add("combobox/combobox-tpl",function(){return'<div id="ks-combobox-invalid-el{{id}}" class="{{getBaseCssClasses "invalid-el"}}"> <div class="{{getBaseCssClasses "invalid-inner"}}"></div> </div> {{#if hasTrigger}} <div id="ks-combobox-trigger{{id}}" class="{{getBaseCssClasses "trigger"}}"> <div class="{{getBaseCssClasses "trigger-inner"}}">&#x25BC;</div> </div> {{/if}} <div class="{{getBaseCssClasses "input-wrap"}}"> <input id="ks-combobox-input{{id}}" aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" aria-expanded="false" {{#if disabled}} disabled {{/if}} autocomplete="off" class="{{getBaseCssClasses "input"}}" value="{{inputValue}}" /> <label id="ks-combobox-placeholder{{id}}" for="ks-combobox-input{{id}}" style=\'display:{{#if inputValue}}none{{else}}block{{/if}};\' class="{{getBaseCssClasses "placeholder"}}"> {{placeholder}} </label> </div>'});
KISSY.add("combobox/render",function(h,d,i){var j=d.Render.extend({initializer:function(){var e=this.get("childrenElSelectors");h.mix(e,{input:"#ks-combobox-input{id}",trigger:"#ks-combobox-trigger{id}",invalidEl:"#ks-combobox-invalid-el{id}",placeholderEl:"#ks-combobox-placeholder{id}"})},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(e){this.get("input").attr("aria-expanded",!e)},_onSetInputValue:function(e,d){d.causeByTimer||this.get("input").val(e)},_onSetDisabled:function(e){j.superclass._onSetDisabled.apply(this,
arguments);this.get("input").attr("disabled",e)}},{ATTRS:{collapsed:{value:!0,sync:0},hasTrigger:{value:!0,sync:0},inputValue:{sync:0},input:{},disabled:{sync:0},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{},contentTpl:{value:i}},HTML_PARSER:{input:function(e){return e.one("."+this.getBaseCssClass("input"))},trigger:function(e){return e.one("."+this.getBaseCssClass("trigger"))},invalidEl:function(e){return e.one("."+this.getBaseCssClass("invalid-el"))},placeholderEl:function(e){return e.one("."+
this.getBaseCssClass("placeholder"))}}});return j},{requires:["component/base","./combobox-tpl"]});
KISSY.add("combobox/base",function(h,d,i,j,e,m){function c(f){var a=this,n;n=a.get("menu");f.target==n&&(f=n.get("el"),n=n.get("contentEl"),f.on("focusout",u,a),f.on("focusin",r,a),n.on("mouseover",b,a),n.on("mousedown",function(){a.setValueInternal(a.getValueInternal())}))}function a(f){f=f.target;f.isMenuItem&&(f=f.get("textContent"),this.setValueInternal(f),this._savedInputValue=f,this.set("collapsed",!0))}function b(){this.focus();r.call(this)}function k(f,a){var n=f.get("el"),c=f.get("view").getBaseCssClasses("invalid"),
b=f.get("invalidEl");a?(n.addClass(c),b.attr("title",a),b.show()):(n.removeClass(c),b.hide())}function g(f,a){var b=f.get("menu");if(b&&!b.isController)if(a)b=f.createChild(b),f.setInternal("menu",b);else return null;return b}function q(){var f=g(this);f&&f.get("visible")&&this.alignInternal()}function u(){var f=this;f._focusoutDismissTimer=setTimeout(function(){f.set("collapsed",!0)},30)}function r(){var f;if(f=this._focusoutDismissTimer)clearTimeout(f),this._focusoutDismissTimer=null}function o(){this.set("inputValue",
this.get("input").val(),{data:{causeByTimer:1}})}function t(f){var a,b=[],c,e,k=g(this,1),f=this.normalizeData(f);k.removeChildren(!0);(e=k.get("highlightedItem"))&&e.set("highlighted",!1);if(f&&f.length){for(e=0;e<f.length;e++)a=f[e],b.push(k.addChild(a));f=this.getValueInternal();if(this.get("highlightMatchItem"))for(e=0;e<b.length;e++)if(b[e].get("textContent")==f){b[e].set("highlighted",!0);c=!0;break}if(!c&&this.get("autoHighlightFirst"))for(e=0;e<b.length;e++)if(!b[e].get("disabled")){b[e].set("highlighted",
!0);break}this.set("collapsed",!1);q.call(this)}else this.set("collapsed",!0)}var p,e=d.all,l=d.KeyCodes,s={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},v=e(h.Env.host);return p=i.Controller.extend({_savedInputValue:null,normalizeData:function(f){var a,b,c;if(f&&f.length){f=f.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueInternal(),f):[];for(c=0;c<f.length;c++)b=f[c],a[c]=h.mix({content:b,textContent:b,value:b},a[c])}return a},bindUI:function(){this.get("input").on("valuechange",
o,this);this.on("click",a,this);v.on("resize",this.__repositionBuffer=h.buffer(q,50),this);this.on("afterRenderUI",c,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(a){this.set("inputValue",a)},_onSetInputValue:function(a,b){if(b.causeByTimer){var c;c=this.getValueInternal();c===m?this.set("collapsed",!0):(this._savedInputValue=c,this.sendRequest(c))}},alignInternal:function(){var a=this.get("menu"),b=a.get("align");delete b.node;b=h.clone(b);b.node=this.get("el");
h.mix(b,s,!1);a.set("align",b)},handleFocus:function(){var a;this.get("invalidEl")&&k(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this,b=a.get("placeholderEl"),c=a.get("input");p.superclass.handleBlur.apply(a,arguments);u.call(a);a.get("invalidEl")&&a.validate(function(b,e){b?!a.get("focused")&&e==c.val()&&k(a,b):k(a,!1)});b&&!c.val()&&b.show()},handleMouseDown:function(a){var b,c;p.superclass.handleMouseDown.apply(this,arguments);b=a.target;c=this.get("trigger");
if(this.get("hasTrigger")&&(c[0]==b||c.contains(b)))this.get("input"),this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){var b,c=a.keyCode,e,k=g(this);this.get("input");b=this.get("updateInputOnDownUp");if(k&&k.get("visible")){e=k.get("highlightedItem");if(b&&e&&(c==l.DOWN&&e==k.getChildAt(k.get("children").length-1)||c==l.UP&&e==k.getChildAt(0)))return this.setValueInternal(this._savedInputValue),e.set("highlighted",
!1),!0;a=k.handleKeydown(a);e=k.get("highlightedItem");if(c==l.ESC)return this.set("collapsed",!0),b&&this.setValueInternal(this._savedInputValue),!0;b&&h.inArray(c,[l.DOWN,l.UP])&&this.setValueInternal(e.get("textContent"));return c==l.TAB&&e&&(e.performActionInternal(),this.get("multiple"))?!0:a}if(c==l.DOWN||c==l.UP)if(b=this.getValueInternal(),b!==m)return this.sendRequest(b),!0;return m},validate:function(a){var b=this.get("validator"),c=this.getValueInternal();b?b(c,function(b){a(b,c)}):a(!1,
c)},sendRequest:function(a){this.get("dataSource").fetchData(a,t,this)},_onSetCollapsed:function(a){if(a)(a=g(this))&&a.hide();else{var a=this.get("el"),b=g(this,1);r.call(this);if(b&&!b.get("visible")){if(this.get("matchElWidth")){b.render();var c=b.get("el"),c=(parseInt(c.css("borderLeftWidth"))||0)+(parseInt(c.css("borderRightWidth"))||0);b.set("width",a[0].offsetWidth-c)}b.show();this.get("input").attr("aria-owns",b.get("el").attr("id"))}}},destructor:function(){var a=this.__repositionBuffer;
a&&(v.detach("resize",a,this),a.stop())}},{ATTRS:{input:{view:1},inputValue:{value:"",sync:0,view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildCfg:{value:{xclass:"popupmenu"}},collapsed:{view:1,sync:0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},
autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:j}}},{xclass:"combobox"})},{requires:["node","component/base","./render","menu"]});
KISSY.add("combobox/cursor",function(h,d){function i(c){var a=e,b;a||(a=d.create(j));"textarea"==""+c.type?d.css(a,"width",d.css(c,"width")):d.css(a,"width",9999);h.each(m,function(b){d.css(a,b,d.css(c,b))});e||(b=c.ownerDocument.body,b.insertBefore(a,b.firstChild));return e=a}var j="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",e,m="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(c){var c=d.get(c),a=c.ownerDocument,b,e,g=c.scrollTop,q=c.scrollLeft;if(a.selection)return a=a.selection.createRange(),{left:a.boundingLeft+q+d.scrollLeft(),top:a.boundingTop+g+a.boundingHeight+d.scrollTop()};b=d.offset(c);if("textarea"!=c.type)return b.top+=c.offsetHeight,b;e=i(c);a=c.selectionStart;e.innerHTML=h.escapeHTML(c.value.substring(0,a-1))+"<span>x</span>";d.offset(e,b);b=e.lastChild;c=d.offset(b);c.top+=d.height(b);0<a&&(c.left+=d.width(b));c.top-=g;c.left-=q;return c}},
{requires:["dom"]});
KISSY.add("combobox/multi-value-combobox",function(h,d,i){function j(a,b){return b&&-1!=a.indexOf(b)}function e(a){var b=a.get("input"),e=b.val(),g=[],d=[],i=a.get("literal"),h=a.get("separator"),a=a.get("separatorType"),o=!1,t=a!=m,b=b.prop("selectionStart"),p,l,s=-1;for(p=0;p<e.length;p++)(l=e.charAt(p),i&&l==i&&(o=!o),o)?d.push(l):(p==b&&(s=g.length),t&&c.test(l))?(d.length&&g.push(d.join("")),d=[],d.push(l)):j(h,l)?a==m?(d.push(l),d.length&&g.push(d.join("")),d=[]):(d.length&&g.push(d.join("")),
d=[],d.push(l)):d.push(l);d.length&&g.push(d.join(""));g.length||g.push("");-1==s&&(a==m&&j(h,l)&&g.push(""),s=g.length-1);return{tokens:g,cursorPosition:b,tokenIndex:s}}var m="suffix",c=/\s|\xa0/;return i.extend({getValueInternal:function(){this.get("input");var a=e(this),b=a.tokens,c=a.tokenIndex,a=this.get("separator"),d=this.get("separatorType"),b=b[c],c=b.length-1;if(d!=m)if(j(a,b.charAt(0)))b=b.slice(1);else return;else d==m&&j(a,b.charAt(c))&&(b=b.slice(0,c));return b},setValueInternal:function(a){var b=
this.get("input"),d=e(this),g=d.tokens,d=Math.max(0,d.tokenIndex),i=this.get("separator"),h=this.get("separatorType"),r=g[d+1]||"",o=g[d];if(h!=m){if(g[d]=o.charAt(0)+a,!r||!c.test(r.charAt(0)))g[d]+=" "}else g[d]=a,a=o.length-1,j(i,o.charAt(a))?g[d]+=o.charAt(a):1==i.length&&(g[d]+=i);a=g.slice(0,d+1).join("").length;b.val(g.join(""));b.prop("selectionStart",a);b.prop("selectionEnd",a)},alignInternal:function(){if(this.get("alignWithCursor")){var a=e(this),b=a.tokens,c=this.get("menu"),g=a.cursorPosition,
j=a.tokenIndex,a=this.get("input"),b=b.slice(0,j).join("").length;0<b&&++b;a.prop("selectionStart",b);a.prop("selectionEnd",b);b=d(a);a.prop("selectionStart",g);a.prop("selectionEnd",g);c.set("xy",[b.left,b.top])}else i.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:m},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox"})},{requires:["./cursor","./base"]});
KISSY.add("combobox/filter-select",function(h,d){var i=d.extend({validate:function(d){var e=this;i.superclass.validate.call(e,function(i,c){i?d(i,c):e.get("dataSource").fetchData(c,function(a){a:{if(a=e.normalizeData(a))for(var b=0;b<a.length;b++)if(a[b].textContent==c){a=a[b];break a}a=!1}d(a?"":e.get("invalidMessage"),c,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return i},{requires:["./base"]});
KISSY.add("combobox/local-data-source",function(h){function d(){d.superclass.constructor.apply(this,arguments)}d.ATTRS={data:{value:[]},parse:{value:function(d,j){var e=[],m=0;if(!d)return j;h.each(j,function(c){-1!=c.indexOf(d)&&e.push(c);m++});return e}}};h.extend(d,h.Base,{fetchData:function(d,j,e){var h=this.get("parse"),c=this.get("data"),c=h(d,c);j.call(e,c)}});return d},{requires:["component/base"]});
KISSY.add("combobox/remote-data-source",function(h,d){function i(){i.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}i.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};h.extend(i,h.Base,{fetchData:function(h,e,i){var c=this,a,b=c.get("paramName"),k=c.get("parse"),g=c.get("cache"),q=c.get("allowEmpty");c.io&&(c.io.abort(),c.io=null);if(!h&&!0!==q)return e.call(i,[]);if(g&&(a=c.caches[h]))return e.call(i,a);a=c.get("xhrCfg");a.data=a.data||{};
a.data[b]=h;a.success=function(a){k&&(a=k(h,a));c.setInternal("data",a);g&&(c.caches[h]=a);e.call(i,a)};c.io=d(a)}});return i},{requires:["io"]});KISSY.add("combobox",function(h,d,i,j,e,m){d.LocalDataSource=e;d.RemoteDataSource=m;d.FilterSelect=j;d.MultiValueComboBox=i;return d},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/local-data-source","combobox/remote-data-source"]});
