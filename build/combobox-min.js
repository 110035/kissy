/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: May 30 22:39
*/
KISSY.add("combobox/combobox-tpl",function(){return'<div id="ks-combobox-invalid-el{{id}}" class="{{getBaseCssClasses "invalid-el"}}"> <div class="{{getBaseCssClasses "invalid-inner"}}"></div> </div> {{#if hasTrigger}} <div id="ks-combobox-trigger{{id}}" class="{{getBaseCssClasses "trigger"}}"> <div class="{{getBaseCssClasses "trigger-inner"}}">&#x25BC;</div> </div> {{/if}} <div class="{{getBaseCssClasses "input-wrap"}}"> <input id="ks-combobox-input{{id}}" aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" aria-expanded="false" {{#if disabled}} disabled {{/if}} autocomplete="off" class="{{getBaseCssClasses "input"}}" value="{{inputValue}}" /> <label id="ks-combobox-placeholder{{id}}" for="ks-combobox-input{{id}}" style=\'display:{{#if inputValue}}none{{else}}block{{/if}};\' class="{{getBaseCssClasses "placeholder"}}"> {{placeholder}} </label> </div>'});
KISSY.add("combobox/render",function(h,c,i){var l=c.Render.extend({initializer:function(){var e=this.get("childrenElSelectors");h.mix(e,{input:"#ks-combobox-input{id}",trigger:"#ks-combobox-trigger{id}",invalidEl:"#ks-combobox-invalid-el{id}",placeholderEl:"#ks-combobox-placeholder{id}"})},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(e){this.get("input").attr("aria-expanded",!e)},_onSetInputValue:function(e,c){c.causeByTimer||this.get("input").val(e)},_onSetDisabled:function(e){l.superclass._onSetDisabled.apply(this,
arguments);this.get("input").attr("disabled",e)}},{ATTRS:{collapsed:{value:!0,sync:0},hasTrigger:{value:!0,sync:0},inputValue:{sync:0},input:{},disabled:{sync:0},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{},contentTpl:{value:i}},HTML_PARSER:{input:function(e){return e.one("."+this.getBaseCssClass("input"))},trigger:function(e){return e.one("."+this.getBaseCssClass("trigger"))},invalidEl:function(e){return e.one("."+this.getBaseCssClass("invalid-el"))},placeholderEl:function(e){return e.one("."+
this.getBaseCssClass("placeholder"))}}});return l},{requires:["component/base","./combobox-tpl"]});
KISSY.add("combobox/base",function(h,c,i,l,e,k){function b(f){var a=this,j;j=a.get("menu");f.target==j&&(f=j.get("el"),j=j.get("contentEl"),f.on("focusout",u,a),f.on("focusin",q,a),j.on("mouseover",d,a),j.on("mousedown",function(){a.setValueInternal(a.getValueInternal())}))}function a(f){f=f.target;f.isMenuItem&&(f=f.get("textContent"),this.setValueInternal(f),this._savedInputValue=f,this.set("collapsed",!0))}function d(){this.focus();q.call(this)}function r(f,a){var j=f.get("el"),b=f.get("view").getBaseCssClasses("invalid"),
d=f.get("invalidEl");a?(j.addClass(b),d.attr("title",a),d.show()):(j.removeClass(b),d.hide())}function g(f,a){var j=f.get("menu");if(j&&!j.isController)if(a)j=f.createChild(j),f.setInternal("menu",j);else return null;return j}function p(){var f=g(this);f&&f.get("visible")&&this.alignInternal()}function u(){var f=this;f._focusoutDismissTimer=setTimeout(function(){f.set("collapsed",!0)},30)}function q(){var f;if(f=this._focusoutDismissTimer)clearTimeout(f),this._focusoutDismissTimer=null}function n(){this.set("inputValue",
this.get("input").val(),{data:{causeByTimer:1}})}function t(f){var a,j=[],d,b,e=g(this,1),f=this.normalizeData(f);e.removeChildren(!0);(b=e.get("highlightedItem"))&&b.set("highlighted",!1);if(f&&f.length){for(b=0;b<f.length;b++)a=f[b],j.push(e.addChild(a));f=this.getValueInternal();if(this.get("highlightMatchItem"))for(b=0;b<j.length;b++)if(j[b].get("textContent")==f){j[b].set("highlighted",!0);d=!0;break}if(!d&&this.get("autoHighlightFirst"))for(b=0;b<j.length;b++)if(!j[b].get("disabled")){j[b].set("highlighted",
!0);break}this.set("collapsed",!1);p.call(this)}else this.set("collapsed",!0)}var o,e=c.all,m=c.KeyCodes,s={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},v=e(h.Env.host);return o=i.Controller.extend({_savedInputValue:null,normalizeData:function(f){var a,b,d;if(f&&f.length){f=f.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueInternal(),f):[];for(d=0;d<f.length;d++)b=f[d],a[d]=h.mix({content:b,textContent:b,value:b},a[d])}return a},bindUI:function(){this.get("input").on("valuechange",
n,this);this.on("click",a,this);v.on("resize",this.__repositionBuffer=h.buffer(p,50),this);this.on("afterRenderUI",b,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(f){this.set("inputValue",f)},_onSetInputValue:function(f,a){if(a.causeByTimer){var b;b=this.getValueInternal();b===k?this.set("collapsed",!0):(this._savedInputValue=b,this.sendRequest(b))}},alignInternal:function(){var f=this.get("menu"),a=f.get("align");delete a.node;a=h.clone(a);a.node=this.get("el");
h.mix(a,s,!1);f.set("align",a)},handleFocus:function(){var a;this.get("invalidEl")&&r(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this,b=a.get("placeholderEl"),d=a.get("input");o.superclass.handleBlur.apply(a,arguments);u.call(a);a.get("invalidEl")&&a.validate(function(b,e){b?!a.get("focused")&&e==d.val()&&r(a,b):r(a,!1)});b&&!d.val()&&b.show()},handleMouseDown:function(a){var b,d;o.superclass.handleMouseDown.apply(this,arguments);b=a.target;d=this.get("trigger");
if(this.get("hasTrigger")&&(d[0]==b||d.contains(b)))this.get("input"),this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){var b,d,e;d=g(this);this.get("input");b=this.get("updateInputOnDownUp");if(d&&d.get("visible")){e=d.handleKeydown(a);if(a.keyCode==m.ESC)return this.set("collapsed",!0),b&&this.setValueInternal(this._savedInputValue),!0;d=d.get("highlightedItem");b&&h.inArray(a.keyCode,[m.DOWN,m.UP])&&this.setValueInternal(d.get("textContent"));
return a.keyCode==m.TAB&&d&&(d.performActionInternal(),this.get("multiple"))?!0:e}if(a.keyCode==m.DOWN||a.keyCode==m.UP)if(a=this.getValueInternal(),a!==k)return this.sendRequest(a),!0;return k},validate:function(a){var b=this.get("validator"),d=this.getValueInternal();b?b(d,function(b){a(b,d)}):a(!1,d)},sendRequest:function(a){this.get("dataSource").fetchData(a,t,this)},_onSetCollapsed:function(a){if(a)(a=g(this))&&a.hide();else{var a=this.get("el"),b=g(this,1);q.call(this);if(b&&!b.get("visible")){if(this.get("matchElWidth")){b.render();
var d=b.get("el"),d=(parseInt(d.css("borderLeftWidth"))||0)+(parseInt(d.css("borderRightWidth"))||0);b.set("width",a[0].offsetWidth-d)}b.show();this.get("input").attr("aria-owns",b.get("el").attr("id"))}}},destructor:function(){var a=this.__repositionBuffer;a&&(v.detach("resize",a,this),a.stop())}},{ATTRS:{input:{view:1},inputValue:{value:"",sync:0,view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},
menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildCfg:{value:{xclass:"popupmenu"}},collapsed:{view:1,sync:0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:l}}},{xclass:"combobox"})},{requires:["node","component/base","./render","menu"]});
KISSY.add("combobox/cursor",function(h,c){function i(b){var a=e,d;a||(a=c.create(l));"textarea"==""+b.type?c.css(a,"width",c.css(b,"width")):c.css(a,"width",9999);h.each(k,function(d){c.css(a,d,c.css(b,d))});e||(d=b.ownerDocument.body,d.insertBefore(a,d.firstChild));return e=a}var l="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",e,k="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(b){var b=c.get(b),a=b.ownerDocument,d,e,g=b.scrollTop,p=b.scrollLeft;if(a.selection)return a=a.selection.createRange(),{left:a.boundingLeft+p+c.scrollLeft(),top:a.boundingTop+g+a.boundingHeight+c.scrollTop()};d=c.offset(b);if("textarea"!=b.type)return d.top+=b.offsetHeight,d;e=i(b);a=b.selectionStart;e.innerHTML=h.escapeHTML(b.value.substring(0,a-1))+"<span>x</span>";c.offset(e,d);d=e.lastChild;b=c.offset(d);b.top+=c.height(d);0<a&&(b.left+=c.width(d));b.top-=g;b.left-=p;return b}},
{requires:["dom"]});
KISSY.add("combobox/multi-value-combobox",function(h,c,i){function l(a,b){return b&&-1!=a.indexOf(b)}function e(a){var d=a.get("input"),e=d.val(),g=[],c=[],i=a.get("literal"),h=a.get("separator"),a=a.get("separatorType"),n=!1,t=a!=k,d=d.prop("selectionStart"),o,m,s=-1;for(o=0;o<e.length;o++)(m=e.charAt(o),i&&m==i&&(n=!n),n)?c.push(m):(o==d&&(s=g.length),t&&b.test(m))?(c.length&&g.push(c.join("")),c=[],c.push(m)):l(h,m)?a==k?(c.push(m),c.length&&g.push(c.join("")),c=[]):(c.length&&g.push(c.join("")),
c=[],c.push(m)):c.push(m);c.length&&g.push(c.join(""));g.length||g.push("");-1==s&&(a==k&&l(h,m)&&g.push(""),s=g.length-1);return{tokens:g,cursorPosition:d,tokenIndex:s}}var k="suffix",b=/\s|\xa0/;return i.extend({getValueInternal:function(){this.get("input");var a=e(this),b=a.tokens,c=a.tokenIndex,a=this.get("separator"),g=this.get("separatorType"),b=b[c],c=b.length-1;if(g!=k)if(l(a,b.charAt(0)))b=b.slice(1);else return;else g==k&&l(a,b.charAt(c))&&(b=b.slice(0,c));return b},setValueInternal:function(a){var d=
this.get("input"),c=e(this),g=c.tokens,c=Math.max(0,c.tokenIndex),i=this.get("separator"),h=this.get("separatorType"),q=g[c+1]||"",n=g[c];if(h!=k){if(g[c]=n.charAt(0)+a,!q||!b.test(q.charAt(0)))g[c]+=" "}else g[c]=a,a=n.length-1,l(i,n.charAt(a))?g[c]+=n.charAt(a):1==i.length&&(g[c]+=i);a=g.slice(0,c+1).join("").length;d.val(g.join(""));d.prop("selectionStart",a);d.prop("selectionEnd",a)},alignInternal:function(){if(this.get("alignWithCursor")){var a=e(this),b=a.tokens,l=this.get("menu"),g=a.cursorPosition,
h=a.tokenIndex,a=this.get("input"),b=b.slice(0,h).join("").length;0<b&&++b;a.prop("selectionStart",b);a.prop("selectionEnd",b);b=c(a);a.prop("selectionStart",g);a.prop("selectionEnd",g);l.set("xy",[b.left,b.top])}else i.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:k},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox"})},{requires:["./cursor","./base"]});
KISSY.add("combobox/filter-select",function(h,c){var i=c.extend({validate:function(c){var e=this;i.superclass.validate.call(e,function(i,b){i?c(i,b):e.get("dataSource").fetchData(b,function(a){a:{if(a=e.normalizeData(a))for(var d=0;d<a.length;d++)if(a[d].textContent==b){a=a[d];break a}a=!1}c(a?"":e.get("invalidMessage"),b,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return i},{requires:["./base"]});
KISSY.add("combobox/local-data-source",function(h){function c(){c.superclass.constructor.apply(this,arguments)}c.ATTRS={data:{value:[]},parse:{value:function(c,l){var e=[],k=0;if(!c)return l;h.each(l,function(b){-1!=b.indexOf(c)&&e.push(b);k++});return e}}};h.extend(c,h.Base,{fetchData:function(c,h,e){var k=this.get("parse"),b=this.get("data"),b=k(c,b);h.call(e,b)}});return c},{requires:["component/base"]});
KISSY.add("combobox/remote-data-source",function(h,c){function i(){i.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}i.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};h.extend(i,h.Base,{fetchData:function(h,e,i){var b=this,a,d=b.get("paramName"),r=b.get("parse"),g=b.get("cache"),p=b.get("allowEmpty");b.io&&(b.io.abort(),b.io=null);if(!h&&!0!==p)return e.call(i,[]);if(g&&(a=b.caches[h]))return e.call(i,a);a=b.get("xhrCfg");a.data=a.data||{};
a.data[d]=h;a.success=function(a){r&&(a=r(h,a));b.setInternal("data",a);g&&(b.caches[h]=a);e.call(i,a)};b.io=c(a)}});return i},{requires:["io"]});KISSY.add("combobox",function(h,c,i,l,e,k){c.LocalDataSource=e;c.RemoteDataSource=k;c.FilterSelect=l;c.MultiValueComboBox=i;return c},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/local-data-source","combobox/remote-data-source"]});
