/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jun 18 19:59
*/
KISSY.add("combobox/combobox-tpl",function(){return'<div id="ks-combobox-invalid-el-{{id}}" class="{{getBaseCssClasses "invalid-el"}}"> <div class="{{getBaseCssClasses "invalid-inner"}}"></div> </div> {{#if hasTrigger}} <div id="ks-combobox-trigger-{{id}}" class="{{getBaseCssClasses "trigger"}}"> <div class="{{getBaseCssClasses "trigger-inner"}}">&#x25BC;</div> </div> {{/if}} <div class="{{getBaseCssClasses "input-wrap"}}"> <input id="ks-combobox-input-{{id}}" aria-haspopup="true" aria-autocomplete="list" aria-haspopup="true" role="autocomplete" aria-expanded="false" {{#if disabled}} disabled {{/if}} autocomplete="off" class="{{getBaseCssClasses "input"}}" value="{{value}}" /> <label id="ks-combobox-placeholder-{{id}}" for="ks-combobox-input-{{id}}" style=\'display:{{#if value}}none{{else}}block{{/if}};\' class="{{getBaseCssClasses "placeholder"}}"> {{placeholder}} </label> </div>'});
KISSY.add("combobox/render",function(f,j,k){var i=j.Render.extend({initializer:function(){var d=this.get("childrenElSelectors");f.mix(d,{input:"#ks-combobox-input-{id}",trigger:"#ks-combobox-trigger-{id}",invalidEl:"#ks-combobox-invalid-el-{id}",placeholderEl:"#ks-combobox-placeholder-{id}"})},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(d){this.get("input").attr("aria-expanded",!d)},_onSetDisabled:function(d){i.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",
d)}},{ATTRS:{collapsed:{value:!0,sync:0},hasTrigger:{value:!0,sync:0},input:{},value:{},disabled:{sync:0},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{},contentTpl:{value:k}},HTML_PARSER:{input:function(d){return d.one("."+this.getBaseCssClass("input"))},trigger:function(d){return d.one("."+this.getBaseCssClass("trigger"))},invalidEl:function(d){return d.one("."+this.getBaseCssClass("invalid-el"))},placeholderEl:function(d){return d.one("."+this.getBaseCssClass("placeholder"))}}});return i},
{requires:["component/base","./combobox-tpl"]});
KISSY.add("combobox/base",function(f,j,k,i,d,m){function g(e){for(var a=0;a<e.length;a++)if(!e[a].get("disabled"))return e[a];return null}function a(e){var a=this,l;l=a.get("menu");e.target==l&&(a.get("input"),e=l.get("el"),l=l.get("contentEl"),e.on("focusout",function(){t(a)}),e.on("focusin",function(){setTimeout(function(){r(a)},0)}),l.on("mouseover",s,a),l.on("mousedown",function(){a.setValueFromAutocomplete(a.getValueForAutocomplete(),{force:1})}))}function b(e){e=e.target;e.isMenuItem&&(e=e.get("textContent"),
this.setValueFromAutocomplete(e),this._savedValue=e,this.set("collapsed",!0))}function s(){this.focus();r(this)}function c(e,a){var l=e.get("el"),b=e.get("view").getBaseCssClasses("invalid"),c=e.get("invalidEl");a?(l.addClass(b),c.attr("title",a),c.show()):(l.removeClass(b),c.hide())}function h(e,a){var l=e.get("menu");if(l&&!l.isController)if(a)l=e.createChild(l),e.setInternal("menu",l);else return null;return l}function u(){var e=h(this);e&&e.get("visible")&&this.alignInternal()}function t(e){e._focusoutDismissTimer||
(e._focusoutDismissTimer=setTimeout(function(){e._focusoutDismissTimer&&e.set("collapsed",!0)},50))}function r(e){var a;if(a=e._focusoutDismissTimer)clearTimeout(a),e._focusoutDismissTimer=null}function p(e){this.set("value",e.newVal,{data:{causedByTimer:1}})}function q(e){var a,l=[],c,b,d=h(this,1),e=this.normalizeData(e);d.removeChildren(!0);(b=d.get("highlightedItem"))&&b.set("highlighted",!1);if(e&&e.length){for(b=0;b<e.length;b++)a=e[b],l.push(d.addChild(a));e=this.getValueForAutocomplete();
if(this.get("highlightMatchItem"))for(b=0;b<l.length;b++)if(l[b].get("textContent")==e){l[b].set("highlighted",!0);c=!0;break}if(!c&&this.get("autoHighlightFirst"))for(b=0;b<l.length;b++)if(!l[b].get("disabled")){l[b].set("highlighted",!0);break}this.set("collapsed",!1);u.call(this)}else this.set("collapsed",!0)}var n,d=j.all,o=j.KeyCode,w={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},v=d(f.Env.host);return n=k.Controller.extend({_savedValue:null,normalizeData:function(e){var a,b,c;if(e&&e.length){e=
e.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueForAutocomplete(),e):[];for(c=0;c<e.length;c++)b=e[c],a[c]=f.mix({content:b,textContent:b,value:b},a[c])}return a},bindUI:function(){this.get("input").on("valuechange",p,this);this.on("click",b,this);v.on("resize",this.__repositionBuffer=f.buffer(u,50),this);this.on("afterRenderUI",a,this)},getValueForAutocomplete:function(){return this.get("value")},setValueFromAutocomplete:function(a,b){this.set("value",
a,b)},_onSetValue:function(a,b){var c;b.causedByTimer?(c=this.getValueForAutocomplete(),c===m?this.set("collapsed",!0):(this._savedValue=c,this.sendRequest(c))):this.get("input").val(a)},alignInternal:function(){var a=this.get("menu"),b=a.get("align");delete b.node;b=f.clone(b);b.node=this.get("el");f.mix(b,w,!1);a.set("align",b)},handleFocus:function(){var a;this.get("invalidEl")&&c(this,!1);(a=this.get("placeholderEl"))&&a.hide()},handleBlur:function(){var a=this,b=a.get("placeholderEl");n.superclass.handleBlur.apply(a,
arguments);t(a);a.get("invalidEl")&&a.validate(function(b,d){b?!a.get("focused")&&d==a.get("value")&&c(a,b):c(a,!1)});b&&!a.get("value")&&b.show()},handleMouseDown:function(a){var b,c;n.superclass.handleMouseDown.apply(this,arguments);b=a.target;if((c=this.get("trigger"))&&(c[0]==b||c.contains(b)))this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){var b,c=a.keyCode,d,i=h(this);this.get("input");b=this.get("updateInputOnDownUp");
if(i&&i.get("visible")){d=i.get("highlightedItem");if(b&&d){var s=i.get("children");if(c==o.DOWN&&d==g(s.concat().reverse())||c==o.UP&&d==g(s))return this.setValueFromAutocomplete(this._savedValue),d.set("highlighted",!1),!0}a=i.handleKeydown(a);d=i.get("highlightedItem");if(c==o.ESC)return this.set("collapsed",!0),b&&this.setValueFromAutocomplete(this._savedValue),!0;b&&f.inArray(c,[o.DOWN,o.UP])&&this.setValueFromAutocomplete(d.get("textContent"));return c==o.TAB&&d&&(d.performActionInternal(),
this.get("multiple"))?!0:a}if(c==o.DOWN||c==o.UP)b=this.getValueForAutocomplete(),b!==m&&this.sendRequest(b);return m},validate:function(a){var b=this.get("validator"),c=this.getValueForAutocomplete();b?b(c,function(b){a(b,c)}):a(!1,c)},sendRequest:function(a){this.get("dataSource").fetchData(a,q,this)},_onSetCollapsed:function(a){if(a)(a=h(this))&&a.hide();else{var a=this.get("el"),b=h(this,1);r(this);if(b&&!b.get("visible")){if(this.get("matchElWidth")){b.render();var c=b.get("el"),c=(parseInt(c.css("borderLeftWidth"))||
0)+(parseInt(c.css("borderRightWidth"))||0);b.set("width",a[0].offsetWidth-c)}b.show();this.get("input").attr("aria-owns",b.get("el").attr("id"))}}},destructor:function(){var a=this.__repositionBuffer;a&&(v.detach("resize",a,this),a.stop())}},{ATTRS:{input:{view:1},value:{value:"",view:1,sync:0},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",
this)}},defaultChildCfg:{value:{xclass:"popupmenu"}},collapsed:{view:1,sync:0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},highlightMatchItem:{value:!0},xrender:{value:i}}},{xclass:"combobox"})},{requires:["node","component/base","./render","menu"]});
KISSY.add("combobox/cursor",function(f,j){function k(a){var b=m;b||(b=i(d));"textarea"==""+a.type?b.css("width",a.css("width")):b.css("width",9999);f.each(g,function(d){b.css(d,a.css(d))});m||b.insertBefore(a[0].ownerDocument.body.firstChild);return m=b}var i=j.all,d="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",m,g="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(a){var b=i(a),a=b[0],d=a.ownerDocument,c=i(d),h=a.scrollTop,g=a.scrollLeft;if(d.selection)return a=d.selection.createRange(),{left:a.boundingLeft+g+c.scrollLeft(),top:a.boundingTop+h+a.boundingHeight+c.scrollTop()};c=b.offset();if("textarea"!=a.type)return c.top+=a.offsetHeight,c;d=k(b);b=a.selectionStart;d.html(f.escapeHTML(a.value.substring(0,b-1))+"<span>x</span>");d.offset(c);c=d.last();a=c.offset();a.top+=c.height();0<b&&(a.left+=c.width());a.top-=h;a.left-=g;return a}},{requires:["node"]});
KISSY.add("combobox/multi-value-combobox",function(f,j,k){function i(a,b){return b&&-1!=a.indexOf(b)}function d(a){var b=a.get("input"),d=a.get("value"),c=[],h=[],j=a.get("literal"),k=a.get("separator"),a=a.get("separatorType"),f=!1,p=a!=m,b=b.prop("selectionStart"),q,n,o=-1;for(q=0;q<d.length;q++)(n=d.charAt(q),j&&n==j&&(f=!f),f)?h.push(n):(q==b&&(o=c.length),p&&g.test(n))?(h.length&&c.push(h.join("")),h=[],h.push(n)):i(k,n)?a==m?(h.push(n),h.length&&c.push(h.join("")),h=[]):(h.length&&c.push(h.join("")),
h=[],h.push(n)):h.push(n);h.length&&c.push(h.join(""));c.length||c.push("");-1==o&&(a==m&&i(k,n)&&c.push(""),o=c.length-1);return{tokens:c,cursorPosition:b,tokenIndex:o}}var m="suffix",g=/\s|\xa0/;return k.extend({getValueForAutocomplete:function(){var a=d(this),b=a.tokens,g=a.tokenIndex,a=this.get("separator"),c=this.get("separatorType"),b=b[g],g=b.length-1;if(c!=m)if(i(a,b.charAt(0)))b=b.slice(1);else return;else c==m&&i(a,b.charAt(g))&&(b=b.slice(0,g));return b},setValueFromAutocomplete:function(a,
b){var j=this.get("input"),c=d(this),h=c.tokens,c=Math.max(0,c.tokenIndex),k=this.get("separator"),f;f=this.get("separatorType");var r=h[c+1]||"",p=h[c];if(f!=m){if(h[c]=p.charAt(0)+a,!r||!g.test(r.charAt(0)))a&&(h[c]+=" ")}else h[c]=a,f=p.length-1,i(k,p.charAt(f))?h[c]+=p.charAt(f):1==k.length&&(h[c]+=k);c=h.slice(0,c+1).join("").length;this.set("value",h.join(""),b);j.prop("selectionStart",c);j.prop("selectionEnd",c)},alignInternal:function(){if(this.get("alignWithCursor")){var a=this.get("menu"),
b;b=this.get("input");b=j(b);a.set("xy",[b.left,b.top])}else k.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:m},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox"})},{requires:["./cursor","./base"]});
KISSY.add("combobox/filter-select",function(f,j){var k=j.extend({validate:function(i){var d=this;k.superclass.validate.call(d,function(f,g){f?i(f,g):d.get("dataSource").fetchData(g,function(a){a:{if(a=d.normalizeData(a))for(var b=0;b<a.length;b++)if(a[b].textContent==g){a=a[b];break a}a=!1}i(a?"":d.get("invalidMessage"),g,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return k},{requires:["./base"]});
KISSY.add("combobox/local-data-source",function(f){function j(){j.superclass.constructor.apply(this,arguments)}j.ATTRS={data:{value:[]},parse:{value:function(k,i){var d=[],j=0;if(!k)return i;f.each(i,function(g){-1!=g.indexOf(k)&&d.push(g);j++});return d}}};f.extend(j,f.Base,{fetchData:function(f,i,d){var j=this.get("parse"),g=this.get("data"),g=j(f,g);i.call(d,g)}});return j},{requires:["component/base"]});
KISSY.add("combobox/remote-data-source",function(f,j){function k(){k.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}k.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};f.extend(k,f.Base,{fetchData:function(i,d,f){var g=this,a,b=g.get("paramName"),k=g.get("parse"),c=g.get("cache"),h=g.get("allowEmpty");g.io&&(g.io.abort(),g.io=null);if(!i&&!0!==h)return d.call(f,[]);if(c&&(a=g.caches[i]))return d.call(f,a);a=g.get("xhrCfg");a.data=a.data||{};
a.data[b]=i;a.success=function(a){k&&(a=k(i,a));g.setInternal("data",a);c&&(g.caches[i]=a);d.call(f,a)};g.io=j(a)}});return k},{requires:["io"]});KISSY.add("combobox",function(f,j,k,i,d,m){j.LocalDataSource=d;j.RemoteDataSource=m;j.FilterSelect=i;j.MultiValueComboBox=k;return j},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/local-data-source","combobox/remote-data-source"]});
