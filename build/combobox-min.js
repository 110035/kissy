/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: May 14 12:19
*/
KISSY.add("combobox/base",function(h,c,j,k,f,i){function b(d){var a=this,b;b=a.get("menu");d.target==b&&(d=b.get("el"),b=b.get("contentEl"),d.on("focusout",t,a),d.on("focusin",q,a),b.on("mouseover",e,a),b.on("mousedown",function(){a.setValueInternalWithSilence(a.getValueInternal())}))}function a(d){d=d.target;d.isMenuItem&&(d=d.get("textContent"),this.setValueInternalWithSilence(d),this._savedInputValue=d,this.set("collapsed",!0))}function e(){this.focus();q.call(this)}function o(d,a){var b=d.get("el"),
e=d.get("prefixCls")+"combobox-invalid",g=d.get("invalidEl");a?(b.addClass(e),g.attr("title",a),g.show()):(b.removeClass(e),g.hide())}function g(d,a){var b=d.get("menu");if(b&&!b.isController)if(a)b=j.create(b,d),d.setInternal("menu",b);else return null;return b}function p(){var d=g(this);d&&d.get("visible")&&this.alignInternal()}function t(){var d=this;d._focusoutDismissTimer=setTimeout(function(){d.set("collapsed",!0)},30)}function q(){var d;if(d=this._focusoutDismissTimer)clearTimeout(d),this._focusoutDismissTimer=
null}function m(){this.set("inputValue",this.get("input").val())}function s(d){var a,b=[],e,f,o=g(this,1),d=this.normalizeData(d);o.removeChildren(!0);(f=o.get("highlightedItem"))&&f.set("highlighted",!1);if(d&&d.length){for(f=0;f<d.length;f++)a=d[f],b.push(o.addChild(a));d=this.getValueInternal();for(f=0;f<b.length;f++)if(b[f].get("textContent")==d){b[f].set("highlighted",!0);e=!0;break}if(!e&&this.get("autoHighlightFirst"))for(f=0;f<b.length;f++)if(!b[f].get("disabled")){b[f].set("highlighted",
!0);break}this.set("collapsed",!1);p.call(this)}else this.set("collapsed",!0)}var n,f=c.all,l=c.KeyCodes,r={points:["bl","tl"],overflow:{adjustX:1,adjustY:1}},u=f(h.Env.host);return n=j.Controller.extend({_savedInputValue:null,normalizeData:function(d){var a,b,e;if(d&&d.length){d=d.slice(0,this.get("maxItemCount"));a=this.get("format")?this.get("format").call(this,this.getValueInternal(),d):[];for(e=0;e<d.length;e++)b=d[e],a[e]=h.mix({content:b,textContent:b,value:b},a[e])}return a},bindUI:function(){this.get("input").on("valuechange",
m,this);this.on("click",a,this);u.on("resize",this.__repositionBuffer=h.buffer(p,50),this);this.on("afterRenderUI",b,this)},getValueInternal:function(){return this.get("input").val()},setValueInternal:function(d){this.get("input").val(d)},_onSetInputValue:function(){var d;d=this.getValueInternal();d===i?this.set("collapsed",!0):(this._savedInputValue=d,this.sendRequest(d))},setValueInternalWithSilence:function(d){this.setValueInternal(d);this.setInternal("inputValue",this.get("input").val())},alignInternal:function(){var d=
this.get("menu"),a=d.get("align");delete a.node;a=h.clone(a);a.node=this.get("el");h.mix(a,r,!1);d.set("align",a)},handleFocus:function(){var d;this.get("invalidEl")&&o(this,!1);(d=this.get("placeholderEl"))&&d.hide()},handleBlur:function(){var d=this,a=d.get("placeholderEl"),b;n.superclass.handleBlur.apply(d,arguments);t.call(d);d.get("invalidEl")&&(b=d.get("input"),d.validate(function(a,e){a?!d.get("focused")&&e==b.val()&&o(d,a):o(d,!1)}));a&&!b.val()&&a.show()},handleMouseDown:function(a){var b,
e;n.superclass.handleMouseDown.apply(this,arguments);b=a.target;e=this.get("trigger");if(this.get("hasTrigger")&&(e[0]==b||e.contains(b)))this.get("input"),this.get("collapsed")?(this.focus(),this.sendRequest("")):this.set("collapsed",!0),a.preventDefault()},handleKeyEventInternal:function(a){var b,e,f;e=g(this);this.get("input");b=this.get("updateInputOnDownUp");if(e&&e.get("visible")){f=e.handleKeydown(a);if(a.keyCode==l.ESC)return this.set("collapsed",!0),b&&this.setValueInternalWithSilence(this._savedInputValue),
!0;e=e.get("highlightedItem");b&&h.inArray(a.keyCode,[l.DOWN,l.UP])&&this.setValueInternalWithSilence(e.get("textContent"));return a.keyCode==l.TAB&&e&&(e.performActionInternal(),this.get("multiple"))?!0:f}if(a.keyCode==l.DOWN||a.keyCode==l.UP)if(a=this.getValueInternal(),a!==i)return this.sendRequest(a),!0;return i},validate:function(a){var b=this.get("validator"),e=this.getValueInternal();b?b(e,function(b){a(b,e)}):a(!1,e)},sendRequest:function(a){this.get("dataSource").fetchData(a,s,this)},_onSetCollapsed:function(a){if(a)(a=
g(this))&&a.hide();else{var a=this.get("el"),b=g(this,1);q.call(this);b&&!b.get("visible")&&(this.get("matchElWidth")&&b.set("width",a.innerWidth()),b.show(),this.get("input").attr("aria-owns",b.get("el").attr("id")))}},destructor:function(){var a=this.__repositionBuffer;a&&(u.detach("resize",a,this),a.stop())}},{ATTRS:{input:{view:1},inputValue:{value:"",view:1},trigger:{view:1},placeholder:{view:1},placeholderEl:{view:1},validator:{},invalidEl:{view:1},allowTextSelection:{value:!0},hasTrigger:{view:1},
menu:{value:{},setter:function(a){a&&a.isController&&a.setInternal("parent",this)}},defaultChildCfg:{value:{xclass:"popupmenu"}},collapsed:{view:1,sync:0},dataSource:{},maxItemCount:{value:99999},matchElWidth:{value:!0},format:{},updateInputOnDownUp:{value:!0},autoHighlightFirst:{},xrender:{value:k}}},{xclass:"combobox",priority:10})},{requires:["node","component/base","./render","menu"]});KISSY.add("combobox/combobox-tpl",function(){return'<div id="ks-combobox-invalid-el{{id}}"      class="{{prefixCls}}combobox-invalid-el">     <div class="{{prefixCls}}combobox-invalid-inner"></div> </div>  {{#if hasTrigger}} <div id="ks-combobox-trigger{{id}}"      class="{{prefixCls}}combobox-trigger">     <div class="{{prefixCls}}combobox-trigger-inner">&#x25BC;</div> </div> {{/if}}  <div class="{{prefixCls}}combobox-input-wrap">      <input id="ks-combobox-input{{id}}"            aria-haspopup="true"            aria-autocomplete="list"            aria-haspopup="true"            role="autocomplete"            aria-expanded="false"      {{#if disabled}}     disabled     {{/if}}      autocomplete="off"     class="{{prefixCls}}combobox-input"      value="{{inputValue}}"     />       <label id="ks-combobox-placeholder{{id}}"            for="ks-combobox-input{{id}}"             style=\'display:{{#if inputValue}}none{{else}}block{{/if}};\'     class="{{prefixCls}}combobox-placeholder">     {{placeholder}}     </label> </div>'});
KISSY.add("combobox",function(h,c,j,k,f,i){c.LocalDataSource=f;c.RemoteDataSource=i;c.FilterSelect=k;c.MultiValueComboBox=j;return c},{requires:["combobox/base","combobox/multi-value-combobox","combobox/filter-select","combobox/LocalDataSource","combobox/RemoteDataSource"]});
KISSY.add("combobox/cursor",function(h,c){function j(b){var a=f,e;a||(a=c.create(k));"textarea"==""+b.type?c.css(a,"width",c.css(b,"width")):c.css(a,"width",9999);h.each(i,function(e){c.css(a,e,c.css(b,e))});f||(e=b.ownerDocument.body,e.insertBefore(a,e.firstChild));return f=a}var k="<div style='z-index:-9999;overflow:hidden;position: fixed;left:-9999px;top:-9999px;opacity:0;white-space:pre-wrap;word-wrap:break-word;'></div>",f,i="paddingLeft,paddingTop,paddingBottom,paddingRight,marginLeft,marginTop,marginBottom,marginRight,borderLeftStyle,borderTopStyle,borderBottomStyle,borderRightStyle,borderLeftWidth,borderTopWidth,borderBottomWidth,borderRightWidth,line-height,outline,height,fontFamily,fontSize,fontWeight,fontVariant,fontStyle".split(",");
return function(b){var b=c.get(b),a=b.ownerDocument,e,f,g=b.scrollTop,p=b.scrollLeft;if(a.selection)return a=a.selection.createRange(),{left:a.boundingLeft+p+c.scrollLeft(),top:a.boundingTop+g+a.boundingHeight+c.scrollTop()};e=c.offset(b);if("textarea"!=b.type)return e.top+=b.offsetHeight,e;f=j(b);a=b.selectionStart;f.innerHTML=h.escapeHTML(b.value.substring(0,a-1))+"<span>x</span>";c.offset(f,e);e=f.lastChild;b=c.offset(e);b.top+=c.height(e);0<a&&(b.left+=c.width(e));b.top-=g;b.left-=p;return b}},
{requires:["dom"]});KISSY.add("combobox/filter-select",function(h,c){var j=c.extend({validate:function(c){var f=this;j.superclass.validate.call(f,function(i,b){i?c(i,b):f.get("dataSource").fetchData(b,function(a){a:{if(a=f.normalizeData(a))for(var e=0;e<a.length;e++)if(a[e].textContent==b){a=a[e];break a}a=!1}c(a?"":f.get("invalidMessage"),b,a)})})}},{ATTRS:{invalidMessage:{value:"invalid input"}}});return j},{requires:["./base"]});
KISSY.add("combobox/LocalDataSource",function(h){function c(){c.superclass.constructor.apply(this,arguments)}c.ATTRS={data:{value:[]},parse:{value:function(c,k){var f=[],i=0;if(!c)return k;h.each(k,function(b){-1!=b.indexOf(c)&&f.push(b);i++});return f}}};h.extend(c,h.Base,{fetchData:function(c,k,f){var i=this.get("parse"),b=this.get("data"),b=i(c,b);k.call(f,b)}});return c},{requires:["component/base"]});
KISSY.add("combobox/multi-value-combobox",function(h,c,j){function k(a,b){return b&&-1!=a.indexOf(b)}function f(a){var e=a.get("input"),f=e.val(),g=[],c=[],h=a.get("literal"),j=a.get("separator"),a=a.get("separatorType"),m=!1,s=a!=i,e=e.prop("selectionStart"),n,l,r=-1;for(n=0;n<f.length;n++)(l=f.charAt(n),h&&l==h&&(m=!m),m)?c.push(l):(n==e&&(r=g.length),s&&b.test(l))?(c.length&&g.push(c.join("")),c=[],c.push(l)):k(j,l)?a==i?(c.push(l),c.length&&g.push(c.join("")),c=[]):(c.length&&g.push(c.join("")),
c=[],c.push(l)):c.push(l);c.length&&g.push(c.join(""));g.length||g.push("");-1==r&&(a==i&&k(j,l)&&g.push(""),r=g.length-1);return{tokens:g,cursorPosition:e,tokenIndex:r}}var i="suffix",b=/\s|\xa0/;return j.extend({getValueInternal:function(){this.get("input");var a=f(this),b=a.tokens,c=a.tokenIndex,a=this.get("separator"),g=this.get("separatorType"),b=b[c],c=b.length-1;if(g!=i)if(k(a,b.charAt(0)))b=b.slice(1);else return;else g==i&&k(a,b.charAt(c))&&(b=b.slice(0,c));return b},setValueInternal:function(a){var e=
this.get("input"),c=f(this),g=c.tokens,c=Math.max(0,c.tokenIndex),h=this.get("separator"),j=this.get("separatorType"),q=g[c+1]||"",m=g[c];if(j!=i){if(g[c]=m.charAt(0)+a,!q||!b.test(q.charAt(0)))g[c]+=" "}else g[c]=a,a=m.length-1,k(h,m.charAt(a))?g[c]+=m.charAt(a):1==h.length&&(g[c]+=h);a=g.slice(0,c+1).join("").length;e.val(g.join(""));e.prop("selectionStart",a);e.prop("selectionEnd",a)},alignInternal:function(){if(this.get("alignWithCursor")){var a=f(this),b=a.tokens,h=this.get("menu"),g=a.cursorPosition,
i=a.tokenIndex,a=this.get("input"),b=b.slice(0,i).join("").length;0<b&&++b;a.prop("selectionStart",b);a.prop("selectionEnd",b);b=c(a);a.prop("selectionStart",g);a.prop("selectionEnd",g);h.set("xy",[b.left,b.top])}else j.prototype.alignInternal.apply(this,arguments)}},{ATTRS:{separator:{value:",;"},separatorType:{value:i},literal:{value:'"'},alignWithCursor:{}}},{xclass:"multi-value-combobox",priority:20})},{requires:["./cursor","./base"]});
KISSY.add("combobox/RemoteDataSource",function(h,c){function j(){j.superclass.constructor.apply(this,arguments);this.io=null;this.caches={}}j.ATTRS={paramName:{value:"q"},allowEmpty:{},cache:{},parse:{},xhrCfg:{value:{}}};h.extend(j,h.Base,{fetchData:function(h,f,i){var b=this,a,e=b.get("paramName"),j=b.get("parse"),g=b.get("cache"),p=b.get("allowEmpty");b.io&&(b.io.abort(),b.io=null);if(!h&&!0!==p)return f.call(i,[]);if(g&&(a=b.caches[h]))return f.call(i,a);a=b.get("xhrCfg");a.data=a.data||{};a.data[e]=
h;a.success=function(a){j&&(a=j(h,a));b.setInternal("data",a);g&&(b.caches[h]=a);f.call(i,a)};b.io=c(a)}});return j},{requires:["io"]});
KISSY.add("combobox/render",function(h,c,j){var k=c.Render.extend({initializer:function(){var c=this.get("childrenElSelectors");h.mix(c,{input:"#ks-combobox-input{id}",trigger:"#ks-combobox-trigger{id}",invalidEl:"#ks-combobox-invalid-el{id}",placeholderEl:"#ks-combobox-placeholder{id}"})},getKeyEventTarget:function(){return this.get("input")},_onSetCollapsed:function(c){this.get("input").attr("aria-expanded",!c)},_onSetDisabled:function(c){k.superclass._onSetDisabled.apply(this,arguments);this.get("input").attr("disabled",
c)}},{ATTRS:{collapsed:{value:!0,sync:0},hasTrigger:{value:!0,sync:0},input:{},disabled:{sync:0},trigger:{},placeholder:{},placeholderEl:{},invalidEl:{},contentTpl:{value:j}},HTML_PARSER:{input:function(c){return c.one("."+this.get("prefixCls")+"combobox-input")},trigger:function(c){return c.one("."+this.get("prefixCls")+"combobox-trigger")},invalidEl:function(c){return c.one("."+this.get("prefixCls")+"combobox-invalid-el")},placeholderEl:function(c){return c.one("."+this.get("prefixCls")+"combobox-invalid-el")}}});
return k},{requires:["component/base","./combobox-tpl"]});
