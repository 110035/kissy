/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jun 3 15:52
*/
KISSY.add("dd/base/ddm",function(f,i,c,g,u){function p(){p.superclass.constructor.apply(this,arguments)}function s(b){var a;if(b=k._normalEvent(b))if(b.preventDefault(),a=this.__activeToDrag)a._move(b);else if(a=this.get("activeDrag"))a._move(b),this.__needDropCheck&&h(this,b,a)}function q(b){b.preventDefault();E.call(this,b)}function h(b,x,e){var d=b.get("validDrops"),h=e.get("mode"),c=0,g=0,w=l(e.get("node")),j=r(w);f.each(d,function(b){var d;if(d=b.getNodeFromTarget(x,e.get("dragNode")[0],e.get("node")[0]))if("point"==
h)y(l(d),e.mousePos)&&(d=r(l(d)),c?d<g&&(c=b,g=d):(c=b,g=d));else if("intersect"==h)d=r(a(w,l(d))),d>g&&(g=d,c=b);else if("strict"==h&&(d=r(a(w,l(d))),d==j))return c=b,!1});if((d=b.get("activeDrop"))&&d!=c)d._handleOut(x),e._handleOut(x);b.setInternal("activeDrop",c);c&&(d!=c?c._handleEnter(x):c._handleOver(x))}function j(b){b._shim=(new g('<div style="background-color:red;position:'+(A?"absolute":"fixed")+";left:0;width:100%;height:100%;top:0;cursor:"+k.get("dragCursor")+";z-index:"+F+';"></div>')).prependTo(m.body||
m.documentElement).css("opacity",0);j=v;if(A)c.on(w,"resize scroll",B,b);v(b)}function v(b){var a=b.get("activeDrag").get("activeHandler"),d="auto";a&&(d=a.css("cursor"));"auto"==d&&(d=b.get("dragCursor"));b._shim.css({cursor:d,display:"block"});A&&B.call(b)}function o(b){var a=b.get("drops");b.setInternal("validDrops",[]);a.length&&f.each(a,function(b){b._active()})}function t(b){var a=b.get("drops");b.setInternal("validDrops",[]);a.length&&f.each(a,function(b){b._deActive()})}function l(b){var a=
b.offset();return{left:a.left,right:a.left+(b.__dd_cached_width||b.outerWidth()),top:a.top,bottom:a.top+(b.__dd_cached_height||b.outerHeight())}}function y(b,a){return b.left<=a.left&&b.right>=a.left&&b.top<=a.top&&b.bottom>=a.top}function r(b){return b.top>=b.bottom||b.left>=b.right?0:(b.right-b.left)*(b.bottom-b.top)}function a(b,a){var d=Math.max(b.top,a.top),e=Math.min(b.right,a.right),c=Math.min(b.bottom,a.bottom);return{left:Math.max(b.left,a.left),right:e,top:d,bottom:c}}function e(b){b&&(b.__dd_cached_width=
b.outerWidth(),b.__dd_cached_height=b.outerHeight())}var d=f.UA,C=f.Features,w=f.Env.host,m=w.document,A=6===d.ie,F=999999,n=c.Gesture,D=n.move,z=n.end;n.cancel&&(z+=" "+n.cancel);p.ATTRS={dragCursor:{value:"move"},clickPixelThresh:{value:3},bufferTime:{value:1},activeDrag:{},activeDrop:{},drops:{value:[]},validDrops:{value:[]}};var E=d.ie&&8>d.ie?f.throttle(s,30):s,B=f.throttle(function(){var b;(b=this.get("activeDrag"))&&b.get("shim")&&this._shim.css({width:i.docWidth(),height:i.docHeight()})},
30);f.extend(p,u,{__activeToDrag:0,_regDrop:function(b){this.get("drops").push(b)},_unRegDrop:function(b){var a=this.get("drops"),b=f.indexOf(b,a);-1!=b&&a.splice(b,1)},_regToDrag:function(b){this.__activeToDrag=b;c.on(m,z,this._end,this);if(n.cancel)c.on(m,n.cancel,this._end,this);c.on(m,D,q,this);6===d.ie&&m.body.setCapture()},_start:function(){this.get("drops");var b=this.__activeToDrag;this.setInternal("activeDrag",b);this.__activeToDrag=0;b.get("shim")&&j(this);this.__needDropCheck=0;b.get("groups")&&
(o(this),this.get("validDrops").length&&(e(b.get("node")),this.__needDropCheck=1))},_addValidDrop:function(b){this.get("validDrops").push(b)},_end:function(b){var a=this.__activeToDrag,e=this.get("activeDrag"),h=this.get("activeDrop"),b=k._normalEvent(b);a&&a._move(b);e&&e._move(b);c.remove(m,D,q,this);c.remove(m,z,this._end,this);n.cancel&&c.remove(m,n.cancel,this._end,this);6===d.ie&&m.body.releaseCapture();a&&(a._end(b),this.__activeToDrag=0);this._shim&&this._shim.hide();e&&(e._end(b),t(this),
h&&h._end(b),this.setInternal("activeDrag",null),this.setInternal("activeDrop",null))}});var k=new p;k.inRegion=y;k.region=l;k.area=r;k.cacheWH=e;k.PREFIX_CLS="ks-dd-";k._normalEvent=function(b){var a=""+b.type,a=(a=a==n.end||a==n.cancel?b.changedTouches:b.touches)||[];if((C.isTouchEventSupported()||C.isMsPointerSupported())&&a.length){if(1!=a.length)return;a=a[0];b.target=b.target||a.target;b.currentTarget=b.currentTarget||a.currentTarget;b.pageX=a.pageX;b.pageY=a.pageY}b.which=1;return b};return k},
{requires:["dom","event","node","base"]});
KISSY.add("dd/base/draggable",function(f,i,c,g,u){function p(){return!1}var s=f.UA,q=i.all,h=f.Features,h=h.isTouchEventSupported()||h.isMsPointerSupported(),j=f.each,v=h?"singleTouchStart":u.Gesture.start,o=s.ie,t=g.PREFIX_CLS,l=f.Env.host.document,c=c.extend({initializer:function(){this.addTarget(g);this._allowMove=this.get("move")},_onSetNode:function(a){this.setInternal("dragNode",a);this.bindDragEvent()},bindDragEvent:function(){this.get("node").on(v,r,this).on("dragstart",this._fixDragStart)},
detachDragEvent:function(){this.get("node").detach(v,r,this).detach("dragstart",this._fixDragStart)},_bufferTimer:null,_onSetDisabledChange:function(a){this.get("dragNode")[a?"addClass":"removeClass"](t+"-disabled")},_fixDragStart:function(a){a.preventDefault()},_checkHandler:function(a){var e=this,d=e.get("handlers"),c=0;j(d,function(d){if(d[0]==a||d.contains(a))return c=1,e.setInternal("activeHandler",d),!1});return c},_checkDragStartValid:function(a){return this.get("primaryButtonOnly")&&1!=a.which||
this.get("disabled")?0:1},_prepare:function(a){if(a){var e=this;o&&(y=l.body.onselectstart,l.body.onselectstart=p);e.get("halt")&&a.stopPropagation();a.preventDefault();var d=a.pageX,c=a.pageY;e.setInternal("startMousePos",e.mousePos={left:d,top:c});if(e._allowMove){var h=e.get("node").offset();e.setInternal("startNodePos",h);e.setInternal("deltaPos",{left:d-h.left,top:c-h.top})}g._regToDrag(e);if(d=e.get("bufferTime"))e._bufferTimer=setTimeout(function(){e._start(a)},1E3*d)}},_clearBufferTimer:function(){this._bufferTimer&&
(clearTimeout(this._bufferTimer),this._bufferTimer=0)},_move:function(a){var e=a.pageX,d=a.pageY;if(!this.get("dragging")){var c=this.get("startMousePos"),h=0,f=this.get("clickPixelThresh");if(Math.abs(e-c.left)>=f||Math.abs(d-c.top)>=f)this._start(a),h=1;if(!h)return}this.mousePos={left:e,top:d};a={pageX:e,pageY:d,drag:this};if(c=this._allowMove)h=this.get("deltaPos"),e-=h.left,d-=h.top,a.left=e,a.top=d,this.setInternal("actualPos",{left:e,top:d}),this.fire("dragalign",a);d=1;!1===this.fire("drag",
a)&&(d=0);d&&c&&this.get("node").offset(this.get("actualPos"))},stopDrag:function(){g._end()},_end:function(a){var a=a||{},e;this._clearBufferTimer();o&&(l.body.onselectstart=y);this.get("dragging")&&(this.get("node").removeClass(t+"drag-over"),(e=g.get("activeDrop"))?this.fire("dragdrophit",{drag:this,drop:e}):this.fire("dragdropmiss",{drag:this}),this.setInternal("dragging",0),this.fire("dragend",{drag:this,pageX:a.pageX,pageY:a.pageY}))},_handleOut:function(){this.get("node").removeClass(t+"drag-over");
this.fire("dragexit",{drag:this,drop:g.get("activeDrop")})},_handleEnter:function(a){this.get("node").addClass(t+"drag-over");this.fire("dragenter",a)},_handleOver:function(a){this.fire("dragover",a)},_start:function(a){this._clearBufferTimer();this.setInternal("dragging",1);this.setInternal("dragStartMousePos",{left:a.pageX,top:a.pageY});g._start();this.fire("dragstart",{drag:this,pageX:a.pageX,pageY:a.pageY})},destructor:function(){this.detachDragEvent();this.detach()}},{name:"Draggable",DRAG_START_EVENT:v,
ATTRS:{node:{setter:function(a){if(!(a instanceof i))return q(a)}},clickPixelThresh:{valueFn:function(){return g.get("clickPixelThresh")}},bufferTime:{valueFn:function(){return g.get("bufferTime")}},dragNode:{},shim:{value:!h},handlers:{value:[],getter:function(a){var e=this;a.length||(a[0]=e.get("node"));j(a,function(d,c){f.isFunction(d)&&(d=d.call(e));"string"==typeof d&&(d=e.get("node").one(d));d.nodeType&&(d=q(d));a[c]=d});e.setInternal("handlers",a);return a}},activeHandler:{},dragging:{value:!1,
setter:function(a){this.get("dragNode")[a?"addClass":"removeClass"](t+"dragging")}},mode:{value:"point"},disabled:{value:!1},move:{value:!1},primaryButtonOnly:{value:!0},halt:{value:!0},groups:{value:!0},startMousePos:{},dragStartMousePos:{},startNodePos:{},deltaPos:{},actualPos:{}}});c.DropMode={POINT:"point",INTERSECT:"intersect",STRICT:"strict"};f.mix(c,c.DropMode);var y,r=function(a){if(a=g._normalEvent(a)){var e=a.target;this._checkDragStartValid(a)&&this._checkHandler(e)&&this._prepare(a)}};
return c},{requires:["node","rich-base","./ddm","event"]});
KISSY.add("dd/base/draggable-delegate",function(f,i,c,g,u){var p=i.PREFIX_CLS,s=c.DRAG_START_EVENT,q=function(c){if(c=i._normalEvent(c)){var f,g;if(this._checkDragStartValid(c)){f=this.get("handlers");var o=new u(c.target);(f=f.length?this._getHandler(o):o)&&(g=this._getNode(f));g&&(this.setInternal("activeHandler",f),this.setInternal("node",g),this.setInternal("dragNode",g),this._prepare(c))}}};return c.extend({_onSetNode:function(){},_onSetContainer:function(){this.bindDragEvent()},_onSetDisabledChange:function(c){this.get("container")[c?
"addClass":"removeClass"](p+"-disabled")},bindDragEvent:function(){this.get("container").on(s,q,this).on("dragstart",this._fixDragStart)},detachDragEvent:function(){this.get("container").detach(s,q,this).detach("dragstart",this._fixDragStart)},_getHandler:function(c){for(var j=void 0,i=this.get("container"),o=this.get("handlers");c&&c[0]!==i[0];){f.each(o,function(f){if(g.test(c[0],f))return j=c,!1});if(j)break;c=c.parent()}return j},_getNode:function(c){return c.closest(this.get("selector"),this.get("container"))}},
{ATTRS:{container:{setter:function(c){return u.one(c)}},selector:{},handlers:{value:[],getter:0}}})},{requires:["./ddm","./draggable","dom","node","event"]});KISSY.add("dd/base",function(f,i,c,g){f={Draggable:c,DDM:i,DraggableDelegate:g};return KISSY.DD=f},{requires:["./base/ddm","./base/draggable","./base/draggable-delegate"]});
