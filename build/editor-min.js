/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: Jun 17 23:57
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/base",function(a,n,r){a=r.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:n.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(a){var n=this._getData();return void 0===n?a:n}},formatData:{getter:function(){return this._getData(1)}},customStyle:{value:""},customLink:{value:[]}}},{xclass:"editor"});a.HTML_PARSER=
{textarea:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea")},data:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea").val()}};return KISSY.Editor=a},{requires:["htmlparser","component/base"]});
KISSY.add("editor/utils",function(a){var n=a.Node,r=a.DOM,u=a.UA,t={debugUrl:function(m){var f=a.Config;f.debug||(m=m.replace(/\.(js|css)/i,"-min.$1"));-1==m.indexOf("?t")&&(m=-1!=m.indexOf("?")?m+"&":m+"?",m+="t="+encodeURIComponent(f.tag));return f.base+"editor/"+m},lazyRun:function(a,f,j){var o=a[f],p=a[j];a[f]=function(){o.apply(this,arguments);a[f]=a[j];return p.apply(this,arguments)}},getXY:function(a,f){var j=a.left,o=a.top,p=f.get("window")[0],j=j-r.scrollLeft(p),o=o-r.scrollTop(p),p=f.get("iframe").offset(),
j=j+p.left,o=o+p.top;return{left:j,top:o}},tryThese:function(a){for(var f,j=0,o=arguments.length;j<o;j++){var p=arguments[j];try{f=p();break}catch(x){}}return f},arrayCompare:function(a,f){if(!a&&!f)return!0;if(!a||!f||a.length!=f.length)return!1;for(var j=0;j<a.length;j++)if(a[j]!==f[j])return!1;return!0},clearAllMarkers:function(a){for(var f in a)a[f]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,"")},isNumber:function(m){return/^\d+(.\d+)?$/.test(a.trim(m))},
verifyInputs:function(m){for(var f=0;f<m.length;f++){var j=new n(m[f]),o=a.trim(t.valInput(j)),p=j.attr("data-verify"),j=j.attr("data-warning");if(p&&!RegExp(p).test(o))return alert(j),!1}return!0},sourceDisable:function(a,f){a.on("sourceMode",f.disable,f);a.on("wysiwygMode",f.enable,f)},resetInput:function(a){var f=a.attr("placeholder");f&&u.ie?(a.addClass("ks-editor-input-tip"),a.val(f)):u.ie||a.val("")},valInput:function(a,f){if(void 0===f)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");
a.val(f)},placeholder:function(m,f){m.attr("placeholder",f);u.ie&&(m.on("blur",function(){a.trim(m.val())||(m.addClass("ks-editor-input-tip"),m.val(f))}),m.on("focus",function(){m.removeClass("ks-editor-input-tip");a.trim(m.val())==f&&m.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(m){var m=a.clone(m),f;for(f in m){var j=m[f];a.isFunction(j)&&(m[f]=j())}return m},map:function(a,f){for(var j=
0;j<a.length;j++)a[j]=f(a[j]);return a},ieEngine:document.documentMode||u.ie,preventFocus:function(a){u.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(m){a.mix(r,m);for(var f in m)(function(f){n.prototype[f]=function(){var o=[].slice.call(arguments,0);o.unshift(this[0]);return(o=m[f].apply(null,o))&&(o.nodeType||a.isWindow(o))?new n(o):a.isArray(o)&&(o.__IS_NODELIST||o[0]&&o[0].nodeType)?new n(o):o}})(f)},addRes:function(){var m=this.__res=this.__res||[];m.push.apply(m,
a.makeArray(arguments))},destroyRes:function(){for(var m=this.__res||[],f=0;f<m.length;f++){var j=m[f];a.isFunction(j)?j():j.destroy?j.destroy():j.remove&&j.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,j){return j.toUpperCase()})+"Value"}};return a.Editor.Utils=t},{requires:["./base","node"]});
KISSY.add("editor/dom",function(a,n,r){function u(a,e){var c=a[e?"next":"prev"](t,1);if(c&&c[0].nodeType==j.ELEMENT_NODE){for(var b=[];c.attr("_ke_bookmark")||c._4e_isEmptyInlineRemovable(t);)if(b.push(c),c=e?c.next(t,1):c.prev(t,1),!c)return;if(a._4e_isIdentical(c,t)){for(var h=new p(e?a[0].lastChild:a[0].firstChild);b.length;)b.shift()._4e_move(a,!e,t);c._4e_moveChildren(a,!e,t);c.remove();h[0]&&h[0].nodeType==j.ELEMENT_NODE&&h._4e_mergeSiblings()}}}var t=t,m=n.XHTML_DTD,f=a.DOM,j=f.NodeType,o=
a.UA,p=a.Node,x={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};n.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var k=n.POSITION,y={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},w={hr:1},c=function(a){return a&&(a[0]||a)};r.injectDom({_4e_sameLevel:function(a,e){var e=c(e),s=a.parentNode;return s&&s==e.parentNode},_4e_isBlockBoundary:function(l,e){var c=a.merge(w,e);return!(!y[f.css(l,"display")]&&!c[f.nodeName(l)])},_4e_index:function(a,e){for(var c=a.parentNode.childNodes,b,h=-1,d=0;d<c.length;d++)if(b=c[d],!e||!(3==b.nodeType&&b.previousSibling&&3==b.previousSibling.nodeType))if(h++,b===a)return h;return-1},_4e_move:function(a,
e,s){e=c(e);s?e.insertBefore(a,e.firstChild):e.appendChild(a)},_4e_isIdentical:function(a,e){if(!e)return!1;e=c(e);if(f.nodeName(a)!=f.nodeName(e))return!1;var s=a.attributes,b=e.attributes,h=s.length,d=b.length;if(h!=d)return!1;for(var g=0;g<h;g++){var i=s[g],v=i.name;if(i.specified&&f.attr(a,v)!=f.attr(e,v))return!1}if(8>r.ieEngine)for(g=0;g<d;g++)if(i=b[g],v=i.name,i.specified&&f.attr(a,v)!=f.attr(e,v))return!1;return!0},_4e_isEmptyInlineRemovable:function(l){if(!m.$removeEmpty[f.nodeName(l)])return!1;
for(var l=l.childNodes,e=0,c=l.length;e<c;e++){var b=l[e],h=b.nodeType;if(!(h==j.ELEMENT_NODE&&b.getAttribute("_ke_bookmark"))&&(h==j.ELEMENT_NODE&&!f._4e_isEmptyInlineRemovable(b)||h==f.NodeType.TEXT_NODE&&a.trim(b.nodeValue)))return!1}return!0},_4e_moveChildren:function(a,e,s){e=c(e);if(a!=e)if(s)for(;s=a.lastChild;)e.insertBefore(a.removeChild(s),e.firstChild);else for(;s=a.firstChild;)e.appendChild(a.removeChild(s))},_4e_mergeSiblings:function(a){a=new p(a);x[a.nodeName()]&&(u(a,!0),u(a))},_4e_splitText:function(a,
e){var c=a.ownerDocument;if(a.nodeType==f.NodeType.TEXT_NODE){if(o.ie&&e==a.nodeValue.length){var b=c.createTextNode("");f.insertAfter(b,a);return b}b=a.splitText(e);c.documentMode&&(c=c.createTextNode(""),f.insertAfter(c,b),f.remove(c));return b}},_4e_parents:function(a,e){var c=[];c.__IS_NODELIST=1;do c[e?"push":"unshift"](a);while(a=a.parentNode);return c},_4e_nextSourceNode:function(a,e,s,b){if(b&&!b.call)var h=c(b),b=function(a){return a!==h};var e=!e&&a.firstChild,d=a;if(!e){if(a.nodeType==
j.ELEMENT_NODE&&b&&!1===b(a,!0))return null;e=a.nextSibling}for(;!e&&(d=d.parentNode);){if(b&&!1===b(d,!0))return null;e=d.nextSibling}return!e||b&&!1===b(e)?null:s&&s!=e.nodeType?f._4e_nextSourceNode(e,!1,s,b):e},_4e_previousSourceNode:function(a,e,s,b){if(b&&!b.call)var h=c(b),b=function(a){return a!==h};var e=!e&&a.lastChild,d=a;if(!e){if(a.nodeType==j.ELEMENT_NODE&&b&&!1===b(a,!0))return null;e=a.previousSibling}for(;!e&&(d=d.parentNode);){if(b&&!1===b(d,!0))return null;e=d.previousSibling}return!e||
b&&!1===b(e)?null:s&&e.nodeType!=s?f._4e_previousSourceNode(e,!1,s,b):e},_4e_commonAncestor:function(a,e){e=c(e);if(a===e)return a;if(f.contains(e,a))return e;var s=a;do if(f.contains(s,e))return s;while(s=s.parentNode);return null},_4e_hasAttributes:9>r.ieEngine?function(a){for(var e=a.attributes,c=0;c<e.length;c++){var b=e[c];switch(b.name){case "class":if(a.getAttribute("class"))return!0;break;default:if(b.specified)return!0}}return!1}:function(a){o.gecko&&a.removeAttribute("_moz_dirty");return a.hasAttributes()},
_4e_position:function(a,e){var s=c(e);if(a.compareDocumentPosition)return a.compareDocumentPosition(s);if(a==s)return k.POSITION_IDENTICAL;if(a.nodeType==j.ELEMENT_NODE&&s.nodeType==j.ELEMENT_NODE){if(f.contains(a,s))return k.POSITION_CONTAINS+k.POSITION_PRECEDING;if(f.contains(s,a))return k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING;if("sourceIndex"in a)return 0>a.sourceIndex||0>s.sourceIndex?k.POSITION_DISCONNECTED:a.sourceIndex<s.sourceIndex?k.POSITION_PRECEDING:k.POSITION_FOLLOWING}for(var b=
f._4e_address(a),s=f._4e_address(s),h=Math.min(b.length,s.length),d=0;d<=h-1;d++)if(b[d]!=s[d])return b[d]<s[d]?k.POSITION_PRECEDING:k.POSITION_FOLLOWING;return b.length<s.length?k.POSITION_CONTAINS+k.POSITION_PRECEDING:k.POSITION_IS_CONTAINED+k.POSITION_FOLLOWING},_4e_address:function(a,e){for(var c=[],b=a.ownerDocument.documentElement,h=a;h&&h!=b;)c.unshift(f._4e_index(h,e)),h=h.parentNode;return c},_4e_remove:function(a,e){var c=a.parentNode;if(c){if(e)for(var b;b=a.firstChild;)c.insertBefore(a.removeChild(b),
a);c.removeChild(a)}return a},_4e_trim:function(a){f._4e_ltrim(a);f._4e_rtrim(a)},_4e_ltrim:function(a){for(var e;e=a.firstChild;){if(e.nodeType==f.NodeType.TEXT_NODE){var c=r.ltrim(e.nodeValue),b=e.nodeValue.length;if(c)c.length<b&&(f._4e_splitText(e,b-c.length),a.removeChild(a.firstChild));else{a.removeChild(e);continue}}break}},_4e_rtrim:function(a){for(var e;e=a.lastChild;){if(e.type==f.NodeType.TEXT_NODE){var c=r.rtrim(e.nodeValue),b=e.nodeValue.length;if(c)c.length<b&&(f._4e_splitText(e,c.length),
a.removeChild(a.lastChild));else{a.removeChild(e);continue}}break}!o.ie&&!o.opera&&(e=a.lastChild)&&1==e.nodeType&&"br"==f.nodeName(e)&&a.removeChild(e)},_4e_appendBogus:function(c){for(var e=c.lastChild;e&&e.nodeType==f.NodeType.TEXT_NODE&&!a.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType==f.NodeType.TEXT_NODE||"br"!==f.nodeName(e))e=o.opera?c.ownerDocument.createTextNode(""):c.ownerDocument.createElement("br"),c.appendChild(e)},_4e_setMarker:function(c,e,f,b){var c=new p(c),h=c.data("list_marker_id")||
c.data("list_marker_id",a.guid()).data("list_marker_id"),d=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");e[h]=c;d[f]=1;return c.data(f,b)},_4e_clearMarkers:function(a,e,c){var a=new p(a),b=a.data("list_marker_names"),h=a.data("list_marker_id"),d;for(d in b)a.removeData(d);a.removeData("list_marker_names");c&&(a.removeData("list_marker_id"),delete e[h])},_4e_copyAttributes:function(a,e,c){for(var e=new p(e),b=a.attributes,c=c||{},h=0;h<b.length;h++){var d=b[h],
g=d.name.toLowerCase(),i;if(!(g in c))if("checked"==g&&(i=f.attr(a,g)))e.attr(g,i);else if(d.specified||o.ie&&d.value&&"value"==g)i=f.attr(a,g),null===i&&(i=d.nodeValue),e.attr(g,i)}""!==a.style.cssText&&(e[0].style.cssText=a.style.cssText)},_4e_isEditable:function(a){a=f.nodeName(a);return(a=!m.$nonEditable[a]&&(m[a]||m.span))&&a["#text"]},_4e_getByAddress:function(a,e,c){for(var a=a.documentElement,b=0;a&&b<e.length;b++){var h=e[b];if(c)for(var d=-1,g=0;g<a.childNodes.length;g++){var i=a.childNodes[g];
if(!(!0===c&&3==i.nodeType&&i.previousSibling&&3==i.previousSibling.nodeType)&&(d++,d==h)){a=i;break}}else a=a.childNodes[h]}return a}})},{requires:["./base","./utils","node"]});
KISSY.add("editor/focusManager",function(a){function n(){var a=this;a.__iframeFocus=j;m=a;t&&clearTimeout(t);t=setTimeout(function(){a.fire("focus")},30)}function r(){var a=this;a.__iframeFocus=o;m=p;t&&clearTimeout(t);t=setTimeout(function(){a.fire("blur")},30)}var a=a.Editor,u={},t,m,f={refreshAll:function(){for(var a in u){var f=u[a].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return m},getInstance:function(a){return u[a]},add:function(a){a.get("window").on("focus",
n,a).on("blur",r,a)},register:function(a){u[a._UUID]=a},remove:function(a){delete u[a._UUID];a.get("window").detach("focus",n,a).detach("blur",r,a)}},j=!0,o=!1,p=null;f.refreshAll=f.refreshAll;a.focusManager=f;a.getInstances=function(){return u};return f},{requires:["./base","./dom"]});
KISSY.add("editor/walker",function(a,n){function r(a,c){if(this._.end)return j;var b,h=this.range,d,g=this.guard,i=this.type,l=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,h.trim(),h.collapsed))return this.end(),j;if(!a&&!this._.guardLTR){var o=h.endContainer[0],n=o.childNodes[h.endOffset];this._.guardLTR=function(a,b){return b&&(o==a||"body"==p.nodeName(a))?!1:a!=n}}if(a&&!this._.guardRTL){var r=h.startContainer[0],I=0<h.startOffset&&r.childNodes[h.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(r==a||"body"==p.nodeName(a))?!1:a!=I}}var K=a?this._.guardRTL:this._.guardLTR;d=g?function(a,b){return K(a,b)===f?f:g(a,b)}:K;this.current?b=this.current[l](f,i,d):a?(b=h.endContainer,0<h.endOffset?(b=new k(b[0].childNodes[h.endOffset-1]),d(b[0])===f&&(b=j)):b=d(b,m)===f?j:b._4e_previousSourceNode(m,i,d,void 0)):(b=h.startContainer,b=new k(b[0].childNodes[h.startOffset]),b.length?d(b[0])===f&&(b=j):b=d(h.startContainer,m)===f?j:h.startContainer._4e_nextSourceNode(m,
i,d,void 0));for(;b&&!this._.end;){this.current=b;if(!this.evaluator||this.evaluator(b[0])!==f){if(!c)return b}else if(c&&this.evaluator)return f;b=b[l](f,i,d)}this.end();return this.current=j}function u(a){for(var c,b=j;c=r.call(this,a);)b=c;return b}function t(a){this.range=a;this.guard=this.evaluator=j;this._={}}var m=!0,f=!1,j=null,o=a.UA,p=a.DOM,x=n.XHTML_DTD,k=a.Node;a.augment(t,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,m)},checkForward:function(){return r.call(this,
f,m)!==f},checkBackward:function(){return r.call(this,m,m)!==f},lastForward:function(){return u.call(this)},lastBackward:function(){return u.call(this,m)},reset:function(){delete this.current;this._={}},_iterator:r});a.mix(t,{blockBoundary:function(a){return function(c){return!(c.nodeType==p.NodeType.ELEMENT_NODE&&p._4e_isBlockBoundary(c,a))}},bookmark:function(a,c){function b(a){return"span"==p.nodeName(a)&&p.attr(a,"_ke_bookmark")}return function(h){var d,g;d=h.nodeType==p.NodeType.TEXT_NODE&&(g=
h.parentNode)&&b(g);d=a?d:d||b(h);return!!(c^d)}},whitespaces:function(c){return function(f){f=f.nodeType==p.NodeType.TEXT_NODE&&!a.trim(f.nodeValue);return!!(c^f)}},invisible:function(a){var c=t.whitespaces();return function(b){b=c(b)||b.nodeType==p.NodeType.ELEMENT_NODE&&!b.offsetHeight;return!!(a^b)}}});var y=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,w=t.whitespaces(),c=t.bookmark(),l=function(a){var f=p.nodeName(a);return c(a)||w(a)||1==a.nodeType&&f in x.$inline&&!(f in x.$empty)};n.Utils.injectDom({_4e_getBogus:function(a){a=
new k(a);do a=a._4e_previousSourceNode();while(a&&l(a[0]));return a&&(!o.ie?"br"==a.nodeName():3==a[0].nodeType&&y.test(a.text()))?a[0]:!1}});return n.Walker=t},{requires:["./base","./utils","./dom","node"]});
KISSY.add("editor/elementPath",function(a){function n(a){for(var p=m,n=m,k=[];a;){if(a[0].nodeType==u.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var r=a.nodeName();if(!n&&(!p&&f[r]&&(p=a),j[r])){var w;if(w=!p)if(w="div"==r){a:{w=a[0].childNodes;for(var c=0,l=w.length;c<l;c++){var e=w[c];if(e.nodeType==u.NodeType.ELEMENT_NODE&&t.$block[e.nodeName.toLowerCase()]){w=!0;break a}}w=!1}w=!w}w?p=a:n=a}k.push(a);if("body"==r)break}a=a.parent()}this.block=p;this.blockLimit=n;this.elements=
k}var r=a.Editor,u=a.DOM,t=r.XHTML_DTD,m=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},j={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};n.prototype={constructor:n,compare:function(a){var f=this.elements,a=a&&a.elements;if(!a||f.length!=a.length)return!1;for(var j=0;j<f.length;j++)if(!u.equals(f[j],a[j]))return!1;return!0},contains:function(a){for(var f=this.elements,j=0;j<f.length;j++)if(f[j].nodeName()in a)return f[j];return m},toString:function(){var a=
this.elements,f,j=[];for(f=0;f<a.length;f++)j.push(a[f].nodeName());return j.toString()}};return r.ElementPath=n},{requires:["./base","./dom","node"]});
KISSY.add("editor/range",function(a,n,r,u,t){function m(c){var d=c.nodeType!=e.NodeType.TEXT_NODE&&e.nodeName(c)in b.$removeEmpty,h=c.nodeType==e.NodeType.TEXT_NODE&&!a.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return d||h||c}function f(a){return!i(a)&&!v(a)}function j(b){var c=y;return function(d){if(v(d))return k;if(d.nodeType==e.NodeType.TEXT_NODE){if(a.trim(d.nodeValue).length)return y}else if(d.nodeType==e.NodeType.ELEMENT_NODE&&(d=e.nodeName(d),!F[d]))if(!b&&!s.ie&&"br"==
d&&!c)c=k;else return y;return k}}function o(a,b){var c=a.startContainer,d=a.endContainer,g=a.startOffset,q=a.endOffset,i,f=y,l=y,j=void 0,v=a.document,s;0<b&&(j=v.createDocumentFragment());if(a.collapsed)return j;a.optimizeBookmark();d[0].nodeType==e.NodeType.TEXT_NODE?(l=k,d=d._4e_splitText(q)):0<d[0].childNodes.length&&(q>=d[0].childNodes.length?(d=new h(d[0].appendChild(v.createTextNode(""))),s=k):d=new h(d[0].childNodes[q]));c[0].nodeType==e.NodeType.TEXT_NODE?(f=k,c._4e_splitText(g)):g?g>=c[0].childNodes.length?
(c=new h(c[0].appendChild(v.createTextNode(""))),i=k):c=new h(c[0].childNodes[g].previousSibling):(i=new h(v.createTextNode("")),c.prepend(i),c=i,i=k);var J=c._4e_parents(),L=d._4e_parents();J.each(function(a,c){J[c]=a});L.each(function(a,c){L[c]=a});for(var G,N,v=0;v<J.length&&!(G=J[v],N=L[v],!G.equals(N));v++);for(var g=j,B,z,O=v;O<J.length;O++){B=J[O];q=0<b&&!B.equals(c)?g.appendChild(B.clone()[0]):null;B=B[0].nextSibling;z=L[O];for(var n=d[0],m=z&&z[0];B&&!(m==B||n==B);)z=B.nextSibling,2==b?g.appendChild(B.cloneNode(k)):
(e._4e_remove(B),1==b&&g.appendChild(B)),B=z;q&&(g=q)}for(g=j;v<L.length;v++){B=L[v];q=0<b&&!B.equals(d)?g.appendChild(B.clone()[0]):null;if(!J[v]||!B._4e_sameLevel(J[v]))for(B=B[0].previousSibling;B;)z=B.previousSibling,2==b?g.insertBefore(B.cloneNode(k),g.firstChild):(e._4e_remove(B),1==b&&g.insertBefore(B,g.firstChild)),B=z;q&&(g=q)}if(2==b){if(f&&(G=c[0],G.nodeType==e.NodeType.TEXT_NODE&&G.nextSibling&&G.nextSibling.nodeType==e.NodeType.TEXT_NODE&&(G.data+=G.nextSibling.data,G.parentNode.removeChild(G.nextSibling))),
l)l=d[0],l.nodeType==e.NodeType.TEXT_NODE&&l.previousSibling&&l.previousSibling.nodeType==e.NodeType.TEXT_NODE&&(l.previousSibling.data+=l.data,l.parentNode.removeChild(l))}else{if(G&&N&&(!c._4e_sameLevel(G)||!d._4e_sameLevel(N)))l=G._4e_index(),i&&G._4e_sameLevel(c)&&l--,a.setStart(G.parent(),l+1);a.collapse(k)}i&&c.remove();s&&d.remove();return j}function p(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==a.endContainer[0]&&a.startOffset==a.endOffset}function x(a){this.endOffset=
this.endContainer=this.startOffset=this.startContainer=w;this.collapsed=k;this.document=a}n.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var k=!0,y=!1,w=null,c=n.RANGE,l=n.POSITION,e=a.DOM,s=a.UA,b=n.XHTML_DTD,h=a.Node,d=h.all,g={area:1,base:1,br:1,col:1,hr:1,img:1,input:1,link:1,meta:1,param:1},i=new u.whitespaces,v=new u.bookmark,
z=u.whitespaces(k),A=u.bookmark(!1,!0),F={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(x,{toString:function(){var a=[],c=this.startContainer[0],b=this.endContainer[0];a.push((c.id||c.nodeName)+":"+this.startOffset);a.push((b.id||b.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=this.startContainer,c=this.startOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&
(c?c>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;c=this.endOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=
this.startContainer,c=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);c&&"span"==c.nodeName()&&c.attr("_ke_bookmark")&&this.setEndAfter(c)},setStart:function(a,c){a[0].nodeType==e.NodeType.ELEMENT_NODE&&g[a.nodeName()]&&(a=a.parent(),c=a._4e_index());this.startContainer=a;this.startOffset=c;this.endContainer||(this.endContainer=a,this.endOffset=c);p(this)},setEnd:function(a,c){a[0].nodeType==e.NodeType.ELEMENT_NODE&&g[a.nodeName()]&&(a=a.parent(),c=a._4e_index()+
1);this.endContainer=a;this.endOffset=c;this.startContainer||(this.startContainer=a,this.startOffset=c);p(this)},setStartAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setStart(a,0);break;case c.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setStartBefore(a);break;case c.POSITION_AFTER_END:this.setStartAfter(a)}p(this)},setEndAt:function(a,b){switch(b){case c.POSITION_AFTER_START:this.setEnd(a,
0);break;case c.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case c.POSITION_BEFORE_START:this.setEndBefore(a);break;case c.POSITION_AFTER_END:this.setEndAfter(a)}p(this)},cloneContents:function(){return o(this,2)},deleteContents:function(){return o(this,0)},extractContents:function(){return o(this,1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=
this.endContainer,this.startOffset=this.endOffset);this.collapsed=k},clone:function(){var a=new x(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=e.NodeType.ELEMENT_NODE||a.endContainer[0].nodeType!=e.NodeType.ELEMENT_NODE)return w;var c=new u(a);c.evaluator=function(a){return z(a)&&
A(a)};a=c.next();c.reset();c=c.previous();return a&&a.equals(c)?a:w},shrink:function(a,b){if(!this.collapsed){var a=a||c.SHRINK_TEXT,d=this.clone(),h=this.startContainer,g=this.endContainer,q=this.startOffset,i=this.endOffset,f=k,l,v,j=k;h&&h[0].nodeType==e.NodeType.TEXT_NODE&&(q?q>=h[0].nodeValue.length?d.setStartAfter(h):(d.setStartBefore(h),f=y):d.setStartBefore(h));g&&g[0].nodeType==e.NodeType.TEXT_NODE&&(i?i>=g[0].nodeValue.length?d.setEndAfter(g):(d.setEndAfter(g),j=y):d.setEndBefore(g));if(f||
j)v=new u(d),v.evaluator=function(b){return b.nodeType==(a==c.SHRINK_ELEMENT?e.NodeType.ELEMENT_NODE:e.NodeType.TEXT_NODE)},v.guard=function(b,d){if(a==c.SHRINK_ELEMENT&&b.nodeType==e.NodeType.TEXT_NODE||d&&b==l)return y;!d&&b.nodeType==e.NodeType.ELEMENT_NODE&&(l=b);return k};f&&(d=v[a==c.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(d,b?c.POSITION_AFTER_START:c.POSITION_BEFORE_START);j&&(v.reset(),(v=v[a==c.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(v,b?c.POSITION_BEFORE_END:
c.POSITION_AFTER_END));return f||j}},createBookmark2:function(a){var c=this.startContainer,b=this.endContainer,d=this.startOffset,g=this.endOffset,q,i;if(!c||!b)return{start:0,end:0};if(a){if(c[0].nodeType==e.NodeType.ELEMENT_NODE&&(q=new h(c[0].childNodes[d]))&&q[0]&&q[0].nodeType==e.NodeType.TEXT_NODE&&0<d&&q[0].previousSibling.nodeType==e.NodeType.TEXT_NODE)c=q,d=0;for(;c[0].nodeType==e.NodeType.TEXT_NODE&&(i=c.prev(void 0,1))&&i[0].nodeType==e.NodeType.TEXT_NODE;)c=i,d+=i[0].nodeValue.length;
if(!this.collapsed){if(b[0].nodeType==e.NodeType.ELEMENT_NODE&&(q=new h(b[0].childNodes[g]))&&q[0]&&q[0].nodeType==e.NodeType.TEXT_NODE&&0<g&&q[0].previousSibling.nodeType==e.NodeType.TEXT_NODE)b=q,g=0;for(;b[0].nodeType==e.NodeType.TEXT_NODE&&(i=b.prev(void 0,1))&&i[0].nodeType==e.NodeType.TEXT_NODE;)b=i,g+=i[0].nodeValue.length}}return{start:c._4e_address(a),end:this.collapsed?w:b._4e_address(a),startOffset:d,endOffset:g,normalized:a,is2:k}},createBookmark:function(b){var d,g,e,i,q=this.collapsed;
d=new h("<span>",w,this.document);d.attr("_ke_bookmark",1);d.css("display","none");d.html("&nbsp;");b&&(e=a.guid("ke_bm_"),d.attr("id",e+"S"));q||(g=d.clone(),g.html("&nbsp;"),b&&g.attr("id",e+"E"),i=this.clone(),i.collapse(),i.insertNode(g));i=this.clone();i.collapse(k);i.insertNode(d);g?(this.setStartAfter(d),this.setEndBefore(g)):this.moveToPosition(d,c.POSITION_AFTER_END);return{startNode:b?e+"S":d,endNode:b?e+"E":g,serializable:b,collapsed:q}},moveToPosition:function(a,c){this.setStartAt(a,c);
this.collapse(k)},trim:function(a,c){var b=this.startContainer,d=this.startOffset,g=this.collapsed;if((!a||g)&&b[0]&&b[0].nodeType==e.NodeType.TEXT_NODE){if(d)if(d>=b[0].nodeValue.length)d=b._4e_index()+1,b=b.parent();else{var h=b._4e_splitText(d),d=b._4e_index()+1,b=b.parent();e.equals(this.startContainer,this.endContainer)?this.setEnd(h,this.endOffset-this.startOffset):e.equals(b,this.endContainer)&&(this.endOffset+=1)}else d=b._4e_index(),b=b.parent();this.setStart(b,d);if(g){this.collapse(k);
return}}b=this.endContainer;d=this.endOffset;!c&&!g&&b[0]&&b[0].nodeType==e.NodeType.TEXT_NODE&&(d?(d>=b[0].nodeValue.length||b._4e_splitText(d),d=b._4e_index()+1):d=b._4e_index(),b=b.parent(),this.setEnd(b,d))},insertNode:function(a){this.optimizeBookmark();this.trim(y,k);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;this.setStartBefore(a)},moveToBookmark:function(b){var c=d(this.document);if(b.is2){var g=c._4e_getByAddress(b.start,
b.normalized),e=b.startOffset,c=b.end&&c._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(g,e);c?this.setEnd(c,b):this.collapse(k)}else g=(e=b.serializable)?a.one("#"+b.startNode,c):b.startNode,b=e?a.one("#"+b.endNode,c):b.endNode,this.setStartBefore(g),g._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(k)},getCommonAncestor:function(a,b){var c=this.startContainer,d=this.endContainer,c=c[0]==d[0]?a&&c[0].nodeType==e.NodeType.ELEMENT_NODE&&this.startOffset==
this.endOffset-1?new h(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(d);return b&&c[0].nodeType==e.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(b,c,g,h){var q=b[c?"startContainer":"endContainer"],f,l=c?0:1,j=0,k=c?"previousSibling":"nextSibling";f=b[c?"startOffset":"endOffset"];if(q[0].nodeType==e.NodeType.TEXT_NODE){if(c){if(f)return}else if(f<q[0].nodeValue.length)return;f=q[0][k];q=q[0].parentNode}else f=q[0].childNodes[f+(c?-1:1)]||null,q=q[0];for(;q;){for(;f;)if(i(f)||
v(f))f=f[k];else break;if(f){if(!j)b[c?"setStartAfter":"setEndBefore"](d(f));break}q=d(q);if("body"==q.nodeName())break;if(j||q.equals(h))g[l]=q,j=1;else b[c?"setStartBefore":"setEndAfter"](q);f=q[0][k];q=q[0].parentNode}}return function(b){switch(b){case c.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),g=[];a(this,1,g,b);a(this,0,g,b);g[0]&&g[1]&&(b=g[0].contains(g[1])?g[1]:g[0],this.setStartBefore(b),this.setEndAfter(b));break;case c.ENLARGE_BLOCK_CONTENTS:case c.ENLARGE_LIST_ITEM_CONTENTS:var i=
new x(this.document),g=new h(this.document.body);i.setStartAt(g,c.POSITION_AFTER_START);i.setEnd(this.startContainer,this.startOffset);var i=new u(i),f,q,l=u.blockBoundary(b==c.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:w),v=function(a){var b=l(a);b||(f=d(a));return b},j=function(a){var b=v(a);!b&&"br"==e.nodeName(a)&&(q=d(a));return b};i.guard=v;i=i.lastBackward();f=f||g;this.setStartAt(f,"br"!=f.nodeName()&&(!i&&this.checkStartOfBlock()||i&&f.contains(i))?c.POSITION_AFTER_START:c.POSITION_AFTER_END);i=this.clone();
i.collapse();i.setEndAt(g,c.POSITION_BEFORE_END);i=new u(i);i.guard=b==c.ENLARGE_LIST_ITEM_CONTENTS?j:v;f=w;i=i.lastForward();f=f||g;this.setEndAt(f,!i&&this.checkEndOfBlock()||i&&f.contains(i)?c.POSITION_BEFORE_END:c.POSITION_BEFORE_START);q&&this.setEndAfter(q)}}}(),checkStartOfBlock:function(){var b=this.startContainer,d=this.startOffset;if(d&&b[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(0,d)).length)return y;this.trim();b=new t(this.startContainer);d=this.clone();d.collapse(k);
d.setStartAt(b.block||b.blockLimit,c.POSITION_AFTER_START);b=new u(d);b.evaluator=j(k);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,d=this.endOffset;if(b[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(d)).length)return y;this.trim();b=new t(this.endContainer);d=this.clone();d.collapse(y);d.setEndAt(b.block||b.blockLimit,c.POSITION_BEFORE_END);b=new u(d);b.evaluator=j(y);return b.checkForward()},checkBoundaryOfElement:function(a,b){var d=this.clone();
d[b==c.START?"setStartAt":"setEndAt"](a,b==c.START?c.POSITION_AFTER_START:c.POSITION_BEFORE_END);d=new u(d);d.evaluator=m;return d[b==c.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,b=this.endContainer,c=this.startOffset,g=this.endOffset,h;if(a[0].nodeType==e.NodeType.ELEMENT_NODE)if(h=a[0].childNodes.length,h>c)a=d(a[0].childNodes[c]);else if(0==h)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=d(a);a=a._4e_nextSourceNode()||
a}if(b[0].nodeType==e.NodeType.ELEMENT_NODE)if(h=b[0].childNodes.length,h>g)b=d(b[0].childNodes[g])._4e_previousSourceNode(k);else if(0==h)b=b._4e_previousSourceNode();else{for(b=b[0];b.lastChild;)b=b.lastChild;b=d(b)}a._4e_position(b)&l.POSITION_FOLLOWING&&(a=b);return{startNode:a,endNode:b}},fixBlock:function(a,b){var g=this.createBookmark(),e=d(this.document.createElement(b));this.collapse(a);this.enlarge(c.ENLARGE_BLOCK_CONTENTS);e[0].appendChild(this.extractContents());e._4e_trim();s.ie||e._4e_appendBogus();
this.insertNode(e);this.moveToBookmark(g);return e},splitBlock:function(b){var d=new t(this.startContainer),g=new t(this.endContainer),e=d.block,h=g.block,i=w;if(!d.blockLimit.equals(g.blockLimit))return w;"br"!=b&&(e||(e=this.fixBlock(k,b),h=(new t(this.endContainer)).block),h||(h=this.fixBlock(y,b)));b=e&&this.checkStartOfBlock();d=h&&this.checkEndOfBlock();this.deleteContents();e&&e[0]==h[0]&&(d?(i=new t(this.startContainer),this.moveToPosition(h,c.POSITION_AFTER_END),h=w):b?(i=new t(this.startContainer),
this.moveToPosition(e,c.POSITION_BEFORE_START),e=w):(h=this.splitElement(e),!s.ie&&!a.inArray(e.nodeName(),["ul","ol"])&&e._4e_appendBogus()));return{previousBlock:e,nextBlock:h,wasStartOfBlock:b,wasEndOfBlock:d,elementPath:i}},splitElement:function(a){if(!this.collapsed)return w;this.setEndAt(a,c.POSITION_BEFORE_END);var b=this.extractContents(),d=a.clone(y);d[0].appendChild(b);d.insertAfter(a);this.moveToPosition(a,c.POSITION_AFTER_END);return d},moveToElementEditablePosition:function(a,b){for(var d=
0;a;){if(a[0].nodeType==e.NodeType.TEXT_NODE){this.moveToPosition(a,b?c.POSITION_AFTER_END:c.POSITION_BEFORE_START);d=1;break}a[0].nodeType==e.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,b?c.POSITION_BEFORE_END:c.POSITION_AFTER_START),d=1);var g=a,h=d,i=void 0;g[0].nodeType==e.NodeType.ELEMENT_NODE&&g._4e_isEditable()&&(i=g[b?"last":"first"](f,1));!h&&!i&&(i=g[b?"prev":"next"](f,1));a=i}return!!d},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==
e.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var c,d,g,e=a.nodeName();c=b.$block[e];this.deleteContents();if(c){for(c=this.getCommonAncestor(y,k);(d=b[c.nodeName()])&&(!d||!d[e]);){var h=c.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(c),this.collapse(k),c.remove()):g=c;c=h}g&&this.splitElement(g)}this.insertNode(a)}});r.injectDom({_4e_breakParent:function(a,b){var b=d(b),a=d(a),c,g=new n.Range(a[0].ownerDocument);g.setStartAfter(a);
g.setEndAfter(b);c=g.extractContents();g.insertNode(a.remove());a.after(c)}});return n.Range=x},{requires:"./base,./utils,./walker,./elementPath,./dom,node".split(",")});
KISSY.add("editor/selection",function(a){function n(a){this.document=a;this._={cache:{}};if(k)try{var c=this.getNative().createRange();if(!c||c.item&&c.item(0).ownerDocument!=a||c.parentElement&&c.parentElement().ownerDocument!=a)this.isInvalid=t}catch(d){this.isInvalid=t}}function r(a){a=new n(a);return!a||a.isInvalid?m:a}var u=a.Editor;u.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var t=!0,m=null,f=a.UA,j=a.DOM,o=a.Node,p=u.SELECTION,x=u.RANGE,k=f.ie,y=u.Walker,w=u.Range,c=
{img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(n,{getNative:!k?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=j.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!k?function(){var a=this._.cache;if(a.type)return a.type;var e=p.SELECTION_TEXT,d=this.getNative();if(d){if(1==d.rangeCount){var d=
d.getRangeAt(0),g=d.startContainer;g==d.endContainer&&g.nodeType==j.NodeType.ELEMENT_NODE&&1==Number(d.endOffset-d.startOffset)&&c[g.childNodes[d.startOffset].nodeName.toLowerCase()]&&(e=p.SELECTION_ELEMENT)}}else e=p.SELECTION_NONE;return a.type=e}:function(){var a=this._.cache;if(a.type)return a.type;var c=p.SELECTION_NONE;try{var d=this.getNative(),g=d.type;"Text"==g&&(c=p.SELECTION_TEXT);"Control"==g&&(c=p.SELECTION_ELEMENT);d.createRange().parentElement&&(c=p.SELECTION_TEXT)}catch(e){}return a.type=
c},getRanges:k?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),e=c.childNodes,f,l=0;l<e.length;l++){var k=e[l];if(k.nodeType==j.NodeType.ELEMENT_NODE){f=a.duplicate();f.moveToElementText(k);var k=f.compareEndPoints("StartToStart",a),s=f.compareEndPoints("EndToStart",a);f.collapse();if(0<k)break;else{if(!k||1==s&&-1==k)return{container:c,offset:l};if(!s)return{container:c,offset:l+1}}f=m}}f||(f=a.duplicate(),f.moveToElementText(c),f.collapse(!1));f.setEndPoint("StartToStart",
a);f=(""+f.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<f;)f-=e[--l].nodeValue.length}catch(n){f=0}return 0===f?{container:c,offset:l}:{container:e[l],offset:-f}};return function(c){var d=this._.cache;if(d.ranges&&!c)return d.ranges;var g=this.getNative(),c=g&&g.createRange(),e=this.getType();if(!g)return[];if(e==p.SELECTION_TEXT)return g=new w(this.document),e=a(c,t),g.setStart(new o(e.container),e.offset),e=a(c),g.setEnd(new o(e.container),e.offset),d.ranges=[g];if(e==p.SELECTION_ELEMENT){d=
d.ranges=[];for(e=0;e<c.length;e++){for(var f=c.item(e),l=f.parentNode,j=0,g=new w(this.document);j<l.childNodes.length&&l.childNodes[j]!=f;j++);g.setStart(new o(l),j);g.setEnd(new o(l),j+1);d.push(g)}return d}return d.ranges=[]}}():function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var a=[],d=this.getNative();if(!d)return[];for(var e=0;e<d.rangeCount;e++){var f=d.getRangeAt(e),l=new w(this.document);l.setStart(new o(f.startContainer),f.startOffset);l.setEnd(new o(f.endContainer),f.endOffset);
a.push(l)}return c.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var c,d=this.getNative();switch(this.getType()){case p.SELECTION_ELEMENT:return this.getSelectedElement();case p.SELECTION_TEXT:var e=this.getRanges()[0];if(e&&!e.collapsed){for(e.optimize();t;)if(c=e.startContainer,e.startOffset==(c[0].nodeType===j.NodeType.ELEMENT_NODE?c[0].childNodes.length:c[0].nodeValue.length)&&!c._4e_isBlockBoundary())e.setStartAfter(c);else break;c=e.startContainer;
if(c[0].nodeType!=j.NodeType.ELEMENT_NODE)return c.parent();c=new o(c[0].childNodes[e.startOffset]);if(!c[0]||c[0].nodeType!=j.NodeType.ELEMENT_NODE)return e.startContainer;for(e=c[0].firstChild;e&&e.nodeType==j.NodeType.ELEMENT_NODE;)c=new o(e),e=e.firstChild;return c}if(k)e=d.createRange(),e.collapse(t),c=new o(e.parentElement());else{if((c=d.anchorNode)&&c.nodeType!=j.NodeType.ELEMENT_NODE)c=c.parentNode;c&&(c=new o(c))}}return a.startElement=c},getSelectedElement:function(){var a,e=this._.cache;
if(void 0!==e.selectedElement)return e.selectedElement;k&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var d;if(a)d=new o(a);else{a=this.getRanges()[0];for(var g,f=2;f&&(!(d=a.getEnclosedNode())||!(d[0].nodeType==j.NodeType.ELEMENT_NODE&&c[d.nodeName()]&&(g=d)));f--)a.shrink(x.SHRINK_ELEMENT);d=g}return e.selectedElement=d},reset:function(){this._.cache={}},selectElement:function(a){var c,d=this.document;if(k)try{c=d.body.createControlRange(),c.addElement(a[0]),c.select()}catch(e){c=d.body.createTextRange(),
c.moveToElementText(a[0]),c.select()}finally{}else c=d.createRange(),c.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(c);this.reset()},selectRanges:function(a){if(k){if(1<a.length){var c=a[a.length-1];a[0].setEnd(c.endContainer,c.endOffset);a.length=1}a[0]&&a[0].select()}else{c=this.getNative();if(!c)return;c.removeAllRanges();for(var d=0;d<a.length;d++){var e=a[d],i=this.document.createRange(),l=e.startContainer;if(e.collapsed&&(f.gecko&&1.09>f.gecko||f.opera||f.webkit)&&l[0].nodeType==
j.NodeType.ELEMENT_NODE&&!l[0].childNodes.length)l[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),e.startOffset++,e.endOffset++;i.setStart(l[0],e.startOffset);i.setEnd(e.endContainer[0],e.endOffset);c.addRange(i)}}this.reset()},createBookmarks2:function(a){for(var c=[],d=this.getRanges(),e=0;e<d.length;e++)c.push(d[e].createBookmark2(a));return c},createBookmarks:function(c,e){for(var d=[],g=this.document,f,e=e||this.getRanges(),l=e.length,k=0;k<l;k++){d.push(f=e[k].createBookmark(c,
t));var s=(c=f.serializable)?a.one("#"+f.startNode,g):f.startNode;f=c?a.one("#"+f.endNode,g):f.endNode;for(var n=k+1;n<l;n++){var m=e[n],o=m.startContainer,r=m.endContainer;j.equals(o,s.parent())&&m.startOffset++;j.equals(o,f.parent())&&m.startOffset++;j.equals(r,s.parent())&&m.endOffset++;j.equals(r,f.parent())&&m.endOffset++}}return d},selectBookmarks:function(a){for(var c=[],d=0;d<a.length;d++){var e=new w(this.document);e.moveToBookmark(a[d]);c.push(e)}this.selectRanges(c);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();k?a&&a.clear():a&&a.removeAllRanges()}});var l={table:1,tbody:1,tr:1},e=y.whitespaces(t),s=/\ufeff|\u00a0/;w.prototype.select=w.prototype.select=!k?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
j.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var c=this.document.createRange();c.setStart(a[0],this.startOffset);try{c.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(t),c.setEnd(this.endContainer[0],this.endOffset);else throw d;}a=r(this.document).getNative();a.removeAllRanges();a.addRange(c)}:function(a){var c=this.collapsed,
d,f;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var i=this.startContainer[0].childNodes[this.startOffset];if(i.nodeType==j.NodeType.ELEMENT_NODE){(new n(this.document)).selectElement(new o(i));return}}(this.startContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in l||this.endContainer[0].nodeType==j.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in l)&&this.shrink(x.SHRINK_ELEMENT,t);var k=this.createBookmark(),i=k.startNode,
m;c||(m=k.endNode);k=this.document.body.createTextRange();k.moveToElementText(i[0]);k.moveStart("character",1);if(m)a=this.document.body.createTextRange(),a.moveToElementText(m[0]),k.setEndPoint("EndToEnd",a),k.moveEnd("character",-1);else{for(d=i[0].nextSibling;d&&!e(d);)d=d.nextSibling;d=!(d&&d.nodeValue&&d.nodeValue.match(s))&&(a||!i[0].previousSibling||i[0].previousSibling&&"br"==j.nodeName(i[0].previousSibling));f=new o(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(i);
d&&j.insertBefore(this.document.createTextNode("\ufeff"),i[0]||i)}this.setStartBefore(i);i._4e_remove();if(c){if(d?(k.moveStart("character",-1),k.select(),this.document.selection.clear()):k.select(),f)this.moveToPosition(f,x.POSITION_BEFORE_START),f._4e_remove()}else this.setEndBefore(m),m._4e_remove(),k.select()};n.getSelection=r;return u.Selection=n},{requires:["./base","./walker","./range","./dom","node"]});
KISSY.add("editor/domIterator",function(a){function n(a){1>arguments.length||(this.range=a,this.forceBrBreak=u,this.enlargeBr=r,this.enforceRealBlocks=u,this._||(this._={}))}var r=!0,u=!1,t=a.Editor,m=a.UA,f=t.Walker,j=t.Range,o=t.RANGE,p=t.ElementPath,x=a.Node,k=a.DOM,y=/^[\r\n\t ]*$/;a.augment(n,{getNextParagraph:function(n){var c,l,e,s,b;if(!this._.lastNode){l=this.range.clone();l.shrink(o.SHRINK_ELEMENT,r);l.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:o.ENLARGE_BLOCK_CONTENTS);
var h=new f(l),d=f.bookmark(r,r);h.evaluator=d;this._.nextNode=h.next();h=new f(l);h.evaluator=d;h=h.previous();this._.lastNode=h._4e_nextSourceNode(r);this._.lastNode&&this._.lastNode[0].nodeType==k.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(d=new j(l.document),d.moveToPosition(this._.lastNode,o.POSITION_AFTER_END),d.checkEndOfBlock()&&(d=new p(d.endContainer),this._.lastNode=(d.block||d.blockLimit)._4e_nextSourceNode(r)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new x(l.document.createTextNode("")),k.insertAfter(this._.lastNode[0],h[0]));l=null}d=this._.nextNode;h=this._.lastNode;for(this._.nextNode=null;d;){var g=u,i=d[0].nodeType!=k.NodeType.ELEMENT_NODE,v=u;if(i)d[0].nodeType==k.NodeType.TEXT_NODE&&y.test(d[0].nodeValue)&&(i=u);else{var z=d.nodeName();if(d._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==z)i=r;else if(!l&&!d[0].childNodes.length&&"hr"!=z){c=d;e=d.equals(h);break}l&&(l.setEndAt(d,o.POSITION_BEFORE_START),
"br"!=z&&(this._.nextNode=d));g=r}else{if(d[0].firstChild){l||(l=new j(this.range.document),l.setStartAt(d,o.POSITION_BEFORE_START));d=new x(d[0].firstChild);continue}i=r}}i&&!l&&(l=new j(this.range.document),l.setStartAt(d,o.POSITION_BEFORE_START));e=(!g||i)&&d.equals(h);if(l&&!g)for(;!d[0].nextSibling&&!e;){z=d.parent();if(z._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){g=r;e||z.equals(h);break}d=z;i=r;e=d.equals(h);v=r}i&&l.setEndAt(d,o.POSITION_AFTER_END);d=d._4e_nextSourceNode(v,null,h);if((e=
!d)||g&&l)break}if(!c){if(!l)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;c=new p(l.startContainer);d=c.blockLimit;g={div:1,th:1,td:1};c=c.block;if((!c||!c[0])&&!this.enforceRealBlocks&&g[d.nodeName()]&&l.checkStartOfBlock()&&l.checkEndOfBlock())c=d;else if(!c||this.enforceRealBlocks&&"li"==c.nodeName())c=new x(this.range.document.createElement(n||"p")),c[0].appendChild(l.extractContents()),c._4e_trim(),l.insertNode(c),s=b=r;else if("li"!=c.nodeName()){if(!l.checkStartOfBlock()||
!l.checkEndOfBlock())c=c.clone(u),c[0].appendChild(l.extractContents()),c._4e_trim(),b=l.splitBlock(),s=!b.wasStartOfBlock,b=!b.wasEndOfBlock,l.insertNode(c)}else e||(this._.nextNode=c.equals(h)?null:l.getBoundaryNodes().endNode._4e_nextSourceNode(r,null,h))}s&&(l=new x(c[0].previousSibling),l[0]&&l[0].nodeType==k.NodeType.ELEMENT_NODE&&("br"==l.nodeName()?l._4e_remove():l[0].lastChild&&"br"==k.nodeName(l[0].lastChild)&&k._4e_remove(l[0].lastChild)));b&&(l=f.bookmark(u,r),s=new x(c[0].lastChild),
s[0]&&s[0].nodeType==k.NodeType.ELEMENT_NODE&&"br"==s.nodeName()&&(m.ie||s.prev(l,1)||s.next(l,1))&&s.remove());this._.nextNode||(this._.nextNode=e||c.equals(h)?null:c._4e_nextSourceNode(r,null,h));return c}});j.prototype.createIterator=function(){return new n(this)};return n},{requires:["./base","./range","./elementPath","./walker","node"]});
KISSY.add("editor/styles",function(a,n){function r(a){return!A.attr(a,"_ke_bookmark")}function u(a,c){for(var d in a)"string"==typeof a[d]?a[d]=a[d].replace(S,function(a,d){return c[d]}):u(a[d],c)}function t(c,d){d&&(c=a.clone(c),u(c,d));var b=this.element=this.element=(c.element||"*").toLowerCase();this.type=this.type="#text"==b||E[b]?F.STYLE_BLOCK:Q[b]?F.STYLE_OBJECT:F.STYLE_INLINE;this._={definition:c}}function m(a,c){var d=c?this.removeFromRange:this.applyToRange;a.body.focus();for(var b=new K(a),
e=b.getRanges(),f=0;f<e.length;f++)d.call(this,e[f]);b.selectRanges(e)}function f(a,c,d){var b=a.element;"*"==b&&(b="span");c=new H(c.createElement(b));d&&d._4e_copyAttributes(c);d=a._.definition;a=d.attributes;d=t.getStyleText(d);if(a)for(var e in a)c.attr(e,a[e]);d&&(c[0].style.cssText=d);return c}function j(a){var c=a.createBookmark(g),d=a.createIterator();d.enforceRealBlocks=g;d.enlargeBr=g;for(var b,e=a.document;b=d.getNextParagraph();){var i=f(this,e,b),l=i,i="pre"==l.nodeName,h="pre"==b.nodeName,
j=!i&&h;i&&!h?(h=b,j=h.html(),j=o(j,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),j=j.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),j=j.replace(/([ \t\n\r]+|&nbsp;)/g," "),j=j.replace(/<br\b[^>]*>/gi,"\n"),q.ie?(h=h[0].ownerDocument.createElement("div"),h.appendChild(l[0]),l[0].outerHTML="<pre>"+j+"</pre>",l=new H(h.firstChild),l._4e_remove()):l.html(j)):j?l=x(p(b),l):b._4e_moveChildren(l);b[0].parentNode.replaceChild(l[0],b[0]);if(i&&(b=l,i=void 0,(i=b._4e_previousSourceNode(g,A.NodeType.ELEMENT_NODE))&&
"pre"==i.nodeName()))l=o(i.html(),/\n$/,"")+"\n\n"+o(b.html(),/^\n/,""),q.ie?b[0].outerHTML="<pre>"+l+"</pre>":b.html(l),i._4e_remove()}a.moveToBookmark(c)}function o(a,c,d){var b="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,c,d){c&&(b=c);d&&(e=d);return""});return b+a.replace(c,d)+e}function p(a){var c=[];o(a.outerHTML(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,c,d){return c+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,d){c.push(d)});return c}function x(a,c){for(var d=c[0].ownerDocument.createDocumentFragment(),b=0;b<a.length;b++){var e=a[b],e=e.replace(/(\r\n|\r)/g,"\n"),e=o(e,/^[ \t]*\n/,""),e=o(e,/\n$/,""),e=o(e,/^[ \t]+|[ \t]+$/g,function(a,c){return 1==a.length?"&nbsp;":c?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),f=c.clone();f.html(e);d.appendChild(f[0])}return d}
function k(a){var c=a.document;if(a.collapsed)c=f(this,c,void 0),a.insertNode(c),a.moveToPosition(c,I.POSITION_BEFORE_END);else{var d=this.element,e=this._.definition,l,h=M[d];h||(l=g,h=M.span);var j=a.createBookmark();a.enlarge(I.ENLARGE_ELEMENT);a.trim();for(var k=a.createBookmark(),s=k.startNode,k=k.endNode,C=s,E;C&&C[0];){var m=i;if(A.equals(C,k))C=v,m=g;else{var n=C[0].nodeType,o=n==A.NodeType.ELEMENT_NODE?C.nodeName():v;if(o&&C.attr("_ke_bookmark")){C=C._4e_nextSourceNode(g);continue}if(!o||
h[o]&&(C._4e_position(k)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(C))){var p=C.parent();if(p&&"a"==d&&p.nodeName()==d)n=f(this,c,void 0),p._4e_moveChildren(n),p[0].parentNode.replaceChild(n[0],p[0]),n._4e_mergeSiblings();else if(p&&p[0]&&((M[p.nodeName()]||M.span)[d]||l)&&(!e.parentRule||e.parentRule(p))){if(!E&&(!o||!M.$removeEmpty[o]||(C._4e_position(k)|D.POSITION_PRECEDING|D.POSITION_IDENTICAL|
D.POSITION_IS_CONTAINED)==D.POSITION_PRECEDING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED))E=new P(c),E.setStartBefore(C);if(n==A.NodeType.TEXT_NODE||n==A.NodeType.ELEMENT_NODE&&!C[0].childNodes.length){p=C;for(n=null;(m=!p.next(r,1))&&(n=p.parent())&&h[n.nodeName()]&&(n._4e_position(s)|D.POSITION_FOLLOWING|D.POSITION_IDENTICAL|D.POSITION_IS_CONTAINED)==D.POSITION_FOLLOWING+D.POSITION_IDENTICAL+D.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(n));)p=n;E.setEndAfter(p)}}else m=g}else m=g;C=C._4e_nextSourceNode()}if(m&&
E&&!E.collapsed){for(var m=f(this,c,void 0),p=E.getCommonAncestor(),n={},o={},z,t=null,u;m&&p&&m[0]&&p[0];){if(p.nodeName()==d){for(z in e.attributes)if(!o[z]&&(u=p.attr(t)))m.attr(z)==u?m.removeAttr(z):o[z]=1;for(t in e.styles)if(!n[t]&&(u=p.style(t)))m.style(t)==u?m.style(t,""):n[t]=1;if(!m._4e_hasAttributes()){m=v;break}}p=p.parent()}m?(m[0].appendChild(E.extractContents()),b(this,m),E.insertNode(m),m._4e_mergeSiblings(),q.ie||m[0].normalize()):(m=new H(c.createElement("span")),m[0].appendChild(E.extractContents()),
E.insertNode(m),b(this,m),m._4e_remove(!0));E=v}}s._4e_remove();k._4e_remove();a.moveToBookmark(j);a.shrink(I.SHRINK_TEXT)}}function y(a){a.enlarge(I.ENLARGE_ELEMENT);var c=a.createBookmark(),d=c.startNode;if(a.collapsed){for(var b=new C(d.parent()),f,g=0,i;g<b.elements.length&&(i=b.elements[g])&&!(i==b.block||i==b.blockLimit);g++)if(this.checkElementRemovable(i)){var j=a.checkBoundaryOfElement(i,I.END),k=!j&&a.checkBoundaryOfElement(i,I.START);k||j?(f=i,f.match=k?"start":"end"):(i._4e_mergeSiblings(),
i.nodeName()!=this.element?(j=l(this),h(i,j[i.nodeName()]||j["*"])):e(this,i))}if(f){i=d;for(g=0;;g++){j=b.elements[g];if(j.equals(f))break;else if(j.match)continue;else j=j.clone();j[0].appendChild(i[0]);i=j}i["start"==f.match?"insertBefore":"insertAfter"](f);b=f.html();!b||"\u200b"==b?f.remove():q.webkit&&z(a.document.createTextNode("\u200b")).insertBefore(i)}}else{var m=c.endNode,E=this;f=function(){for(var a=new C(d.parent()),c=new C(m.parent()),b=v,e=v,f=0;f<a.elements.length;f++){var g=a.elements[f];
if(g==a.block||g==a.blockLimit)break;E.checkElementRemovable(g)&&(b=g)}for(f=0;f<c.elements.length;f++){g=c.elements[f];if(g==c.block||g==c.blockLimit)break;E.checkElementRemovable(g)&&(e=g)}e&&m._4e_breakParent(e);b&&d._4e_breakParent(b)};f();for(b=new H(d[0].nextSibling);b[0]!==m[0];){g=b._4e_nextSourceNode();if(b[0]&&b[0].nodeType==A.NodeType.ELEMENT_NODE&&this.checkElementRemovable(b)&&(b.nodeName()==this.element?e(this,b):(i=l(this),h(b,i[b.nodeName()]||i["*"])),g[0].nodeType==A.NodeType.ELEMENT_NODE&&
g.contains(d)))f(),g=new H(d[0].nextSibling);b=g}}a.moveToBookmark(c)}function w(a){var c={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,d,b){c[d]=b});return c}function c(a,c){var d="";c!==i?(d=document.createElement("span"),d.style.cssText=a,d=d.style.cssText||""):d=a;return d.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function l(c){if(c._.overrides)return c._.overrides;var d=c._.overrides={},b=c._.definition.overrides;
if(b){a.isArray(b)||(b=[b]);for(var e=0;e<b.length;e++){var f=b[e],g,i,q;"string"==typeof f?g=f.toLowerCase():(g=f.element?f.element.toLowerCase():c.element,i=f.attributes,q=f.styles);f=d[g]||(d[g]={});if(i){g=f.attributes=f.attributes||[];for(var l in i)g.push([l.toLowerCase(),i[l]])}if(q){var f=f.styles=f.styles||[],h;for(h in q)f.push([h.toLowerCase(),q[h]])}}}return d}function e(c,b){var e=c._.definition,f=l(c),i=a.merge(e.attributes,(f[b.nodeName()]||f["*"]||{}).attributes),e=a.merge(e.styles,
(f[b.nodeName()]||f["*"]||{}).styles),f=a.isEmptyObject(i)&&a.isEmptyObject(e),q;for(q in i)("class"==q||c._.definition.fullMatch)&&b.attr(q)!=s(q,i[q])||(f=f||!!b.hasAttr(q),b.removeAttr(q));for(var h in e)c._.definition.fullMatch&&b.style(h)!=s(h,e[h],g)||(f=f||!!b.style(h),b.style(h,""));d(b)}function s(a,c,b){var d=new H("<span>");d[b?"style":"attr"](a,c);return d[b?"style":"attr"](a)}function b(a,c){for(var b=l(a),d=c.all(a.element),f=d.length;0<=--f;)e(a,new H(d[f]));for(var g in b)if(g!=a.element){d=
c.all(g);for(f=d.length-1;0<=f;f--){var i=new H(d[f]);h(i,b[g])}}}function h(a,c){var b,e=c&&c.attributes;if(e)for(b=0;b<e.length;b++){var f=e[b][0],g;if(g=a.attr(f)){var i=e[b][1];(i===v||i.test&&i.test(g)||"string"==typeof i&&g==i)&&a[0].removeAttribute(f)}}if(e=c&&c.styles)for(b=0;b<e.length;b++)if(f=e[b][0],i=a.css(f)){var q=e[b][1];(q===v||q.test&&q.test(g)||"string"==typeof q&&i==q)&&a.css(f,"")}d(a)}function d(a){if(!a._4e_hasAttributes()){var c=a[0].firstChild,b=a[0].lastChild;a._4e_remove(g);
c&&(c.nodeType==A.NodeType.ELEMENT_NODE&&A._4e_mergeSiblings(c),b&&c!=b&&b.nodeType==A.NodeType.ELEMENT_NODE&&A._4e_mergeSiblings(b))}}var g=!0,i=!1,v=null,z=a.all,A=a.DOM,F={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},I=n.RANGE,K=n.Selection,D=n.POSITION,P=n.Range,H=a.Node,q=a.UA,C=n.ElementPath,E={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},M=n.XHTML_DTD,Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},R=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;n.STYLE=
F;t.prototype={constructor:t,apply:function(a){m.call(this,a,i)},remove:function(a){m.call(this,a,g)},applyToRange:function(a){return(this.applyToRange=this.type==F.STYLE_INLINE?k:this.type==F.STYLE_BLOCK?j:v).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==F.STYLE_INLINE?y:v).call(this,a)},checkElementRemovable:function(a,b){if(!a)return i;var d=this._.definition,e;if(a.nodeName()==this.element){if(!b&&!a._4e_hasAttributes())return g;var f=d._AC;if(f)d=f;else{var f=
{},q=0,h=d.attributes;if(h)for(var j in h)q++,f[j]=h[j];if(h=t.getStyleText(d))f.style||q++,f.style=h;f._length=q;d=d._AC=f}if(d._length){for(var k in d)if("_length"!=k){q=a.attr(k)||"";if("style"==k)a:{f=d[k];q=c(q,i);"string"==typeof f&&(f=w(f));"string"==typeof q&&(q=w(q));h=void 0;for(h in f)if(!(h in q&&(q[h]==f[h]||"inherit"==f[h]||"inherit"==q[h]))){f=i;break a}f=g}else f=d[k]==q;if(f){if(!b)return g}else if(b)return i}if(b)return g}else return g}k=l(this);if(k=k[a.nodeName()]||k["*"]){if(!(d=
k.attributes)&&!(e=k.styles))return g;if(d)for(f=0;f<d.length;f++)if(k=d[f][0],k=a.attr(k))if(q=d[f][1],q===v||"string"==typeof q&&k==q||q.test&&q.test(k))return g;if(e)for(f=0;f<e.length;f++)if(k=a.css(e[f][0]))if(d=e[f][1],d===v||"string"==typeof d&&k==d||d.test&&d.test(k))return g}return i},checkActive:function(a){switch(this.type){case F.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,g);case F.STYLE_OBJECT:case F.STYLE_INLINE:for(var c=a.elements,b=0,d;b<c.length;b++)if(d=
c[b],!(this.type==F.STYLE_INLINE&&(A.equals(d,a.block)||A.equals(d,a.blockLimit))))if((this.type!=F.STYLE_OBJECT||d.nodeName()in Q)&&this.checkElementRemovable(d,g))return g}return i}};t.getStyleText=function(a){var d=a._ST;if(d)return d;var d=a.styles,b=a.attributes&&a.attributes.style||"",e="";b.length&&(b=b.replace(R,";"));for(var f in d){var g=d[f],i=(f+":"+g).replace(R,";");"inherit"==g?e+=i:b+=i}b.length&&(b=c(b));return a._ST=b+e};return n.Style=t},{requires:"./base,./range,./selection,./domIterator,./elementPath,node".split(",")});
KISSY.add("editor/zIndexManager",function(a){var n=a.Editor,a=n.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};n.baseZIndex=function(a){return(n.Config.baseZIndex||1E4)+a};return a},{requires:["./base"]});
KISSY.add("editor/clipboard",function(a,n,r,u){function t(a){this.editor=a;this._init()}function m(a){var l=a.get("document")[0],e=a.getSelection(),j;if(e.getType()==u.SELECTION_ELEMENT&&(j=e.getSelectedElement())){var a=e.getRanges()[0],b=f(l.createTextNode(""));b.insertBefore(j);a.setStartBefore(b);a.setEndAfter(j);e.selectRanges([a]);setTimeout(function(){j.parent()&&(b.remove(),e.selectElement(j))},0)}}var f=a.all,j=a.UA,o=j.ie?"beforepaste":"paste",p=n.RANGE;a.augment(t,{_init:function(){var a=
this,f=a.editor,e=f.get("document"),n=e.one("body"),b=function(a){this.type=a};b.prototype={exec:function(b){var d=this.type;b.focus();setTimeout(function(){j.ie&&("cut"==d?m(b):"paste"==d&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));k(b,d)||alert(y[d])},0)}};n.on(o,a._getClipboardDataFromPasteBin,a);j.ie&&(n.on("paste",a._iePaste,a),e.on("keydown",a._onKeyDown,a),e.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));f.addCommand("copy",
new b("copy"));f.addCommand("cut",new b("cut"));f.addCommand("paste",new b("paste"))},_onKeyDown:function(a){this.editor.get("mode")==n.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86==a.keyCode||a.shiftKey&&45==a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var f,e=this.editor;if("paste"==a){this._isPreventBeforePaste=1;try{f=e.get("document")[0].queryCommandEnabled(a)}catch(j){}this._isPreventBeforePaste=0}else f=(a=(a=e.getSelection())&&a.getRanges())&&!(1==a.length&&a[0].collapsed);
return f},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var f=this.editor;this._isPreventPaste||(a.preventDefault(),f.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var c=this.editor,l=c.get("document")[0];if(!l.getElementById("ke_pastebin")){var e=c.getSelection(),k=new r(l),b=f(j.webkit?
"<body></body>":l.createElement("div"),null,l);b.attr("id","ke_pastebin");j.webkit&&b[0].appendChild(l.createTextNode("\u200b"));l.body.appendChild(b[0]);b.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});b.css("left","-1000px");var h=e.createBookmarks();k.setStartAt(b,p.POSITION_AFTER_START);k.setEndAt(b,p.POSITION_BEFORE_END);k.select(!0);setTimeout(function(){var d,f=b;b=j.webkit&&(d=b.first())&&d.hasClass("Apple-style-span")?d:b;e.selectBookmarks(h);
var i=b.html();f.remove();if(i=a.trim(i.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,"")))d=c.fire("paste",{html:i}),!1!==d&&(void 0!==d&&(i=d),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(i)?a.use("editor/plugin/word-filter",function(a,b){c.insertHTML(b.toDataFormat(i,c))}):c.insertHTML(i))},0)}}}});var x=function(a,l){var e=a.get("document")[0],k=f(e.body),b=!1,h=function(){b=!0};k.on(l,h);(7<j.ie?e:e.selection.createRange()).execCommand(l);k.detach(l,h);return b},k=j.ie?
function(a,f){return x(a,f)}:function(a,f){try{return a.get("document")[0].execCommand(f)}catch(e){return!1}},y={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},w={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var f;a.docReady(function(){f=new t(a)});var e={copy:1,cut:1,paste:1},j=["copy","cut","paste"];a.on("contextmenu",function(b){var h=b.contextmenu;if(!h.__copy_fix){h.__copy_fix=
1;for(b=0;b<j.length;b++)h.addChild({content:w[j[b]],value:j[b]});h.on("click",function(b){var d=b.target.get("value");e[d]&&(h.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(d);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var d=h.get("children"),b=d.length-1;b--;0<=b){var g=d[b],i;i=g.get?g.get("value"):g.value;e[i]&&(i=!f._stateFromNamedCommand(i),g.set?g.set("disabled",i):g.disabled=i)}})}}},{requires:["./base","./range","./selection","node"]});
KISSY.add("editor/enterKey",function(a,n,r,u){function t(k){var m;m=k.getSelection().getRanges();for(var n=m.length-1;0<n;n--)m[n].deleteContents();m=m[0];n=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var c=(new u(m.startContainer)).block;if(c&&("li"==c.nodeName()||"li"==c.parent().nodeName()))return k.hasCommand("outdent")?(k.execCommand("save"),k.execCommand("outdent"),k.execCommand("save"),!0):!1}var l=m.splitBlock("p");if(!l)return!0;var k=l.previousBlock,c=l.nextBlock,e=l.wasStartOfBlock,
s=l.wasEndOfBlock,b;if(c)b=c.parent(),"li"==b.nodeName()&&(c._4e_breakParent(b),c._4e_move(c.next(),!0));else if(k&&(b=k.parent())&&"li"==b.nodeName())k._4e_breakParent(b),m.moveToElementEditablePosition(k.next()),k._4e_move(k.prev());if(!e&&!s){if("li"==c.nodeName()&&(b=c.first(r.invisible(!0)))&&a.inArray(b.nodeName(),["ul","ol"]))(f.ie?new p(n.createTextNode("\u00a0")):new p(n.createElement("br"))).insertBefore(b);c&&m.moveToElementEditablePosition(c)}else{var h;if(k){if("li"==k.nodeName()||!j.test(k.nodeName()))h=
k.clone()}else c&&(h=c.clone());h||(h=new p("<p>",null,n));if(b=l.elementPath)for(var l=0,d=b.elements.length;l<d;l++){var g=b.elements[l];if(g.equals(b.block)||g.equals(b.blockLimit))break;o.$removeEmpty[g.nodeName()]&&(g=g.clone(),h._4e_moveChildren(g),h.append(g))}f.ie||h._4e_appendBogus();m.insertNode(h);if(f.ie&&e&&(!s||!k[0].childNodes.length))m.moveToElementEditablePosition(s?k:h),m.select();m.moveToElementEditablePosition(e&&!s?c:h)}f.ie||(c?(h=new p(n.createElement("span")),h.html("&nbsp;"),
m.insertNode(h),h.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),m.deleteContents()):h.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));m.select();return!0}function m(a){var f=a.get("document")[0];x.on(f,"keydown",function(f){if(13===f.keyCode&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){a.execCommand("save");var c=a.execCommand("enterBlock");a.execCommand("save");!1!==c&&f.preventDefault()}})}var f=a.UA,j=/^h[1-6]$/,o=n.XHTML_DTD,
p=a.Node,x=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:t});a.docReady(function(){m(a)})}}},{requires:["./base","./walker","./elementPath","node"]});
KISSY.add("editor/htmlDataProcessor",function(a,n,r){return{init:function(u){function t(c){var c=c.childNodes,b,e,f,h=c.length;if(h){f=1;for(b=0;b<h;b++)if(e=c[b],e.nodeType!=a.DOM.NodeType.TEXT_NODE||e.nodeValue){f=0;break}return f?!1:void 0}return!1}function m(a){return a.replace(y,function(a,c,b){return"<"+c+b.replace(w,function(a,c){return-1==b.indexOf("_ke_saved_"+c)?" _ke_saved_"+a+" "+a:a})+">"})}function f(a){return a.replace(l,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function j(c){return c.replace(e,function(c,b){return a.urlDecode(b)})}var o=a.Node,p=a.UA,x=new r.Filter,k=new r.Filter;(function(){function b(a){a=r.serialize(a);return new r.Comment(c+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var e={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:t}},f={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var c=["name","href","src"],
b,d=0;d<c.length;d++)b="_ke_saved_"+c[d],a.getAttribute(b)&&a.removeAttribute(c[d]);return a},embed:function(a){var c=a.parentNode;if(c&&"object"==c.nodeName){var b=c.getAttribute("width"),c=c.getAttribute("height");b&&a.setAttribute("width",b);c&&a.setAttribute("width",c)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:t,strong:t,em:t,del:t,u:t},attributes:{style:function(c){if(!a.trim(c))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,c.length)==c)return b=a.trim(a.urlDecode(b.substr(c.length))),r.parse(b).childNodes[0]}};p.ie&&(f.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});x.addRules(f);k.addRules(e)})();(function(){function c(b){for(var b=b.childNodes,d=b.length,e=b[d-1];e&&3==e.nodeType&&!a.trim(e.nodeValue);)e=b[--d];return e}function b(a){var e=c(a);e&&(1==e.nodeType&&"br"==e.nodeName?a.removeChild(e):3==e.nodeType&&
j.test(e.nodeValue)&&a.removeChild(e))}function e(a){var b=c(a);return!b||"form"==a.nodeName&&"input"==b.nodeName}function f(a){b(a);e(a)&&(p.ie||a.appendChild(new r.Tag("br")))}function h(a){b(a);e(a)&&a.appendChild(new r.Text("\u00a0"))}var j=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,l=n.XHTML_DTD,m=a.merge(l.$block,l.$listItem,l.$tableContent),s;for(s in m)"br"in l[s]||delete m[s];delete m.pre;var l={tags:{}},o={tags:{}};for(s in m)l.tags[s]=f,o.tags[s]=h;k.addRules(l);x.addRules(o)})();x.addRules({text:function(a){return a.replace(/\xa0/g,
"&nbsp;")}});var y=/<(a|area|img|input)\b([^>]*)>/gi,w=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,c="{ke_protected}",l=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,e=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,s=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,b=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,h=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;
u.htmlDataProcessor={dataFilter:k,htmlFilter:x,toHTML:function(a){p.webkit&&(a=a.replace(/\u200b/g,""));var c=new r.BeautifyWriter;(new r.Parser(a)).parse().writeHTML(c,x);return a=c.getHTML()},toDataFormat:function(a,c){var c=c||k,a=f(a),a=m(a),a=a.replace(s,"$1ke:$2"),a=a.replace(h,"<ke:$1$2></ke:$1>"),e=new o("<div>");e.html("a"+a);a=e.html().substr(1);a=a.replace(b,"$1$2");a=j(a);e=new r.BasicWriter;(new r.Parser(a)).parse().writeHTML(e,c);return a=e.getHTML()},toServer:function(a){var c=new r.MinifyWriter;
(new r.Parser(a)).parse().writeHTML(c,x);return c.getHTML()}}}}},{requires:["./base","htmlparser"]});
KISSY.add("editor/selectionFix",function(a,n){function r(a){function f(a,c){var b=d.body.createTextRange();try{b.moveToPoint(a,c)}catch(e){b=o}return b}function e(){var a=d.selection.createRange();g&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&g.select();x.remove(d,"mouseup",e);x.remove(d,"mousemove",j);g=b=0}function j(a){if(a.button){if(a=f(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",g)?a.setEndPoint("StartToStart",g):a.setEndPoint("EndToEnd",g),a.select()}else e()}var b,h=a.get("window")[0],
d=a.get("document")[0],g;x.on(d,"mousedown contextmenu",function(a){var c=d.documentElement;if(a.target===c&&(b&&e(),!(c.scrollHeight>c.clientHeight)&&(b=1,g=f(a.pageX,a.pageY))))x.on(d,"mouseup",e),x.on(d,"mousemove",j),h.focus(),g.select()})}function u(a){function l(b){if(d){var g=a.getSelection(),j=g&&g.getType(),k=g&&e.selection;if(b&&k&&j==w.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){l(f)},50);else{var m;if(!k||!k.type||!("Control"!=k.type&&(m=k.createRange())&&
(m=m.parentElement())&&(m=m.nodeName)&&m.toLowerCase()in{input:1,textarea:1}))h=k&&g.getRanges()[0],a.checkSelectionChange()}}}var e=a.get("document")[0],k=new y(e.body),b=new y(e.documentElement);if(8>n.Utils.ieEngine)b.on("click",function(b){"html"===(new y(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var h,d,g=f;b.on("mousedown",function(){g=j});b.on("mouseup",function(){g=f});k.on("focusin",function(a){if("body"==(new y(a.target)).nodeName()&&h){try{g&&h.select()}catch(c){}h=
o}});k.on("focus",function(){d=f;l()});k.on("beforedeactivate",function(a){a.relatedTarget||(d=j,g=f)});k.on("mousedown",function(){d=j});k.on("mouseup",function(){d=f;setTimeout(function(){l(f)},0)});k.on("keydown",function(){d=j});k.on("keyup",function(){d=f;setTimeout(function(){l()},0)})}function t(a){var f=a.get("document")[0];x.on(f,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function m(a){function l(a){var c=n.XHTML_DTD;return a._4e_isBlockBoundary()&&c.$empty[a.nodeName()]}
function e(a){return b(a)&&h(a)}var m=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,b=n.Walker.whitespaces(f),h=n.Walker.bookmark(j,f),d=function(a){return b(a)&&8!=a.nodeType};a.on("selectionChange",function(b){var i=b.path,h=new y(a.get("document")[0].body),b=(b=b.selection)&&b.getRanges()[0],o=i.blockLimit;if(p.gecko){var r=i.block||i.blockLimit,t=r&&r.last(e);r&&r._4e_isBlockBoundary()&&(!t||!(1==t[0].nodeType&&
t._4e_isBlockBoundary()))&&"pre"!=r.nodeName()&&!r._4e_getBogus()&&r._4e_appendBogus()}if(b&&b.collapsed&&!i.block){if("body"==o.nodeName()){if((i=b.fixBlock(f,"p"))&&i[0]!=h[0].lastChild&&i.outerHTML().match(m))if((o=i.next(d,1))&&o[0].nodeType==k.NodeType.ELEMENT_NODE&&!l[o])b.moveToElementEditablePosition(o),i._4e_remove();else if((o=i.prev(d,1))&&o[0].nodeType==k.NodeType.ELEMENT_NODE&&!l[o])b.moveToElementEditablePosition(o,o.outerHTML().match(m)?j:f),i._4e_remove();b.select();a.notifySelectionChange()}i=
a.get("document")[0];b=new n.Range(i);b.moveToElementEditablePosition(h,f);"body"!==(new n.ElementPath(b.startContainer)).blockLimit.nodeName()&&(h=(new y(i.createElement("p"))).appendTo(h),p.ie||h._4e_appendBogus())}})}var f=!0,j=!1,o=null,p=a.UA,x=a.Event,k=a.DOM,y=a.Node,w=n.SELECTION;return{init:function(a){a.docReady(function(){p.ie?(r(a),u(a)):t(a)});m(a)}}},{requires:["./base","./selection","node"]});
KISSY.add("editor/plugin-meta",function(){(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/back-color/cmd"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui","editor/plugin/bold/cmd"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor",
"button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});
a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});
a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor","htmlparser"]}});a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor","editor/plugin/contextmenu","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/flash-common/utils"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class",
"editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui","editor/plugin/font-family/cmd"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor",
"editor/plugin/font/ui","editor/plugin/font-size/cmd"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn","editor/plugin/fore-color/cmd"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor",
"editor/plugin/heading/cmd"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor","editor/plugin/indent/cmd"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});
a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui","editor/plugin/italic/cmd"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor","editor/plugin/justify-center/cmd"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor","editor/plugin/justify-left/cmd"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-right":{requires:["editor","editor/plugin/justify-right/cmd"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/link/utils","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});
a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor","editor/plugin/maximize/cmd"]}});a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,overlay,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/ordered-list/cmd"]}});a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor",
"editor/plugin/outdent/cmd"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/remove-format/cmd","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});a({"editor/plugin/resize":{requires:["editor",
"dd"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui","editor/plugin/strike-through/cmd"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader","editor/plugin/contextmenu"]}});
a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui","editor/plugin/underline/cmd"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor","editor/plugin/undo/btn","editor/plugin/undo/cmd"]}});a({"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});
a({"editor/plugin/unordered-list":{requires:["editor","editor/plugin/list-utils/btn","editor/plugin/unordered-list/cmd"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["htmlparser"]}});
a({"editor/plugin/xiami-music":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA)});
KISSY.add("editor",function(a,n,r,u,t,m,f,j,o,p){function x(a,c){var d=a.body;F(function(){a.designMode="on";setTimeout(function(){a.designMode="off";d.focus();arguments.callee.retry||(arguments.callee.retry=l)},50)},function(){a.designMode="off";i.attr(d,"contentEditable",b);i.attr(d,"contentEditable",l);!c&&x(a,1)})}function k(c){c.get("iframe");var e=c.get("textarea")[0],f=c.get("window")[0],i=c.get("document")[0];d.webkit&&(A.on(i,"click",function(c){var b=new z(c.target);a.inArray(b.nodeName(),
["input","select"])&&c.preventDefault()}),A.on(i,"mouseup",function(c){var b=new z(c.target);a.inArray(b.nodeName(),["input","textarea"])&&c.preventDefault()}));if(d.gecko||g||d.opera){var h;h=(new z('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(e);h.on("focus",function(){c.focus()});c.activateGecko=function(){d.gecko&&c.__iframeFocus&&h[0].focus()};c.on("destroy",function(){h.detach();h.remove()})}A.on(f,"focus",function(){d.gecko?x(i,b):d.opera&&
i.body.focus();c.notifySelectionChange()});if(d.gecko)A.on(i,"mousedown",function(){c.__iframeFocus||x(i,b)});if(g&&(A.on(i,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var b=c.getSelection(),d=b.getSelectedElement();if(d){c.execCommand("save");var e=b.getRanges()[0].createBookmark();d.remove();b.selectBookmarks([e]);c.execCommand("save");a.preventDefault()}}}),"CSS1Compat"==i.compatMode)){var j={33:1,34:1};A.on(i,"keydown",function(a){a.keyCode in j&&setTimeout(function(){c.getSelection().scrollIntoView()},
0)})}if(d.webkit)A.on(i,"mousedown",function(b){b=new z(b.target);a.inArray(b.nodeName(),["img","hr","input","textarea","select"])&&c.getSelection().selectElement(b)});if(d.gecko)A.on(i,"dragstart",function(a){var b=new z(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});u.add(c)}function y(b,c,d,e){var f="",g;g=r.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(g);for(g=0;g<d.length;g++)f+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[g]});
return a.substitute(I,{doctype:8===h.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",links:f,style:c,data:e||"",script:b?'<script id="ke_active_script">'+(i.isCustomDomain()?'document.domain="'+h.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function w(a,b){function c(){h=i.document;a.setInternal("document",new z(h));a.setInternal("window",new z(i));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),
e=y(a._UUID,a.get("customStyle"),a.get("customLink"),b),f=d[0],i=f.contentWindow,h;d.__loaded=1;try{h=i.document}catch(j){if(f.src=f.src,7>g){setTimeout(c,10);return}}c()}function c(b,c){var e=i.getEmptyIframeSrc()||"";e&&(e=' src="'+e+'" ');var e=new z(a.substitute(K,{iframeSrc:e})),f=b.get("textarea");f.hasAttr("tabindex")&&e.attr("tabindex",d.webkit?-1:f.attr("tabindex"));f.parent().prepend(e);b.set("iframe",e);b.__docReady=0;if(d.gecko&&!e.__loaded)e.on("load",function(){w(b,c)},b);else w(b,c)}
var l=!0,e=e,s=a.all,b=!1,h=document,d=a.UA,g=d.ie,i=a.DOM,v=i.NodeType,z=a.Node,A=a.Event,F=r.tryThese,I='<!doctype html><html><head>{doctype}<title>{title}</title><style>{style}</style>{links}</head><body class="ks-editor" >{data}{script}</body></html>',K='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',D=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i,P='<div class="{prefixCls}editor-tools"></div><div class="{prefixCls}editor-textarea-wrap" '+
(d.mobile?'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':"")+'></div><div class="{prefixCls}editor-status"></div>';n.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};a.augment(n,{createDom:function(){var b,c=this.prefixCls,d=this.get("textarea"),e;d?(this.set("textarea",d=s(d)),d[0].parentNode&&d.remove()):(b=this.get("data"),this.set("textarea",d=s('<textarea class="'+c+'-editor-textarea"></textarea>')),d.val(b));e=this.get("el");e.html(a.substitute(P,{prefixCls:c}));b=e.one(a.substitute(".{prefixCls}editor-textarea-wrap",
{prefixCls:c}));this._UUID=a.guid();this.set({toolBarEl:e.one(a.substitute(".{prefixCls}editor-tools",{prefixCls:c})),statusBarEl:e.one(a.substitute(".{prefixCls}editor-status",{prefixCls:c}))},{silent:1});d.css("width","100%");d.css("display","none");b.append(d);u.register(this)},renderUI:function(){f.init(this);j.init(this);o.init(this);p.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,
c,d=b.prefixCls,e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))A.on(c,"submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},syncUI:function(){this.get("rendered")&&this.get("textarea").val(this.get("data"))},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||
0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){this.get("rendered");var b=this.get("iframe"),c=this.get("textarea");1==a?(this._setData(c.val()),c.hide(),this.fire("wysiwygMode")):(b&&(c.val(this._getData(1,1)),b.hide()),c.show(),this.fire("sourceMode"))},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},_onSetData:function(a){this.get("rendered")&&this._setData(a)},destructor:function(){var b,c=this.get("textarea"),d=this.get("document")[0],e=this.get("window");
this.get("attachForm")&&(b=c[0].form)&&A.detach(b,"submit",this.sync,this);u.remove(this);A.remove([d,d.documentElement,d.body,e[0]]);a.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,
dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(b){var c=this.__commands[b],d=a.makeArray(arguments);d.shift();d.unshift(this);return c?c.exec.apply(c,d):e},queryCommandValue:function(a){return this.execCommand(r.getQueryCmd(a))},_getData:function(b,c){var d=this.htmlDataProcessor,f;if(!this.get("rendered"))return e;c==e&&(c=this.get("mode"));f=1==c&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());
f=b?d.toHTML(f):d.toServer(f);f=a.trim(f);D.test(f)&&(f="");return f},_setData:function(a){var b,d=a;if(1!=this.get("mode"))this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)d=b.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var e=this.get("document")[0];A.remove([e,e.documentElement,e.body,b]);a.remove()}c(this,d)}},getDocHTML:function(){return y(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getDocHtml:function(){return this.getDocHTML()},
getSelection:function(){return n.Selection.getSelection(this.get("document")[0])},getSelectedHTML:function(){var a=this.getSelection().getRanges()[0],b;a&&(a=a.cloneContents(),b=this.get("document")[0].createElement("div"),b.appendChild(a),b=b.innerHTML);return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];d.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&i.addStyleSheet(c,a,b)},removeCustomStyle:function(a){i.remove(i.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(b){for(var c=
this.get("document")[0],c=i.query("link",c),d=0;d<c.length;d++)i.attr(c[d],"href")==b&&i.remove(c[d]);c=this.get("customLink");b=a.indexOf(b,c);-1!=b&&c.splice(b,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),
d=new n.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(1!==this.get("mode"))return e;this.focus();var b,c=a.nodeName(),d=n.XHTML_DTD,f=d.$block[c],g=n.RANGE,i=(c=this.getSelection())&&c.getRanges(),h,j,k;if(!i||0==i.length)return e;this.execCommand("save");for(j=i.length-1;0<=j;j--)h=
i[j],b=!j&&a||a.clone(l),h.insertNodeByDtd(b),k||(k=b);if(!k)return e;h.moveToPosition(k,g.POSITION_AFTER_END);f&&(a=n.Walker.whitespaces(!0),(a=(k=k.next(a,1))&&k[0].nodeType==v.ELEMENT_NODE&&k.nodeName())&&d.$block[a]&&d[a]["#text"]&&h.moveToElementEditablePosition(k));c.selectRanges([h]);this.focus();b&&1==b[0].nodeType&&b.scrollIntoView(e,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});H.call(this);return b},insertHTML:function(a,c){var d=this,f,h=d.get("document")[0];if(1===
d.get("mode")){if(f=d.htmlDataProcessor)a=f.toDataFormat(a,c);d.focus();d.execCommand("save");if(g){f=h.selection;"Control"==f.type&&f.clear();try{f.createRange().pasteHTML(a)}catch(j){}}else try{h.execCommand("inserthtml",b,a)}catch(k){setTimeout(function(){if(0==d.getSelection().getRanges().length){var c=new n.Range(h),f=i.first(h.body,function(a){return 1==a.nodeType&&"br"!=i.nodeName(a)});f||(f=new z(h.createElement("p")),f._4e_appendBogus(e),h.body.appendChild(f[0]));c.setStartAt(f,n.RANGE.POSITION_AFTER_START);
c.select()}h.execCommand("inserthtml",b,a)},50)}setTimeout(function(){d.getSelection().scrollIntoView()},50);H.call(d)}}});n._initIFrame=function(a){var c=u.getInstance(a),e=c.get("document")[0],a=e.getElementById("ke_active_script");i.remove(a);k(c);var f=e.body;g?(f.hideFocus=l,f.disabled=l,f.contentEditable=l,f.removeAttribute("disabled")):setTimeout(function(){d.gecko||d.opera?f.contentEditable=l:d.webkit?f.parentNode.contentEditable=l:e.designMode="on"},0);if(d.gecko||d.opera){var h=e.documentElement;
A.on(h,"mousedown",function(a){if(a.target==h){d.gecko&&x(e,b);c.activateGecko()}})}setTimeout(function(){g&&setTimeout(function(){if(e){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){c.__docReady=1;c.fire("docReady");var a=c.get("disableObjectResizing"),d=c.get("disableInlineTableEditing");if(a||d)try{e.execCommand("enableObjectResizing",b,!a);e.execCommand("enableInlineTableEditing",b,!d)}catch(h){A.on(f,g?"resizestart":"resize",function(b){var c=
new z(b.target);(a||c.nodeName()==="table"&&d)&&b.preventDefault()})}},10)};var H=a.buffer(function(){this.execCommand("save")},50);return n},{requires:"editor/base,editor/utils,editor/focusManager,editor/styles,editor/zIndexManager,editor/clipboard,editor/enterKey,editor/htmlDataProcessor,editor/selectionFix,editor/plugin-meta".split(",")});
