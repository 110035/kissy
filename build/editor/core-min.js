/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: May 20 23:13
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(a,i,r){i=r.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:i.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(a){var i=this._getData();return void 0===i?a:i}},formatData:{getter:function(){return this._getData(1)}},customStyle:{value:""},customLink:{value:[]}}},{xclass:"editor"});i.HTML_PARSER=
{textarea:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea")},data:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea").val()}};a.mix(i,a.EventTarget);return KISSY.Editor=i},{requires:["htmlparser","component/base","core"]});
KISSY.add("editor/core/clipboard",function(a,i,r,q){function p(c){this.editor=c;this._init()}function h(c,b){if(b=a.trim(b.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,""))){var t=c.fire("paste",{html:b});void 0!==t&&(b=t);/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(b)?a.use("editor/plugin/word-filter",function(d,f){c.insertHTML(f.toDataFormat(b,c))}):c.insertHTML(b)}}function e(c){var b=c.get("document")[0];if(l.ie&&"BackCompat"!=b.compatMode){var a=c.getSelection(),d;if(a.getType()==
q.SELECTION_ELEMENT&&(d=a.getSelectedElement())){var c=a.getRanges()[0],f=m(b.createTextNode(""));f.insertBefore(d);c.setStartBefore(f);c.setEndAfter(d);a.selectRanges([c]);setTimeout(function(){d.parent()&&(f.remove(),a.selectElement(d))},0)}}}var m=a.all,l=a.UA,n=l.ie?"beforepaste":"paste",u=i.RANGE;a.augment(p,{_init:function(){var c=this,b=c.editor,a=b.get("document"),d=a.one("body"),f=function(c){this.type=c};f.prototype={exec:function(b){var d=this.type;b.focus();setTimeout(function(){"cut"==
d?e(b):l.ie&&"paste"==d&&(c._preventPasteEvent(),b.get("document").one("body").fire(n));w(b,d)||alert(y[d])},0)}};d.on(n,c._paste,c);l.ie&&(d.on("paste",c._iePaste,c),a.on("keydown",c._onKeyDown,c),a.on("contextmenu",function(){c._isPreventBeforePaste=1;setTimeout(function(){c._isPreventBeforePaste=0},0)}));b.addCommand("copy",new f("copy"));b.addCommand("cut",new f("cut"));b.addCommand("paste",new f("paste"))},_onKeyDown:function(c){this.editor.get("mode")==i.Mode.WYSIWYG_MODE&&c.ctrlKey&&86==c.keyCode&&
this._preventPasteEvent()},_stateFromNamedCommand:function(c){var b,a=this.editor;if("paste"==c){this._isPreventBeforePaste=1;try{b=a.get("document")[0].queryCommandEnabled(c)}catch(d){}this._isPreventBeforePaste=0}else b=(c=(c=a.getSelection())&&c.getRanges())&&!(1==c.length&&c[0].collapsed);return b},_preventPasteEvent:function(){var c=this;c._preventPasteTimer&&clearTimeout(c._preventPasteTimer);c._isPreventPaste=1;c._preventPasteTimer=setTimeout(function(){c._isPreventPaste=0},100)},_iePaste:function(c){var b=
this.editor;this._isPreventPaste||(c.preventDefault(),b.execCommand("paste"))},_paste:function(){if(!this._isPreventBeforePaste){var c=this.editor,b=c.get("document")[0];if(!b.getElementById("ke_pastebin")){var a=c.getSelection(),d=new r(b),f=m(l.webkit?"<body></body>":b.createElement("div"),null,b);f.attr("id","ke_pastebin");l.webkit&&f[0].appendChild(b.createTextNode("\u00a0"));b.body.appendChild(f[0]);f.css({position:"absolute",top:a.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});
f.css("left","-1000px");var g=a.createBookmarks();d.setStartAt(f,u.POSITION_AFTER_START);d.setEndAt(f,u.POSITION_BEFORE_END);d.select(!0);setTimeout(function(){var b;f=l.webkit&&(b=f.first())&&b.hasClass("Apple-style-span")?b:f;a.selectBookmarks(g);f.remove();b=f.html();h(c,b)},0)}}}});var o=function(c,b){var a=c.get("document")[0],d=m(a.body),f=!1,g=function(){f=!0};d.on(b,g);(7<l.ie?a:a.selection.createRange()).execCommand(b);d.detach(b,g);return f},w=l.ie?function(c,b){return o(c,b)}:function(c,
b){try{return c.get("document")[0].execCommand(b)}catch(a){return!1}},y={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},j={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(c){var b;c.docReady(function(){b=new p(c)});var a={copy:1,cut:1,paste:1},d=["copy","cut","paste"];c.on("contextmenu",function(f){var g=f.contextmenu;if(!g.__copy_fix){g.__copy_fix=1;for(f=0;f<d.length;f++)g.addChild({content:j[d[f]],
value:d[f]});g.on("click",function(b){var d=b.target.get("value");a[d]&&(g.hide(),setTimeout(function(){c.execCommand("save");c.execCommand(d);setTimeout(function(){c.execCommand("save")},10)},30))})}for(var k=g.get("children"),f=k.length-1;f--;0<=f){var s=k[f],e;e=s.get?s.get("value"):s.value;a[e]&&(e=!b._stateFromNamedCommand(e),s.set?s.set("disabled",e):s.disabled=e)}})}}},{requires:["./base","./range","./selection"]});
KISSY.add("editor/core",function(a,i,r,q,p,h,e,m,l,n){function u(b,g){var v=b.body;E(function(){b.designMode="on";setTimeout(function(){b.designMode="off";v.focus();arguments.callee.retry||(arguments.callee.retry=c)},50)},function(){b.designMode="off";s.attr(v,"contentEditable",d);s.attr(v,"contentEditable",c);!g&&u(b,1)})}function o(b){b.get("iframe");var c=b.get("textarea")[0],v=b.get("window")[0],f=b.get("document")[0];g.webkit&&(z.on(f,"click",function(b){var c=new C(b.target);a.inArray(c.nodeName(),
["input","select"])&&b.preventDefault()}),z.on(f,"mouseup",function(b){var c=new C(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()}));if(g.gecko||k||g.opera){var x;x=(new C('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(c);x.on("focus",function(){b.focus()});b.activateGecko=function(){g.gecko&&b.__iframeFocus&&x[0].focus()};b.on("destroy",function(){x.detach();x.remove()})}z.on(v,"focus",function(){g.gecko?u(f,d):g.opera&&
f.body.focus();b.notifySelectionChange()});if(g.gecko)z.on(f,"mousedown",function(){b.__iframeFocus||u(f,d)});if(k&&(z.on(f,"keydown",function(c){if(c.keyCode in{8:1,46:1}){var d=b.getSelection(),g=d.getSelectedElement();if(g){b.execCommand("save");var f=d.getRanges()[0].createBookmark();g.remove();d.selectBookmarks([f]);b.execCommand("save");c.preventDefault()}}}),"CSS1Compat"==f.compatMode)){var D={33:1,34:1};z.on(f,"keydown",function(c){c.keyCode in D&&setTimeout(function(){b.getSelection().scrollIntoView()},
0)})}if(g.webkit)z.on(f,"mousedown",function(c){c=new C(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(g.gecko)z.on(f,"dragstart",function(b){var c=new C(b.target);c.nodeName()==="img"&&/ke_/.test(c[0].className)&&b.preventDefault()});q.add(b)}function w(b,c,d,g){var k="",x,D=r.debugUrl("theme/editor-iframe.css");for(x=0;x<d.length;x++)k+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[x]});return a.substitute(v,{doctype:8===
f.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",href:D,style:c,data:g||"&nbsp;",script:b?'<script id="ke_active_script">'+(s.isCustomDomain()?'document.domain="'+f.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function y(b,c){function d(){x=a.document;b.setInternal("document",new C(x));b.setInternal("window",new C(a));g.detach();x.open("text/html","replace");x.write(f);x.close()}var g=b.get("iframe"),f=w(b._UUID,b.get("customStyle"),
b.get("customLink"),c),v=g[0],a=v.contentWindow,x;g.__loaded=1;try{x=a.document}catch(D){if(v.src=v.src,7>k){setTimeout(d,10);return}}d()}function j(b,c){var d=s.getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new C(a.substitute(D,{iframeSrc:d})),f=b.get("textarea");f.hasAttr("tabindex")&&d.attr("tabindex",g.webkit?-1:f.attr("tabindex"));f.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(g.gecko&&!d.__loaded)d.on("load",function(){y(b,c)},b);else y(b,c)}var c=!0,b=b,t=a.all,d=!1,f=document,
g=a.UA,k=g.ie,s=a.DOM,B=s.NodeType,C=a.Node,z=a.Event,E=r.tryThese,v='<!doctype html><html><head>{doctype}<title>{title}</title><link href="{href}" rel="stylesheet" /><style>{style}</style>{links}</head><body class="ks-editor" >{data}{script}</body></html>',D='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',x=/^(?:<(p)>)?(?:(?:&nbsp;)|\s)*(?:<\/\1>)?$/i,O='<div class="{prefixCls}editor-tools"></div><div class="{prefixCls}editor-textarea-wrap" '+
(g.mobile?'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':"")+'></div><div class="{prefixCls}editor-status"></div>';i.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};a.augment(i,{createDom:function(){var b,c=this.get("prefixCls"),d=this.get("textarea"),g;d?(this.set("textarea",d=t(d)),d[0].parentNode&&d.remove()):(b=this.get("data"),this.set("textarea",d=t('<textarea class="'+c+'-editor-textarea"></textarea>')),d.val(b));g=this.get("el");g.html(a.substitute(O,{prefixCls:c}));b=g.one(a.substitute(".{prefixCls}editor-textarea-wrap",
{prefixCls:c}));this._UUID=a.guid();this.set({toolBarEl:g.one(a.substitute(".{prefixCls}editor-tools",{prefixCls:c})),statusBarEl:g.one(a.substitute(".{prefixCls}editor-status",{prefixCls:c}))},{silent:1});d.css("width","100%");d.css("display","none");b.append(d);q.register(this)},renderUI:function(){e.init(this);m.init(this);l.init(this);n.init(this)},bindUI:function(){function b(){c.detach("docReady",b);if(c.get("focused"))c.focus();else{var d=c.getSelection();d&&d.removeAllRanges()}}var c=this,
d,g=c.get("prefixCls"),f=c.get("textarea");if(c.get("attachForm")&&(d=f[0].form))z.on(d,"submit",c.sync,c);c.on("docReady",b);c.on("blur",function(){c.get("el").removeClass(g+"editor-focused")});c.on("focus",function(){c.get("el").addClass(g+"editor-focused")})},syncUI:function(){this.get("rendered")&&this.get("textarea").val(this.get("data"))},_onSetHeight:function(b){var c=this.get("textarea"),d=this.get("toolBarEl"),g=this.get("statusBarEl"),b=parseInt(b,10),b=b-((d&&d.outerHeight()||0)+(g&&g.outerHeight()||
0));c.parent().css("height",b);c.css("height",b)},_onSetMode:function(b){this.get("rendered");var c=this.get("iframe"),d=this.get("textarea");1==b?(this._setData(d.val()),d.hide(),this.fire("wysiwygMode")):(c&&(d.val(this._getData(1,1)),c.hide()),d.show(),this.fire("sourceMode"))},_onSetFocused:function(b){b&&this.__docReady&&this.focus()},_onSetData:function(b){this.get("rendered")&&this._setData(b)},destructor:function(){var b,c=this.get("textarea"),d=this.get("document")[0],g=this.get("window");
this.get("attachForm")&&(b=c[0].form)&&z.detach(b,"submit",this.sync,this);q.remove(this);z.remove([d,d.documentElement,d.body,g[0]]);a.each(this.__controls,function(b){b.destroy&&b.destroy()});this.__commands={};this.__controls={}},getControl:function(b){return this.__controls[b]},getControls:function(){return this.__controls},addControl:function(b,c){this.__controls[b]=c},showDialog:function(b,c){var b=b+"/dialog",d=this.__controls[b];d.show(c);this.fire("dialogShow",{dialog:d.dialog,pluginDialog:d,
dialogName:b})},addCommand:function(b,c){this.__commands[b]=c},hasCommand:function(b){return this.__commands[b]},execCommand:function(c){var d=this.__commands[c],g=a.makeArray(arguments);g.shift();g.unshift(this);return d?d.exec.apply(d,g):b},queryCommandValue:function(b){return this.execCommand(r.getQueryCmd(b))},_getData:function(c,d){var g=this.htmlDataProcessor,f;if(!this.get("rendered"))return b;d==b&&(d=this.get("mode"));f=1==d&&this.isDocReady()?this.get("document")[0].body.innerHTML:g.toDataFormat(this.get("textarea").val());
f=c?g.toHTML(f):g.toServer(f);f=a.trim(f);x.test(f)&&(f="");return f},_setData:function(b){var c,d=b;if(1!=this.get("mode"))this.get("textarea").val(b);else{if(c=this.htmlDataProcessor)d=c.toDataFormat(b);if(this.get("iframe")){b=this.get("iframe");c=this.get("window")[0];var g=this.get("document")[0];z.remove([g,g.documentElement,g.body,c]);b.remove()}j(this,d)}},getDocHTML:function(){return w(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getDocHtml:function(){return this.getDocHTML()},
getSelection:function(){return i.Selection.getSelection(this.get("document")[0])},getSelectedHTML:function(){var b=this.getSelection().getRanges()[0],c;b&&(b=b.cloneContents(),c=this.get("document")[0].createElement("div"),c.appendChild(b),c=c.innerHTML);return c},focus:function(){var b=this.get("window");if(b){var c=this.get("document")[0],b=b[0];g.ie||b&&b.parent&&b.parent.focus();b&&b.focus();try{c.body.focus()}catch(d){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(b,c){var d=this.get("window"),g=this.get("customStyle")||"";this.set("customStyle",g+("\n"+b));d&&s.addStyleSheet(d,b,c)},removeCustomStyle:function(b){s.remove(s.get("#"+b,this.get("window")[0]))},addCustomLink:function(b){var c=this.get("customLink")||[],d=this.get("document")[0];c.push(b);this.set("customLink",c);c=d.createElement("link");c.rel="stylesheet";d.getElementsByTagName("head")[0].appendChild(c);c.href=b},removeCustomLink:function(b){for(var c=
this.get("document")[0],c=s.query("link",c),d=0;d<c.length;d++)s.attr(c[d],"href")==b&&s.remove(c[d]);c=this.get("customLink")||[];b=a.indexOf(b,c);-1!=b&&c.splice(b,1)},docReady:function(b){this.on("docReady",b);this.__docReady&&b.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var b=this;b.__checkSelectionChangeId&&clearTimeout(b.__checkSelectionChangeId);b.__checkSelectionChangeId=setTimeout(function(){var c=b.getSelection();if(c&&!c.isInvalid){var d=c.getStartElement(),
g=new i.ElementPath(d);if(!b.__previousPath||!b.__previousPath.compare(g))b.__previousPath=g,b.fire("selectionChange",{selection:c,path:g,element:d})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(d){if(1!==this.get("mode"))return b;this.focus();var g,f=d.nodeName(),v=i.XHTML_DTD,a=v.$block[f],k=i.RANGE,x=(f=this.getSelection())&&f.getRanges(),D,s,t;if(!x||0==x.length)return b;this.execCommand("save");for(s=x.length-1;0<=s;s--)D=
x[s],g=!s&&d||d.clone(c),D.insertNodeByDtd(g),t||(t=g);if(!t)return b;D.moveToPosition(t,k.POSITION_AFTER_END);a&&(d=i.Walker.whitespaces(!0),(d=(t=t.next(d,1))&&t[0].nodeType==B.ELEMENT_NODE&&t.nodeName())&&v.$block[d]&&v[d]["#text"]&&D.moveToElementEditablePosition(t));f.selectRanges([D]);this.focus();g&&1==g[0].nodeType&&g.scrollIntoView(b,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});G.call(this);return g},insertHTML:function(c,g){var f=this,v,a=f.get("document")[0];if(1===
f.get("mode")){if(v=f.htmlDataProcessor)c=v.toDataFormat(c,g);f.focus();f.execCommand("save");if(k){v=a.selection;"Control"==v.type&&v.clear();try{v.createRange().pasteHTML(c)}catch(x){}}else try{a.execCommand("inserthtml",d,c)}catch(D){setTimeout(function(){if(0==f.getSelection().getRanges().length){var g=new i.Range(a),v=s.first(a.body,function(b){return 1==b.nodeType&&"br"!=s.nodeName(b)});v||(v=new C(a.createElement("p")),v._4e_appendBogus(b),a.body.appendChild(v[0]));g.setStartAt(v,i.RANGE.POSITION_AFTER_START);
g.select()}a.execCommand("inserthtml",d,c)},50)}setTimeout(function(){f.getSelection().scrollIntoView()},50);G.call(f)}},insertHtml:function(b,c){this.insertHTML(b,c)}});i._initIFrame=function(b){var f=q.getInstance(b),v=f.get("document")[0],b=v.getElementById("ke_active_script");s.remove(b);o(f);var a=v.body;k?(a.hideFocus=c,a.disabled=c,a.contentEditable=c,a.removeAttribute("disabled")):setTimeout(function(){g.gecko||g.opera?a.contentEditable=c:g.webkit?a.parentNode.contentEditable=c:v.designMode=
"on"},0);if(g.gecko||g.opera){var x=v.documentElement;z.on(x,"mousedown",function(b){if(b.target==x){g.gecko&&u(v,d);f.activateGecko()}})}setTimeout(function(){k&&setTimeout(function(){if(v){a.runtimeStyle.marginBottom="0px";a.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){f.__docReady=1;f.fire("docReady");var b=f.get("disableObjectResizing"),c=f.get("disableInlineTableEditing");if(b||c)try{v.execCommand("enableObjectResizing",d,!b);v.execCommand("enableInlineTableEditing",d,!c)}catch(g){z.on(a,
k?"resizestart":"resize",function(d){var g=new C(d.target);(b||g.nodeName()==="table"&&c)&&d.preventDefault()})}},10)};var G=a.buffer(function(){this.execCommand("save")},50);return i},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
KISSY.add("editor/core/dom",function(a,i,r){function q(c,b){var a=c[b?"next":"prev"](p,1);if(a&&a[0].nodeType==m.ELEMENT_NODE){for(var d=[];a.attr("_ke_bookmark")||a._4e_isEmptyInlineRemovable(p);)if(d.push(a),a=b?a.next(p,1):a.prev(p,1),!a)return;if(c._4e_isIdentical(a,p)){for(var f=new n(b?c[0].lastChild:c[0].firstChild);d.length;)d.shift()._4e_move(c,!b,p);a._4e_moveChildren(c,!b,p);a.remove();f[0]&&f[0].nodeType==m.ELEMENT_NODE&&f._4e_mergeSiblings()}}}var p=p,h=i.XHTML_DTD,e=a.DOM,m=e.NodeType,
l=a.UA,n=a.Node,u={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};i.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var o=i.POSITION,w={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},y={hr:1},j=function(c){return c&&(c[0]||c)};r.injectDom({_4e_sameLevel:function(c,b){var b=j(b),a=c.parentNode;return a&&a==b.parentNode},_4e_isBlockBoundary:function(c,b){var t=a.merge(y,b);return!(!w[e.css(c,"display")]&&!t[e.nodeName(c)])},_4e_index:function(c,b){for(var a=c.parentNode.childNodes,d,f=-1,g=0;g<a.length;g++)if(d=a[g],!b||!(3==d.nodeType&&d.previousSibling&&3==d.previousSibling.nodeType))if(f++,d===c)return f;return-1},_4e_move:function(c,
b,a){b=j(b);a?b.insertBefore(c,b.firstChild):b.appendChild(c)},_4e_isIdentical:function(c,b){if(!b)return!1;b=j(b);if(e.nodeName(c)!=e.nodeName(b))return!1;var a=c.attributes,d=b.attributes,f=a.length,g=d.length;if(f!=g)return!1;for(var k=0;k<f;k++){var s=a[k],h=s.name;if(s.specified&&e.attr(c,h)!=e.attr(b,h))return!1}if(8>r.ieEngine)for(k=0;k<g;k++)if(s=d[k],h=s.name,s.specified&&e.attr(c,h)!=e.attr(b,h))return!1;return!0},_4e_isEmptyInlineRemovable:function(c){if(!h.$removeEmpty[e.nodeName(c)])return!1;
for(var c=c.childNodes,b=0,t=c.length;b<t;b++){var d=c[b],f=d.nodeType;if(!(f==m.ELEMENT_NODE&&d.getAttribute("_ke_bookmark"))&&(f==m.ELEMENT_NODE&&!e._4e_isEmptyInlineRemovable(d)||f==e.NodeType.TEXT_NODE&&a.trim(d.nodeValue)))return!1}return!0},_4e_moveChildren:function(c,b,a){b=j(b);if(c!=b)if(a)for(;a=c.lastChild;)b.insertBefore(c.removeChild(a),b.firstChild);else for(;a=c.firstChild;)b.appendChild(c.removeChild(a))},_4e_mergeSiblings:function(c){c=new n(c);u[c.nodeName()]&&(q(c,!0),q(c))},_4e_splitText:function(c,
b){var a=c.ownerDocument;if(c.nodeType==e.NodeType.TEXT_NODE){if(l.ie&&b==c.nodeValue.length){var d=a.createTextNode("");e.insertAfter(d,c);return d}d=c.splitText(b);a.documentMode&&(a=a.createTextNode(""),e.insertAfter(a,d),e.remove(a));return d}},_4e_parents:function(c,b){var a=[];a.__IS_NODELIST=1;do a[b?"push":"unshift"](c);while(c=c.parentNode);return a},_4e_nextSourceNode:function(c,b,a,d){if(d&&!d.call)var f=j(d),d=function(b){return b!==f};var b=!b&&c.firstChild,g=c;if(!b){if(c.nodeType==
m.ELEMENT_NODE&&d&&!1===d(c,!0))return null;b=c.nextSibling}for(;!b&&(g=g.parentNode);){if(d&&!1===d(g,!0))return null;b=g.nextSibling}return!b||d&&!1===d(b)?null:a&&a!=b.nodeType?e._4e_nextSourceNode(b,!1,a,d):b},_4e_previousSourceNode:function(c,b,a,d){if(d&&!d.call)var f=j(d),d=function(b){return b!==f};var b=!b&&c.lastChild,g=c;if(!b){if(c.nodeType==m.ELEMENT_NODE&&d&&!1===d(c,!0))return null;b=c.previousSibling}for(;!b&&(g=g.parentNode);){if(d&&!1===d(g,!0))return null;b=g.previousSibling}return!b||
d&&!1===d(b)?null:a&&b.nodeType!=a?e._4e_previousSourceNode(b,!1,a,d):b},_4e_commonAncestor:function(c,b){b=j(b);if(c===b)return c;if(e.contains(b,c))return b;var a=c;do if(e.contains(a,b))return a;while(a=a.parentNode);return null},_4e_hasAttributes:9>r.ieEngine?function(c){for(var b=c.attributes,a=0;a<b.length;a++){var d=b[a];switch(d.name){case "class":if(c.getAttribute("class"))return!0;break;default:if(d.specified)return!0}}return!1}:function(c){l.gecko&&c.removeAttribute("_moz_dirty");return c.hasAttributes()},
_4e_position:function(c,b){var a=j(b);if(c.compareDocumentPosition)return c.compareDocumentPosition(a);if(c==a)return o.POSITION_IDENTICAL;if(c.nodeType==m.ELEMENT_NODE&&a.nodeType==m.ELEMENT_NODE){if(e.contains(c,a))return o.POSITION_CONTAINS+o.POSITION_PRECEDING;if(e.contains(a,c))return o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING;if("sourceIndex"in c)return 0>c.sourceIndex||0>a.sourceIndex?o.POSITION_DISCONNECTED:c.sourceIndex<a.sourceIndex?o.POSITION_PRECEDING:o.POSITION_FOLLOWING}for(var d=
e._4e_address(c),a=e._4e_address(a),f=Math.min(d.length,a.length),g=0;g<=f-1;g++)if(d[g]!=a[g])return d[g]<a[g]?o.POSITION_PRECEDING:o.POSITION_FOLLOWING;return d.length<a.length?o.POSITION_CONTAINS+o.POSITION_PRECEDING:o.POSITION_IS_CONTAINED+o.POSITION_FOLLOWING},_4e_address:function(c,b){for(var a=[],d=c.ownerDocument.documentElement,f=c;f&&f!=d;)a.unshift(e._4e_index(f,b)),f=f.parentNode;return a},_4e_remove:function(c,b){var a=c.parentNode;if(a){if(b)for(var d;d=c.firstChild;)a.insertBefore(c.removeChild(d),
c);a.removeChild(c)}return c},_4e_trim:function(c){e._4e_ltrim(c);e._4e_rtrim(c)},_4e_ltrim:function(c){for(var b;b=c.firstChild;){if(b.nodeType==e.NodeType.TEXT_NODE){var a=r.ltrim(b.nodeValue),d=b.nodeValue.length;if(a)a.length<d&&(e._4e_splitText(b,d-a.length),c.removeChild(c.firstChild));else{c.removeChild(b);continue}}break}},_4e_rtrim:function(c){for(var b;b=c.lastChild;){if(b.type==e.NodeType.TEXT_NODE){var a=r.rtrim(b.nodeValue),d=b.nodeValue.length;if(a)a.length<d&&(e._4e_splitText(b,a.length),
c.removeChild(c.lastChild));else{c.removeChild(b);continue}}break}!l.ie&&!l.opera&&(b=c.lastChild)&&1==b.nodeType&&"br"==e.nodeName(b)&&c.removeChild(b)},_4e_appendBogus:function(c){for(var b=c.lastChild;b&&b.nodeType==e.NodeType.TEXT_NODE&&!a.trim(b.nodeValue);)b=b.previousSibling;if(!b||b.nodeType==e.NodeType.TEXT_NODE||"br"!==e.nodeName(b))b=l.opera?c.ownerDocument.createTextNode(""):c.ownerDocument.createElement("br"),l.gecko&&b.setAttribute("type","_moz"),c.appendChild(b)},_4e_setMarker:function(c,
b,e,d){var c=new n(c),f=c.data("list_marker_id")||c.data("list_marker_id",a.guid()).data("list_marker_id"),g=c.data("list_marker_names")||c.data("list_marker_names",{}).data("list_marker_names");b[f]=c;g[e]=1;return c.data(e,d)},_4e_clearMarkers:function(c,b,a){var c=new n(c),d=c.data("list_marker_names"),f=c.data("list_marker_id"),g;for(g in d)c.removeData(g);c.removeData("list_marker_names");a&&(c.removeData("list_marker_id"),delete b[f])},_4e_copyAttributes:function(c,b,a){for(var b=new n(b),d=
c.attributes,a=a||{},f=0;f<d.length;f++){var g=d[f],k=g.name.toLowerCase(),s;if(!(k in a))if("checked"==k&&(s=e.attr(c,k)))b.attr(k,s);else if(g.specified||l.ie&&g.value&&"value"==k)s=e.attr(c,k),null===s&&(s=g.nodeValue),b.attr(k,s)}""!==c.style.cssText&&(b[0].style.cssText=c.style.cssText)},_4e_isEditable:function(c){c=e.nodeName(c);return(c=!h.$nonEditable[c]&&(h[c]||h.span))&&c["#text"]},_4e_getByAddress:function(c,b,a){for(var c=c.documentElement,d=0;c&&d<b.length;d++){var f=b[d];if(a)for(var g=
-1,k=0;k<c.childNodes.length;k++){var s=c.childNodes[k];if(!(!0===a&&3==s.nodeType&&s.previousSibling&&3==s.previousSibling.nodeType)&&(g++,g==f)){c=s;break}}else c=c.childNodes[f]}return c}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/domIterator",function(a){function i(a){1>arguments.length||(this.range=a,this.forceBrBreak=q,this.enlargeBr=r,this.enforceRealBlocks=q,this._||(this._={}))}var r=!0,q=!1,p=a.Editor,h=a.UA,e=p.Walker,m=p.Range,l=p.RANGE,n=p.ElementPath,u=a.Node,o=a.DOM,w=/^[\r\n\t ]*$/;a.augment(i,{getNextParagraph:function(i){var j,c,b,t,d;if(!this._.lastNode){c=this.range.clone();c.shrink(l.SHRINK_ELEMENT,r);c.enlarge(this.forceBrBreak||!this.enlargeBr?l.ENLARGE_LIST_ITEM_CONTENTS:l.ENLARGE_BLOCK_CONTENTS);
var f=new e(c),g=e.bookmark(r,r);f.evaluator=g;this._.nextNode=f.next();f=new e(c);f.evaluator=g;f=f.previous();this._.lastNode=f._4e_nextSourceNode(r);this._.lastNode&&this._.lastNode[0].nodeType==o.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(g=new m(c.document),g.moveToPosition(this._.lastNode,l.POSITION_AFTER_END),g.checkEndOfBlock()&&(g=new n(g.endContainer),this._.lastNode=(g.block||g.blockLimit)._4e_nextSourceNode(r)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new u(c.document.createTextNode("")),o.insertAfter(this._.lastNode[0],f[0]));c=null}g=this._.nextNode;f=this._.lastNode;for(this._.nextNode=null;g;){var k=q,s=g[0].nodeType!=o.NodeType.ELEMENT_NODE,B=q;if(s)g[0].nodeType==o.NodeType.TEXT_NODE&&w.test(g[0].nodeValue)&&(s=q);else{var C=g.nodeName();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==C)s=r;else if(!c&&!g[0].childNodes.length&&"hr"!=C){j=g;b=g.equals(f);break}c&&(c.setEndAt(g,l.POSITION_BEFORE_START),
"br"!=C&&(this._.nextNode=g));k=r}else{if(g[0].firstChild){c||(c=new m(this.range.document),c.setStartAt(g,l.POSITION_BEFORE_START));g=new u(g[0].firstChild);continue}s=r}}s&&!c&&(c=new m(this.range.document),c.setStartAt(g,l.POSITION_BEFORE_START));b=(!k||s)&&g.equals(f);if(c&&!k)for(;!g[0].nextSibling&&!b;){C=g.parent();if(C._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){k=r;b||C.equals(f);break}g=C;s=r;b=g.equals(f);B=r}s&&c.setEndAt(g,l.POSITION_AFTER_END);g=g._4e_nextSourceNode(B,null,f);if((b=
!g)||k&&c)break}if(!j){if(!c)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;j=new n(c.startContainer);g=j.blockLimit;k={div:1,th:1,td:1};j=j.block;if((!j||!j[0])&&!this.enforceRealBlocks&&k[g.nodeName()]&&c.checkStartOfBlock()&&c.checkEndOfBlock())j=g;else if(!j||this.enforceRealBlocks&&"li"==j.nodeName())j=new u(this.range.document.createElement(i||"p")),j[0].appendChild(c.extractContents()),j._4e_trim(),c.insertNode(j),t=d=r;else if("li"!=j.nodeName()){if(!c.checkStartOfBlock()||
!c.checkEndOfBlock())j=j.clone(q),j[0].appendChild(c.extractContents()),j._4e_trim(),d=c.splitBlock(),t=!d.wasStartOfBlock,d=!d.wasEndOfBlock,c.insertNode(j)}else b||(this._.nextNode=j.equals(f)?null:c.getBoundaryNodes().endNode._4e_nextSourceNode(r,null,f))}t&&(c=new u(j[0].previousSibling),c[0]&&c[0].nodeType==o.NodeType.ELEMENT_NODE&&("br"==c.nodeName()?c._4e_remove():c[0].lastChild&&"br"==o.nodeName(c[0].lastChild)&&o._4e_remove(c[0].lastChild)));d&&(c=e.bookmark(q,r),t=new u(j[0].lastChild),
t[0]&&t[0].nodeType==o.NodeType.ELEMENT_NODE&&"br"==t.nodeName()&&(h.ie||t.prev(c,1)||t.next(c,1))&&t.remove());this._.nextNode||(this._.nextNode=b||j.equals(f)?null:j._4e_nextSourceNode(r,null,f));return j}});m.prototype.createIterator=function(){return new i(this)};return i},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/elementPath",function(a){function i(a){for(var n=h,i=h,o=[];a;){if(a[0].nodeType==q.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var w=a.nodeName();if(!i&&(!n&&e[w]&&(n=a),m[w])){var r;if(r=!n)if(r="div"==w){a:{r=a[0].childNodes;for(var j=0,c=r.length;j<c;j++){var b=r[j];if(b.nodeType==q.NodeType.ELEMENT_NODE&&p.$block[b.nodeName.toLowerCase()]){r=!0;break a}}r=!1}r=!r}r?n=a:i=a}o.push(a);if("body"==w)break}a=a.parent()}this.block=n;this.blockLimit=i;this.elements=
o}var r=a.Editor,q=a.DOM,p=r.XHTML_DTD,h=null,e={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},m={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};i.prototype={constructor:i,compare:function(a){var e=this.elements,a=a&&a.elements;if(!a||e.length!=a.length)return!1;for(var h=0;h<e.length;h++)if(!q.equals(e[h],a[h]))return!1;return!0},contains:function(a){for(var e=this.elements,m=0;m<e.length;m++)if(e[m].nodeName()in a)return e[m];return h},toString:function(){var a=
this.elements,e,h=[];for(e=0;e<a.length;e++)h.push(a[e].nodeName());return h.toString()}};return r.ElementPath=i},{requires:["./base","./dom"]});
KISSY.add("editor/core/enterKey",function(a,i,r,q){function p(h){var i;i=h.getSelection().getRanges();for(var p=i.length-1;0<p;p--)i[p].deleteContents();i=i[0];p=i.document;if(i.checkStartOfBlock()&&i.checkEndOfBlock()){var j=(new q(i.startContainer)).block;if(j&&("li"==j.nodeName()||"li"==j.parent().nodeName()))return h.hasCommand("outdent")?(h.execCommand("save"),h.execCommand("outdent"),h.execCommand("save"),!0):!1}var c=i.splitBlock("p");if(!c)return!0;var h=c.previousBlock,j=c.nextBlock,b=c.wasStartOfBlock,
t=c.wasEndOfBlock,d;if(j)d=j.parent(),"li"==d.nodeName()&&(j._4e_breakParent(d),j._4e_move(j.next(),!0));else if(h&&(d=h.parent())&&"li"==d.nodeName())h._4e_breakParent(d),i.moveToElementEditablePosition(h.next()),h._4e_move(h.prev());if(!b&&!t){if("li"==j.nodeName()&&(d=j.first(r.invisible(!0)))&&a.inArray(d.nodeName(),["ul","ol"]))(e.ie?new n(p.createTextNode("\u00a0")):new n(p.createElement("br"))).insertBefore(d);j&&i.moveToElementEditablePosition(j)}else{var f;if(h){if("li"==h.nodeName()||!m.test(h.nodeName()))f=
h.clone()}else j&&(f=j.clone());f||(f=new n("<p>",null,p));if(d=c.elementPath)for(var c=0,g=d.elements.length;c<g;c++){var k=d.elements[c];if(k.equals(d.block)||k.equals(d.blockLimit))break;l.$removeEmpty[k.nodeName()]&&(k=k.clone(),f._4e_moveChildren(k),f.append(k))}e.ie||f._4e_appendBogus();i.insertNode(f);if(e.ie&&b&&(!t||!h[0].childNodes.length))i.moveToElementEditablePosition(t?h:f),i.select();i.moveToElementEditablePosition(b&&!t?j:f)}e.ie||(j?(f=new n(p.createElement("span")),f.html("&nbsp;"),
i.insertNode(f),f.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),i.deleteContents()):f.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));i.select();return!0}function h(a){var e=a.get("document")[0];u.on(e,"keydown",function(e){if(13===e.keyCode&&!e.shiftKey&&!e.ctrlKey&&!e.metaKey){a.execCommand("save");var h=a.execCommand("enterBlock");a.execCommand("save");!1!==h&&e.preventDefault()}})}var e=a.UA,m=/^h[1-6]$/,l=i.XHTML_DTD,
n=a.Node,u=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:p});a.docReady(function(){h(a)})}}},{requires:["./base","./walker","./elementPath"]});
KISSY.add("editor/core/focusManager",function(a){function i(){var a=this;a.__iframeFocus=l;m=a;e&&clearTimeout(e);e=setTimeout(function(){a.fire("focus")},30)}function r(){var a=this;a.__iframeFocus=n;m=u;e&&clearTimeout(e);e=setTimeout(function(){a.fire("blur")},30)}var q=a.Editor,p=a.Event,h={},e,m,a={refreshAll:function(){for(var a in h){var e=h[a].get("document")[0];e.designMode="off";e.designMode="on"}},currentInstance:function(){return m},getInstance:function(a){return h[a]},add:function(a){var e=
a.get("window")[0];p.on(e,"focus",i,a);p.on(e,"blur",r,a)},register:function(a){h[a._UUID]=a},remove:function(a){delete h[a._UUID];var e=a.get("window")[0];p.remove(e,"focus",i,a);p.remove(e,"blur",r,a)}},l=!0,n=!1,u=null;a.refreshAll=a.refreshAll;q.focusManager=a;q.getInstances=function(){return h};return a},{requires:["./base","./dom"]});
KISSY.add("editor/core/htmlDataProcessor",function(a,i){return{init:function(r){function q(b){if((b.getAttribute("class")+"").match(/Apple-\w+-span/)||!b.attributes.length)b.setTagName(null);else if(!b.childNodes.length&&!b.attributes.length)return!1}function p(b){return b.replace(w,function(b,a,c){return"<"+a+c.replace(y,function(b,a){return-1==c.indexOf("_ke_saved_"+a)?" _ke_saved_"+b+" "+b:b})+">"})}function h(b){return b.replace(c,function(b){return"<ke:encoded>"+encodeURIComponent(b)+"</ke:encoded>"})}
function e(c){return c.replace(b,function(b,c){return a.urlDecode(c)})}var m=a.Node,l=a.UA,n=a.require("htmlparser"),u=new n.Filter,o=new n.Filter;(function(){function b(a){a=n.serialize(a);return new n.Comment(j+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var c={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:q}},d={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(b){if(b.attributes.length)for(var a=
["name","href","src"],c,d=0;d<a.length;d++)c="_ke_saved_"+a[d],b.getAttribute(c)&&b.removeAttribute(a[d]);return b},embed:function(b){var a=b.parentNode;if(a&&"object"==a.nodeName){var c=a.getAttribute("width"),a=a.getAttribute("height");c&&b.setAttribute("width",c);a&&b.setAttribute("width",a)}},a:function(b){if(!b.childNodes.length&&!b.attributes.length)return!1},span:q},attributes:{style:function(b){if(!a.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],[/^_ke.*/,""],[/^ke:.*$/,
""],[/^_ks.*/,""]],text:function(b){if(l.webkit)return b.replace(/\u200b/g,"")},comment:function(b){if(b.substr(0,j.length)==j)return b=a.trim(a.urlDecode(b.substr(j.length))),n.parse(b).childNodes[0]}};l.ie&&(d.attributes.style=function(b){return b.replace(/(^|;)([^:]+)/g,function(b){return b.toLowerCase()})});u.addRules(d);o.addRules(c)})();(function(){function b(c){for(var c=c.childNodes,d=c.length,f=c[d-1];f&&3==f.nodeType&&!a.trim(f.nodeValue);)f=c[--d];return f}function c(a,d){var f=b(a);f&&
((d||!l.ie)&&1==f.nodeType&&"br"==f.nodeName?a.removeChild(f):3==f.nodeType&&h.test(f.nodeValue)&&a.removeChild(f))}function d(a){var c=b(a);return!c||1==c.nodeType&&"br"==c.nodeName||"form"==a.nodeName&&"input"==c.nodeName}function f(b){c(b,!0);d(b)&&(l.ie?b.appendChild(new n.Text("\u00a0")):(b.appendChild(new n.Text("&nbsp;")),b.appendChild(new n.Tag("br"))))}function e(b){c(b,!1);d(b)&&b.appendChild(new n.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,j=i.XHTML_DTD,v=a.merge(j.$block,j.$listItem,j.$tableContent),
D;for(D in v)"br"in j[D]||delete v[D];delete v.td;delete v.pre;var j={tags:{}},x={tags:{}};for(D in v)j.tags[D]=f,x.tags[D]=e;o.addRules(j);u.addRules(x)})();u.addRules({text:function(b){return b.replace(/\xa0/g,"&nbsp;")}});var w=/<(a|area|img|input)\b([^>]*)>/gi,y=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,j="{ke_protected}",c=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,b=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,
t=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,d=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,f=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;r.htmlDataProcessor={dataFilter:o,htmlFilter:u,toHTML:function(b){var a=new n.BeautifyWriter;(new n.Parser(b)).parse().writeHTML(a,u);return b=a.getHTML()},toDataFormat:function(b,a){var a=a||o,b=h(b),b=p(b),b=b.replace(t,"$1ke:$2"),b=b.replace(f,"<ke:$1$2></ke:$1>"),c=new m("<div>");c.html("a"+
b);b=c.html().substr(1);b=b.replace(d,"$1$2");b=e(b);c=new n.BasicWriter;(new n.Parser(b)).parse().writeHTML(c,a);return b=c.getHTML()},toServer:function(b){var a=new n.MinifyWriter;(new n.Parser(b)).parse().writeHTML(a,u);return a.getHTML()}}}}},{requires:["./base"]});
(function(a){a({"editor/plugin/back-color":{requires:["editor","editor/plugin/color/btn"]}});a({"editor/plugin/back-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/bold":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/bold/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/bubble":{requires:["overlay","editor"]}});a({"editor/plugin/button":{requires:["editor","button"]}});a({"editor/plugin/checkbox-source-area":{requires:["editor"]}});a({"editor/plugin/code":{requires:["editor",
"editor/plugin/dialog-loader"]}});a({"editor/plugin/code/dialog":{requires:["editor","editor/plugin/dialog","menubutton"]}});a({"editor/plugin/color/btn":{requires:["editor","editor/plugin/button","editor/plugin/overlay","editor/plugin/dialog-loader"]}});a({"editor/plugin/color/cmd":{requires:["editor"]}});a({"editor/plugin/color/dialog":{requires:["editor","editor/plugin/dialog"]}});a({"editor/plugin/contextmenu":{requires:["editor","menu","editor/plugin/focus-fix"]}});a({"editor/plugin/dent-cmd":{requires:["editor",
"editor/plugin/list-utils"]}});a({"editor/plugin/dialog-loader":{requires:["overlay","editor"]}});a({"editor/plugin/dialog":{requires:["editor","overlay","editor/plugin/focus-fix","dd/plugin/constrain","component/plugin/drag"]}});a({"editor/plugin/draft":{requires:["editor","editor/plugin/local-storage","overlay","editor/plugin/menubutton"]}});a({"editor/plugin/drag-upload":{requires:["editor"]}});a({"editor/plugin/element-path":{requires:["editor"]}});a({"editor/plugin/fake-objects":{requires:["editor"]}});
a({"editor/plugin/flash-bridge":{requires:["swf","editor"]}});a({"editor/plugin/flash-common/base-class":{requires:["editor","editor/plugin/contextmenu","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/flash-common/utils"]}});a({"editor/plugin/flash-common/utils":{requires:["swf"]}});a({"editor/plugin/flash":{requires:["editor","editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/flash/dialog":{requires:["editor",
"editor/plugin/flash-common/utils","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/focus-fix":{requires:["editor"]}});a({"editor/plugin/font-family":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/font-family/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font-size":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/font-size/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/font/cmd":{requires:["editor"]}});
a({"editor/plugin/font/ui":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/fore-color":{requires:["editor","editor/plugin/color/btn"]}});a({"editor/plugin/fore-color/cmd":{requires:["editor/plugin/color/cmd"]}});a({"editor/plugin/heading":{requires:["editor"]}});a({"editor/plugin/heading/cmd":{requires:["editor"]}});a({"editor/plugin/image":{requires:["editor","editor/plugin/button","editor/plugin/bubble","editor/plugin/contextmenu","editor/plugin/dialog-loader"]}});
a({"editor/plugin/image/dialog":{requires:["io","editor","editor/plugin/dialog","tabs","editor/plugin/menubutton"]}});a({"editor/plugin/indent":{requires:["editor"]}});a({"editor/plugin/indent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/italic":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/italic/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/justify-center":{requires:["editor"]}});a({"editor/plugin/justify-center/cmd":{requires:["editor/plugin/justify-cmd"]}});
a({"editor/plugin/justify-cmd":{requires:["editor"]}});a({"editor/plugin/justify-left":{requires:["editor"]}});a({"editor/plugin/justify-left/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/justify-right":{requires:["editor"]}});a({"editor/plugin/justify-right/cmd":{requires:["editor/plugin/justify-cmd"]}});a({"editor/plugin/link":{requires:["editor","editor/plugin/bubble","editor/plugin/dialog-loader","editor/plugin/button"]}});a({"editor/plugin/link/dialog":{requires:["editor",
"editor/plugin/dialog","editor/plugin/link/utils"]}});a({"editor/plugin/link/utils":{requires:["editor"]}});a({"editor/plugin/list-utils":{requires:["editor"]}});a({"editor/plugin/list-utils/btn":{requires:["editor","editor/plugin/button","editor/plugin/menubutton"]}});a({"editor/plugin/list-utils/cmd":{requires:["editor","editor/plugin/list-utils"]}});a({"editor/plugin/local-storage":{requires:["editor","overlay","editor/plugin/flash-bridge"]}});a({"editor/plugin/maximize":{requires:["editor"]}});
a({"editor/plugin/maximize/cmd":{requires:["editor"]}});a({"editor/plugin/menubutton":{requires:["editor","menubutton"]}});a({"editor/plugin/multiple-upload":{requires:["editor","editor/plugin/dialog-loader"]}});a({"editor/plugin/multiple-upload/dialog":{requires:"editor,component/plugin/drag,editor/plugin/progressbar,editor/plugin/dialog,editor/plugin/flash-bridge,editor/plugin/local-storage,swf".split(",")}});a({"editor/plugin/ordered-list":{requires:["editor","editor/plugin/list-utils/btn"]}});
a({"editor/plugin/ordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/outdent":{requires:["editor"]}});a({"editor/plugin/outdent/cmd":{requires:["editor","editor/plugin/dent-cmd"]}});a({"editor/plugin/overlay":{requires:["editor","overlay","editor/plugin/focus-fix"]}});a({"editor/plugin/page-break":{requires:["editor","editor/plugin/fake-objects"]}});a({"editor/plugin/remove-format":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/remove-format/cmd":{requires:["editor"]}});
a({"editor/plugin/resize":{requires:["editor","dd/base"]}});a({"editor/plugin/separator":{requires:["editor"]}});a({"editor/plugin/smiley":{requires:["editor","editor/plugin/overlay"]}});a({"editor/plugin/source-area":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/strike-through":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/strike-through/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/table":{requires:["editor","editor/plugin/dialog-loader",
"editor/plugin/contextmenu"]}});a({"editor/plugin/table/dialog":{requires:["editor","editor/plugin/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/underline":{requires:["editor","editor/plugin/font/ui"]}});a({"editor/plugin/underline/cmd":{requires:["editor","editor/plugin/font/cmd"]}});a({"editor/plugin/undo":{requires:["editor"]}});a({"editor/plugin/undo/btn":{requires:["editor","editor/plugin/button"]}});a({"editor/plugin/undo/cmd":{requires:["editor"]}});a({"editor/plugin/unordered-list":{requires:["editor",
"editor/plugin/list-utils/btn"]}});a({"editor/plugin/unordered-list/cmd":{requires:["editor","editor/plugin/list-utils/cmd"]}});a({"editor/plugin/video":{requires:["editor","editor/plugin/flash-common/utils","editor/plugin/flash-common/base-class","editor/plugin/fake-objects"]}});a({"editor/plugin/video/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}});a({"editor/plugin/word-filter":{requires:["htmlparser"]}});a({"editor/plugin/xiami-music":{requires:["editor",
"editor/plugin/flash-common/base-class","editor/plugin/flash-common/utils","editor/plugin/fake-objects"]}});a({"editor/plugin/xiami-music/dialog":{requires:["editor","editor/plugin/flash/dialog","editor/plugin/menubutton"]}})})(function(a){KISSY.config("modules",a)},KISSY.Features,KISSY.UA);
KISSY.add("editor/core/range",function(a,i,r,q,p){function h(c){var f=c.nodeType!=b.NodeType.TEXT_NODE&&b.nodeName(c)in d.$removeEmpty,g=c.nodeType==b.NodeType.TEXT_NODE&&!a.trim(c.nodeValue),c=!!c.parentNode.getAttribute("_ke_bookmark");return f||g||c}function e(b){return!s(b)&&!B(b)}function m(c){var d=w;return function(f){if(B(f))return o;if(f.nodeType==b.NodeType.TEXT_NODE){if(a.trim(f.nodeValue).length)return w}else if(f.nodeType==b.NodeType.ELEMENT_NODE&&(f=b.nodeName(f),!E[f]))if(!c&&!t.ie&&
"br"==f&&!d)d=o;else return w;return o}}function l(a,c){var d=a.startContainer,g=a.endContainer,e=a.startOffset,k=a.endOffset,h,s=w,j=w,m=void 0,i=a.document,l;0<c&&(m=i.createDocumentFragment());if(a.collapsed)return m;a.optimizeBookmark();g[0].nodeType==b.NodeType.TEXT_NODE?(j=o,g=g._4e_splitText(k)):0<g[0].childNodes.length&&(k>=g[0].childNodes.length?(g=new f(g[0].appendChild(i.createTextNode(""))),l=o):g=new f(g[0].childNodes[k]));d[0].nodeType==b.NodeType.TEXT_NODE?(s=o,d._4e_splitText(e)):
e?e>=d[0].childNodes.length?(d=new f(d[0].appendChild(i.createTextNode(""))),h=o):d=new f(d[0].childNodes[e].previousSibling):(h=new f(i.createTextNode("")),d.prepend(h),d=h,h=o);var H=d._4e_parents(),J=g._4e_parents();H.each(function(b,a){H[a]=b});J.each(function(b,a){J[a]=b});for(var F,M,i=0;i<H.length&&!(F=H[i],M=J[i],!F.equals(M));i++);for(var e=m,A,I,n=i;n<H.length;n++){A=H[n];k=0<c&&!A.equals(d)?e.appendChild(A.clone()[0]):null;A=A[0].nextSibling;I=J[n];for(var B=g[0],t=I&&I[0];A&&!(t==A||B==
A);)I=A.nextSibling,2==c?e.appendChild(A.cloneNode(o)):(b._4e_remove(A),1==c&&e.appendChild(A)),A=I;k&&(e=k)}for(e=m;i<J.length;i++){A=J[i];k=0<c&&!A.equals(g)?e.appendChild(A.clone()[0]):null;if(!H[i]||!A._4e_sameLevel(H[i]))for(A=A[0].previousSibling;A;)I=A.previousSibling,2==c?e.insertBefore(A.cloneNode(o),e.firstChild):(b._4e_remove(A),1==c&&e.insertBefore(A,e.firstChild)),A=I;k&&(e=k)}if(2==c){if(s&&(F=d[0],F.nodeType==b.NodeType.TEXT_NODE&&F.nextSibling&&F.nextSibling.nodeType==b.NodeType.TEXT_NODE&&
(F.data+=F.nextSibling.data,F.parentNode.removeChild(F.nextSibling))),j)j=g[0],j.nodeType==b.NodeType.TEXT_NODE&&j.previousSibling&&j.previousSibling.nodeType==b.NodeType.TEXT_NODE&&(j.previousSibling.data+=j.data,j.parentNode.removeChild(j))}else{if(F&&M&&(!d._4e_sameLevel(F)||!g._4e_sameLevel(M)))j=F._4e_index(),h&&F._4e_sameLevel(d)&&j--,a.setStart(F.parent(),j+1);a.collapse(o)}h&&d.remove();l&&g.remove();return m}function n(b){b.collapsed=b.startContainer&&b.endContainer&&b.startContainer[0]==
b.endContainer[0]&&b.startOffset==b.endOffset}function u(b){this.endOffset=this.endContainer=this.startOffset=this.startContainer=y;this.collapsed=o;this.document=b}i.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var o=!0,w=!1,y=null,j=i.RANGE,c=i.POSITION,b=a.DOM,t=a.UA,d=i.XHTML_DTD,f=a.Node,g=f.all,k={area:1,base:1,br:1,col:1,hr:1,
img:1,input:1,link:1,meta:1,param:1},s=new q.whitespaces,B=new q.bookmark,C=q.whitespaces(o),z=q.bookmark(!1,!0),E={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(u,{toString:function(){var b=[],a=this.startContainer[0],c=this.endContainer[0];b.push((a.id||a.nodeName)+":"+this.startOffset);b.push((c.id||c.nodeName)+":"+this.endOffset);return b.join("<br/>")},optimize:function(){var a=
this.startContainer,c=this.startOffset;a[0].nodeType!=b.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;c=this.endOffset;a[0].nodeType!=b.NodeType.ELEMENT_NODE&&(c?c>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(b){this.setStart(b.parent(),b._4e_index()+1)},setStartBefore:function(b){this.setStart(b.parent(),b._4e_index())},setEndAfter:function(b){this.setEnd(b.parent(),b._4e_index()+
1)},setEndBefore:function(b){this.setEnd(b.parent(),b._4e_index())},optimizeBookmark:function(){var b=this.startContainer,a=this.endContainer;b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setStartBefore(b);a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setEndAfter(a)},setStart:function(a,c){a[0].nodeType==b.NodeType.ELEMENT_NODE&&k[a.nodeName()]&&(a=a.parent(),c=a._4e_index());this.startContainer=a;this.startOffset=c;this.endContainer||(this.endContainer=a,this.endOffset=c);n(this)},
setEnd:function(a,c){a[0].nodeType==b.NodeType.ELEMENT_NODE&&k[a.nodeName()]&&(a=a.parent(),c=a._4e_index()+1);this.endContainer=a;this.endOffset=c;this.startContainer||(this.startContainer=a,this.startOffset=c);n(this)},setStartAt:function(a,c){switch(c){case j.POSITION_AFTER_START:this.setStart(a,0);break;case j.POSITION_BEFORE_END:a[0].nodeType==b.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setStartBefore(a);
break;case j.POSITION_AFTER_END:this.setStartAfter(a)}n(this)},setEndAt:function(a,c){switch(c){case j.POSITION_AFTER_START:this.setEnd(a,0);break;case j.POSITION_BEFORE_END:a[0].nodeType==b.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case j.POSITION_BEFORE_START:this.setEndBefore(a);break;case j.POSITION_AFTER_END:this.setEndAfter(a)}n(this)},cloneContents:function(){return l(this,2)},deleteContents:function(){return l(this,0)},extractContents:function(){return l(this,
1)},collapse:function(b){b?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=o},clone:function(){var b=new u(this.document);b.startContainer=this.startContainer;b.startOffset=this.startOffset;b.endContainer=this.endContainer;b.endOffset=this.endOffset;b.collapsed=this.collapsed;return b},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=b.NodeType.ELEMENT_NODE||
a.endContainer[0].nodeType!=b.NodeType.ELEMENT_NODE)return y;var c=new q(a);c.evaluator=function(b){return C(b)&&z(b)};a=c.next();c.reset();c=c.previous();return a&&a.equals(c)?a:y},shrink:function(a,c){if(!this.collapsed){var a=a||j.SHRINK_TEXT,d=this.clone(),f=this.startContainer,g=this.endContainer,e=this.startOffset,k=this.endOffset,h=o,s,i,m=o;f&&f[0].nodeType==b.NodeType.TEXT_NODE&&(e?e>=f[0].nodeValue.length?d.setStartAfter(f):(d.setStartBefore(f),h=w):d.setStartBefore(f));g&&g[0].nodeType==
b.NodeType.TEXT_NODE&&(k?k>=g[0].nodeValue.length?d.setEndAfter(g):(d.setEndAfter(g),m=w):d.setEndBefore(g));if(h||m)i=new q(d),i.evaluator=function(c){return c.nodeType==(a==j.SHRINK_ELEMENT?b.NodeType.ELEMENT_NODE:b.NodeType.TEXT_NODE)},i.guard=function(c,d){if(a==j.SHRINK_ELEMENT&&c.nodeType==b.NodeType.TEXT_NODE||d&&c==s)return w;!d&&c.nodeType==b.NodeType.ELEMENT_NODE&&(s=c);return o};h&&(d=i[a==j.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(d,c?j.POSITION_AFTER_START:j.POSITION_BEFORE_START);
m&&(i.reset(),(i=i[a==j.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(i,c?j.POSITION_BEFORE_END:j.POSITION_AFTER_END));return h||m}},createBookmark2:function(a){var c=this.startContainer,d=this.endContainer,g=this.startOffset,e=this.endOffset,k,h;if(!c||!d)return{start:0,end:0};if(a){if(c[0].nodeType==b.NodeType.ELEMENT_NODE&&(k=new f(c[0].childNodes[g]))&&k[0]&&k[0].nodeType==b.NodeType.TEXT_NODE&&0<g&&k[0].previousSibling.nodeType==b.NodeType.TEXT_NODE)c=k,g=0;for(;c[0].nodeType==
b.NodeType.TEXT_NODE&&(h=c.prev(void 0,1))&&h[0].nodeType==b.NodeType.TEXT_NODE;)c=h,g+=h[0].nodeValue.length;if(!this.collapsed){if(d[0].nodeType==b.NodeType.ELEMENT_NODE&&(k=new f(d[0].childNodes[e]))&&k[0]&&k[0].nodeType==b.NodeType.TEXT_NODE&&0<e&&k[0].previousSibling.nodeType==b.NodeType.TEXT_NODE)d=k,e=0;for(;d[0].nodeType==b.NodeType.TEXT_NODE&&(h=d.prev(void 0,1))&&h[0].nodeType==b.NodeType.TEXT_NODE;)d=h,e+=h[0].nodeValue.length}}return{start:c._4e_address(a),end:this.collapsed?y:d._4e_address(a),
startOffset:g,endOffset:e,normalized:a,is2:o}},createBookmark:function(b){var c,d,g,e,k=this.collapsed;c=new f("<span>",y,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");b&&(g=a.guid("ke_bm_"),c.attr("id",g+"S"));k||(d=c.clone(),d.html("&nbsp;"),b&&d.attr("id",g+"E"),e=this.clone(),e.collapse(),e.insertNode(d));e=this.clone();e.collapse(o);e.insertNode(c);d?(this.setStartAfter(c),this.setEndBefore(d)):this.moveToPosition(c,j.POSITION_AFTER_END);return{startNode:b?
g+"S":c,endNode:b?g+"E":d,serializable:b,collapsed:k}},moveToPosition:function(b,a){this.setStartAt(b,a);this.collapse(o)},trim:function(a,c){var d=this.startContainer,f=this.startOffset,g=this.collapsed;if((!a||g)&&d[0]&&d[0].nodeType==b.NodeType.TEXT_NODE){if(f)if(f>=d[0].nodeValue.length)f=d._4e_index()+1,d=d.parent();else{var e=d._4e_splitText(f),f=d._4e_index()+1,d=d.parent();b.equals(this.startContainer,this.endContainer)?this.setEnd(e,this.endOffset-this.startOffset):b.equals(d,this.endContainer)&&
(this.endOffset+=1)}else f=d._4e_index(),d=d.parent();this.setStart(d,f);if(g){this.collapse(o);return}}d=this.endContainer;f=this.endOffset;!c&&!g&&d[0]&&d[0].nodeType==b.NodeType.TEXT_NODE&&(f?(f>=d[0].nodeValue.length||d._4e_splitText(f),f=d._4e_index()+1):f=d._4e_index(),d=d.parent(),this.setEnd(d,f))},insertNode:function(b){this.optimizeBookmark();this.trim(w,o);var a=this.startContainer;a[0].insertBefore(b[0],a[0].childNodes[this.startOffset]||null);a[0]==this.endContainer[0]&&this.endOffset++;
this.setStartBefore(b)},moveToBookmark:function(b){var c=g(this.document);if(b.is2){var d=c._4e_getByAddress(b.start,b.normalized),f=b.startOffset,c=b.end&&c._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(d,f);c?this.setEnd(c,b):this.collapse(o)}else d=(f=b.serializable)?a.one("#"+b.startNode,c):b.startNode,b=f?a.one("#"+b.endNode,c):b.endNode,this.setStartBefore(d),d._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(o)},getCommonAncestor:function(a,c){var d=
this.startContainer,g=this.endContainer,d=d[0]==g[0]?a&&d[0].nodeType==b.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new f(d[0].childNodes[this.startOffset]):d:d._4e_commonAncestor(g);return c&&d[0].nodeType==b.NodeType.TEXT_NODE?d.parent():d},enlarge:function(){function a(c,d,f,e){var k=c[d?"startContainer":"endContainer"],h,j=d?0:1,v=0,i=d?"previousSibling":"nextSibling";h=c[d?"startOffset":"endOffset"];if(k[0].nodeType==b.NodeType.TEXT_NODE){if(d){if(h)return}else if(h<k[0].nodeValue.length)return;
h=k[0][i];k=k[0].parentNode}else h=k[0].childNodes[h+(d?-1:1)]||null,k=k[0];for(;k;){for(;h;)if(s(h)||B(h))h=h[i];else break;if(h){if(!v)c[d?"setStartAfter":"setEndBefore"](g(h));break}k=g(k);if("body"==k.nodeName())break;if(v||k.equals(e))f[j]=k,v=1;else c[d?"setStartBefore":"setEndAfter"](k);h=k[0][i];k=k[0].parentNode}}return function(c){switch(c){case j.ENLARGE_ELEMENT:if(this.collapsed)break;var c=this.getCommonAncestor(),d=[];a(this,1,d,c);a(this,0,d,c);d[0]&&d[1]&&(c=d[0].contains(d[1])?d[1]:
d[0],this.setStartBefore(c),this.setEndAfter(c));break;case j.ENLARGE_BLOCK_CONTENTS:case j.ENLARGE_LIST_ITEM_CONTENTS:var k=new u(this.document),d=new f(this.document.body);k.setStartAt(d,j.POSITION_AFTER_START);k.setEnd(this.startContainer,this.startOffset);var k=new q(k),e,h,s=q.blockBoundary(c==j.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:y),i=function(b){var a=s(b);a||(e=g(b));return a},m=function(a){var c=i(a);!c&&"br"==b.nodeName(a)&&(h=g(a));return c};k.guard=i;k=k.lastBackward();e=e||d;this.setStartAt(e,
"br"!=e.nodeName()&&(!k&&this.checkStartOfBlock()||k&&e.contains(k))?j.POSITION_AFTER_START:j.POSITION_AFTER_END);k=this.clone();k.collapse();k.setEndAt(d,j.POSITION_BEFORE_END);k=new q(k);k.guard=c==j.ENLARGE_LIST_ITEM_CONTENTS?m:i;e=y;k=k.lastForward();e=e||d;this.setEndAt(e,!k&&this.checkEndOfBlock()||k&&e.contains(k)?j.POSITION_BEFORE_END:j.POSITION_BEFORE_START);h&&this.setEndAfter(h)}}}(),checkStartOfBlock:function(){var c=this.startContainer,d=this.startOffset;if(d&&c[0].nodeType==b.NodeType.TEXT_NODE&&
a.trim(c[0].nodeValue.substring(0,d)).length)return w;this.trim();c=new p(this.startContainer);d=this.clone();d.collapse(o);d.setStartAt(c.block||c.blockLimit,j.POSITION_AFTER_START);c=new q(d);c.evaluator=m(o);return c.checkBackward()},checkEndOfBlock:function(){var c=this.endContainer,d=this.endOffset;if(c[0].nodeType==b.NodeType.TEXT_NODE&&a.trim(c[0].nodeValue.substring(d)).length)return w;this.trim();c=new p(this.endContainer);d=this.clone();d.collapse(w);d.setEndAt(c.block||c.blockLimit,j.POSITION_BEFORE_END);
c=new q(d);c.evaluator=m(w);return c.checkForward()},checkBoundaryOfElement:function(b,c){var a=this.clone();a[c==j.START?"setStartAt":"setEndAt"](b,c==j.START?j.POSITION_AFTER_START:j.POSITION_BEFORE_END);a=new q(a);a.evaluator=h;return a[c==j.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,d=this.endContainer,f=this.startOffset,k=this.endOffset,e;if(a[0].nodeType==b.NodeType.ELEMENT_NODE)if(e=a[0].childNodes.length,e>f)a=g(a[0].childNodes[f]);else if(0==
e)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=g(a);a=a._4e_nextSourceNode()||a}if(d[0].nodeType==b.NodeType.ELEMENT_NODE)if(e=d[0].childNodes.length,e>k)d=g(d[0].childNodes[k])._4e_previousSourceNode(o);else if(0==e)d=d._4e_previousSourceNode();else{for(d=d[0];d.lastChild;)d=d.lastChild;d=g(d)}a._4e_position(d)&c.POSITION_FOLLOWING&&(a=d);return{startNode:a,endNode:d}},fixBlock:function(b,a){var c=this.createBookmark(),d=g(this.document.createElement(a));this.collapse(b);
this.enlarge(j.ENLARGE_BLOCK_CONTENTS);d[0].appendChild(this.extractContents());d._4e_trim();t.ie||d._4e_appendBogus();this.insertNode(d);this.moveToBookmark(c);return d},splitBlock:function(b){var c=new p(this.startContainer),d=new p(this.endContainer),f=c.block,g=d.block,k=y;if(!c.blockLimit.equals(d.blockLimit))return y;"br"!=b&&(f||(f=this.fixBlock(o,b),g=(new p(this.endContainer)).block),g||(g=this.fixBlock(w,b)));b=f&&this.checkStartOfBlock();c=g&&this.checkEndOfBlock();this.deleteContents();
f&&f[0]==g[0]&&(c?(k=new p(this.startContainer),this.moveToPosition(g,j.POSITION_AFTER_END),g=y):b?(k=new p(this.startContainer),this.moveToPosition(f,j.POSITION_BEFORE_START),f=y):(g=this.splitElement(f),!t.ie&&!a.inArray(f.nodeName(),["ul","ol"])&&f._4e_appendBogus()));return{previousBlock:f,nextBlock:g,wasStartOfBlock:b,wasEndOfBlock:c,elementPath:k}},splitElement:function(b){if(!this.collapsed)return y;this.setEndAt(b,j.POSITION_BEFORE_END);var a=this.extractContents(),c=b.clone(w);c[0].appendChild(a);
c.insertAfter(b);this.moveToPosition(b,j.POSITION_AFTER_END);return c},moveToElementEditablePosition:function(a,c){for(var d=0;a;){if(a[0].nodeType==b.NodeType.TEXT_NODE){this.moveToPosition(a,c?j.POSITION_AFTER_END:j.POSITION_BEFORE_START);d=1;break}a[0].nodeType==b.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,c?j.POSITION_BEFORE_END:j.POSITION_AFTER_START),d=1);var f=a,g=d,k=void 0;f[0].nodeType==b.NodeType.ELEMENT_NODE&&f._4e_isEditable()&&(k=f[c?"last":"first"](e,1));!g&&
!k&&(k=f[c?"prev":"next"](e,1));a=k}return!!d},selectNodeContents:function(a){var c=a[0];this.setStart(a,0);this.setEnd(a,c.nodeType==b.NodeType.TEXT_NODE?c.nodeValue.length:c.childNodes.length)},insertNodeByDtd:function(b){var a,c,f,g=b.nodeName();a=d.$block[g];this.deleteContents();if(a){for(a=this.getCommonAncestor(w,o);(c=d[a.nodeName()])&&(!c||!c[g]);){var k=a.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(a),this.collapse(o),a.remove()):f=a;a=k}f&&this.splitElement(f)}this.insertNode(b)}});
r.injectDom({_4e_breakParent:function(b,a){var a=g(a),b=g(b),c,d=new i.Range(b[0].ownerDocument);d.setStartAfter(b);d.setEndAfter(a);c=d.extractContents();d.insertNode(b.remove());b.after(c)}});return i.Range=u},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(a){function i(b){this.document=b;this._={cache:{}};if(o)try{var a=this.getNative().createRange();if(!a||a.item&&a.item(0).ownerDocument!=b||a.parentElement&&a.parentElement().ownerDocument!=b)this.isInvalid=p}catch(c){this.isInvalid=p}}function r(b){b=new i(b);return!b||b.isInvalid?h:b}var q=a.Editor;q.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var p=!0,h=null,e=a.UA,m=a.DOM,l=a.Node,n=q.SELECTION,u=q.RANGE,o=e.ie,w=q.Walker,y=q.Range,
j={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(i,{getNative:!o?function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=m.getWindow(this.document).getSelection())}:function(){var b=this._.cache;return b.nativeSel||(b.nativeSel=this.document.selection)},getType:!o?function(){var b=this._.cache;if(b.type)return b.type;var a=n.SELECTION_TEXT,c=this.getNative();if(c){if(1==c.rangeCount){var c=
c.getRangeAt(0),k=c.startContainer;k==c.endContainer&&k.nodeType==m.NodeType.ELEMENT_NODE&&1==Number(c.endOffset-c.startOffset)&&j[k.childNodes[c.startOffset].nodeName.toLowerCase()]&&(a=n.SELECTION_ELEMENT)}}else a=n.SELECTION_NONE;return b.type=a}:function(){var b=this._.cache;if(b.type)return b.type;var a=n.SELECTION_NONE;try{var c=this.getNative(),k=c.type;"Text"==k&&(a=n.SELECTION_TEXT);"Control"==k&&(a=n.SELECTION_ELEMENT);c.createRange().parentElement&&(a=n.SELECTION_TEXT)}catch(e){}return b.type=
a},getRanges:o?function(){var b=function(b,a){b=b.duplicate();b.collapse(a);for(var c=b.parentElement(),d=c.childNodes,e,j=0;j<d.length;j++){var i=d[j];if(i.nodeType==m.NodeType.ELEMENT_NODE){e=b.duplicate();e.moveToElementText(i);var i=e.compareEndPoints("StartToStart",b),l=e.compareEndPoints("EndToStart",b);e.collapse();if(0<i)break;else{if(!i||1==l&&-1==i)return{container:c,offset:j};if(!l)return{container:c,offset:j+1}}e=h}}e||(e=b.duplicate(),e.moveToElementText(c),e.collapse(!1));e.setEndPoint("StartToStart",
b);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=d[--j].nodeValue.length}catch(n){e=0}return 0===e?{container:c,offset:j}:{container:d[j],offset:-e}};return function(a){var c=this._.cache;if(c.ranges&&!a)return c.ranges;var e=this.getNative(),a=e&&e.createRange(),h=this.getType();if(!e)return[];if(h==n.SELECTION_TEXT)return e=new y(this.document),h=b(a,p),e.setStart(new l(h.container),h.offset),h=b(a),e.setEnd(new l(h.container),h.offset),c.ranges=[e];if(h==n.SELECTION_ELEMENT){c=
c.ranges=[];for(h=0;h<a.length;h++){for(var j=a.item(h),i=j.parentNode,m=0,e=new y(this.document);m<i.childNodes.length&&i.childNodes[m]!=j;m++);e.setStart(new l(i),m);e.setEnd(new l(i),m+1);c.push(e)}return c}return c.ranges=[]}}():function(b){var a=this._.cache;if(a.ranges&&!b)return a.ranges;var b=[],c=this.getNative();if(!c)return[];for(var e=0;e<c.rangeCount;e++){var h=c.getRangeAt(e),j=new y(this.document);j.setStart(new l(h.startContainer),h.startOffset);j.setEnd(new l(h.endContainer),h.endOffset);
b.push(j)}return a.ranges=b},getStartElement:function(){var b=this._.cache;if(void 0!==b.startElement)return b.startElement;var a,c=this.getNative();switch(this.getType()){case n.SELECTION_ELEMENT:return this.getSelectedElement();case n.SELECTION_TEXT:var e=this.getRanges()[0];if(e&&!e.collapsed){for(e.optimize();p;)if(a=e.startContainer,e.startOffset==(a[0].nodeType===m.NodeType.ELEMENT_NODE?a[0].childNodes.length:a[0].nodeValue.length)&&!a._4e_isBlockBoundary())e.setStartAfter(a);else break;a=e.startContainer;
if(a[0].nodeType!=m.NodeType.ELEMENT_NODE)return a.parent();a=new l(a[0].childNodes[e.startOffset]);if(!a[0]||a[0].nodeType!=m.NodeType.ELEMENT_NODE)return e.startContainer;for(e=a[0].firstChild;e&&e.nodeType==m.NodeType.ELEMENT_NODE;)a=new l(e),e=e.firstChild;return a}if(o)e=c.createRange(),e.collapse(p),a=new l(e.parentElement());else{if((a=c.anchorNode)&&a.nodeType!=m.NodeType.ELEMENT_NODE)a=a.parentNode;a&&(a=new l(a))}}return b.startElement=a},getSelectedElement:function(){var b,a=this._.cache;
if(void 0!==a.selectedElement)return a.selectedElement;o&&(b=this.getNative().createRange(),b=b.item&&b.item(0));var c;if(b)c=new l(b);else{b=this.getRanges()[0];for(var e,h=2;h&&(!(c=b.getEnclosedNode())||!(c[0].nodeType==m.NodeType.ELEMENT_NODE&&j[c.nodeName()]&&(e=c)));h--)b.shrink(u.SHRINK_ELEMENT);c=e}return a.selectedElement=c},reset:function(){this._.cache={}},selectElement:function(b){var a,c=this.document;if(o)try{a=c.body.createControlRange(),a.addElement(b[0]),a.select()}catch(e){a=c.body.createTextRange(),
a.moveToElementText(b[0]),a.select()}finally{}else a=c.createRange(),a.selectNode(b[0]),b=this.getNative(),b.removeAllRanges(),b.addRange(a);this.reset()},selectRanges:function(b){if(o){if(1<b.length){var a=b[b.length-1];b[0].setEnd(a.endContainer,a.endOffset);b.length=1}b[0]&&b[0].select()}else{a=this.getNative();if(!a)return;a.removeAllRanges();for(var c=0;c<b.length;c++){var h=b[c],j=this.document.createRange(),i=h.startContainer;if(h.collapsed&&(e.gecko&&1.09>e.gecko||e.opera||e.webkit)&&i[0].nodeType==
m.NodeType.ELEMENT_NODE&&!i[0].childNodes.length)i[0].appendChild(this.document.createTextNode(e.webkit?"\u200b":"")),h.startOffset++,h.endOffset++;j.setStart(i[0],h.startOffset);j.setEnd(h.endContainer[0],h.endOffset);a.addRange(j)}}this.reset()},createBookmarks2:function(b){for(var a=[],c=this.getRanges(),e=0;e<c.length;e++)a.push(c[e].createBookmark2(b));return a},createBookmarks:function(b,c){for(var e=[],h=this.document,j,c=c||this.getRanges(),i=c.length,l=0;l<i;l++){e.push(j=c[l].createBookmark(b,
p));var n=(b=j.serializable)?a.one("#"+j.startNode,h):j.startNode;j=b?a.one("#"+j.endNode,h):j.endNode;for(var o=l+1;o<i;o++){var t=c[o],r=t.startContainer,x=t.endContainer;m.equals(r,n.parent())&&t.startOffset++;m.equals(r,j.parent())&&t.startOffset++;m.equals(x,n.parent())&&t.endOffset++;m.equals(x,j.parent())&&t.endOffset++}}return e},selectBookmarks:function(b){for(var a=[],c=0;c<b.length;c++){var e=new y(this.document);e.moveToBookmark(b[c]);a.push(e)}this.selectRanges(a);return this},getCommonAncestor:function(){var b=
this.getRanges();return b[0].startContainer._4e_commonAncestor(b[b.length-1].endContainer)},scrollIntoView:function(){var b=this.getStartElement();b&&b.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var b=this.getNative();o?b&&b.clear():b&&b.removeAllRanges()}});var c={table:1,tbody:1,tr:1},b=w.whitespaces(p),t=/\ufeff|\u00a0/;y.prototype.select=y.prototype.select=!o?function(){var b=this.startContainer;this.collapsed&&b[0].nodeType==
m.NodeType.ELEMENT_NODE&&!b[0].childNodes.length&&b[0].appendChild(this.document.createTextNode(""));var a=this.document.createRange();a.setStart(b[0],this.startOffset);try{a.setEnd(this.endContainer[0],this.endOffset)}catch(c){if(0<=c.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(p),a.setEnd(this.endContainer[0],this.endOffset);else throw c;}b=r(this.document).getNative();b.removeAllRanges();b.addRange(a)}:function(a){var e=this.collapsed,g,h;if(this.startContainer[0]===this.endContainer[0]&&
1==this.endOffset-this.startOffset){var j=this.startContainer[0].childNodes[this.startOffset];if(j.nodeType==m.NodeType.ELEMENT_NODE){(new i(this.document)).selectElement(new l(j));return}}(this.startContainer[0].nodeType==m.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in c||this.endContainer[0].nodeType==m.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in c)&&this.shrink(u.SHRINK_ELEMENT,p);var n=this.createBookmark(),j=n.startNode,o;e||(o=n.endNode);n=this.document.body.createTextRange();
n.moveToElementText(j[0]);n.moveStart("character",1);if(o)a=this.document.body.createTextRange(),a.moveToElementText(o[0]),n.setEndPoint("EndToEnd",a),n.moveEnd("character",-1);else{for(g=j[0].nextSibling;g&&!b(g);)g=g.nextSibling;g=!(g&&g.nodeValue&&g.nodeValue.match(t))&&(a||!j[0].previousSibling||j[0].previousSibling&&"br"==m.nodeName(j[0].previousSibling));h=new l(this.document.createElement("span"));h.html("&#65279;");h.insertBefore(j);g&&m.insertBefore(this.document.createTextNode("\ufeff"),j[0]||
j)}this.setStartBefore(j);j._4e_remove();if(e){if(g?(n.moveStart("character",-1),n.select(),this.document.selection.clear()):n.select(),h)this.moveToPosition(h,u.POSITION_BEFORE_START),h._4e_remove()}else this.setEndBefore(o),o._4e_remove(),n.select()};i.getSelection=r;return q.Selection=i},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/selectionFix",function(a,i){function r(a){function c(b,a){var c=g.body.createTextRange();try{c.moveToPoint(b,a)}catch(d){c=l}return c}function b(){var a=g.selection.createRange();h&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&h.select();u.remove(g,"mouseup",b);u.remove(g,"mousemove",e);h=d=0}function e(a){if(a.button){if(a=c(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",h)?a.setEndPoint("StartToStart",h):a.setEndPoint("EndToEnd",h),a.select()}else b()}var d,f=a.get("window")[0],
g=a.get("document")[0],h;u.on(g,"mousedown contextmenu",function(a){var j=g.documentElement;if(a.target===j&&(d&&b(),!(j.scrollHeight>j.clientHeight)&&(d=1,h=c(a.pageX,a.pageY))))u.on(g,"mouseup",b),u.on(g,"mousemove",e),f.focus(),h.select()})}function q(a){function c(d){if(g){var h=a.getSelection(),k=h&&h.getType(),i=h&&b.selection;if(d&&i&&k==y.SELECTION_NONE&&!b.queryCommandEnabled("InsertImage"))setTimeout(function(){c(e)},50);else{var m;if(!i||!i.type||!("Control"!=i.type&&(m=i.createRange())&&
(m=m.parentElement())&&(m=m.nodeName)&&m.toLowerCase()in{input:1,textarea:1}))f=i&&h.getRanges()[0],a.checkSelectionChange()}}}var b=a.get("document")[0],h=new w(b.body),d=new w(b.documentElement);if(8>i.Utils.ieEngine)d.on("click",function(b){"html"===(new w(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var f,g,k=e;d.on("mousedown",function(){k=m});d.on("mouseup",function(){k=e});h.on("focusin",function(b){if("body"==(new w(b.target)).nodeName()&&f){try{k&&f.select()}catch(a){}f=
l}});h.on("focus",function(){g=e;c()});h.on("beforedeactivate",function(b){b.relatedTarget||(g=m,k=e)});h.on("mousedown",function(){g=m});h.on("mouseup",function(){g=e;setTimeout(function(){c(e)},0)});h.on("keydown",function(){g=m});h.on("keyup",function(){g=e;setTimeout(function(){c()},0)})}function p(a){var c=a.get("document")[0];u.on(c,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function h(a){function c(b){var a=i.XHTML_DTD;return b._4e_isBlockBoundary()&&a.$empty[b.nodeName()]}
function b(b){return d(b)&&f(b)}var h=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,d=i.Walker.whitespaces(e),f=i.Walker.bookmark(m,e),g=function(b){return d(b)&&8!=b.nodeType};a.on("selectionChange",function(d){var f=d.path,l=new w(a.get("document")[0].body),d=(d=d.selection)&&d.getRanges()[0],r=f.blockLimit;if(n.gecko){var p=f.block||f.blockLimit,q=p&&p.last(b);p&&p._4e_isBlockBoundary()&&(!q||!(1==q[0].nodeType&&
q._4e_isBlockBoundary()))&&"pre"!=p.nodeName()&&!p._4e_getBogus()&&p._4e_appendBogus()}if(d&&d.collapsed&&!f.block){if("body"==r.nodeName()){if((f=d.fixBlock(e,"p"))&&f[0]!=l[0].lastChild&&f.outerHTML().match(h))if((r=f.next(g,1))&&r[0].nodeType==o.NodeType.ELEMENT_NODE&&!c[r])d.moveToElementEditablePosition(r),f._4e_remove();else if((r=f.prev(g,1))&&r[0].nodeType==o.NodeType.ELEMENT_NODE&&!c[r])d.moveToElementEditablePosition(r,r.outerHTML().match(h)?m:e),f._4e_remove();d.select();a.notifySelectionChange()}f=
a.get("document")[0];d=new i.Range(f);d.moveToElementEditablePosition(l,e);"body"!==(new i.ElementPath(d.startContainer)).blockLimit.nodeName()&&(l=(new w(f.createElement("p"))).appendTo(l),n.ie||l._4e_appendBogus())}})}var e=!0,m=!1,l=null,n=a.UA,u=a.Event,o=a.DOM,w=a.Node,y=i.SELECTION;return{init:function(a){a.docReady(function(){n.ie?(r(a),q(a)):p(a)});h(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core/styles",function(a,i){function r(b){return!z.attr(b,"_ke_bookmark")}function q(b,a){for(var c in b)"string"==typeof b[c]?b[c]=b[c].replace(S,function(b,c){return a[c]}):q(b[c],a)}function p(b,c){c&&(b=a.clone(b),q(b,c));var d=this.element=this.element=(b.element||"*").toLowerCase();this.type=this.type="#text"==d||R[d]?E.STYLE_BLOCK:P[d]?E.STYLE_OBJECT:E.STYLE_INLINE;this._={definition:b}}function h(b,a){var c=a?this.removeFromRange:this.applyToRange;b.body.focus();for(var d=
new D(b),e=d.getRanges(),f=0;f<e.length;f++)c.call(this,e[f]);d.selectRanges(e)}function e(b,a,c){var d=b.element;"*"==d&&(d="span");a=new G(a.createElement(d));c&&c._4e_copyAttributes(a);c=b._.definition;b=c.attributes;c=p.getStyleText(c);if(b)for(var e in b)a.attr(e,b[e]);c&&(a[0].style.cssText=c);return a}function m(b){var a=b.createBookmark(k),c=b.createIterator();c.enforceRealBlocks=k;c.enlargeBr=k;for(var d,f=b.document;d=c.getNextParagraph();){var g=e(this,f,d),h=g,g="pre"==h.nodeName,j="pre"==
d.nodeName,i=!g&&j;g&&!j?(j=d,i=j.html(),i=l(i,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),i=i.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),i=i.replace(/([ \t\n\r]+|&nbsp;)/g," "),i=i.replace(/<br\b[^>]*>/gi,"\n"),L.ie?(j=j[0].ownerDocument.createElement("div"),j.appendChild(h[0]),h[0].outerHTML="<pre>"+i+"</pre>",h=new G(j.firstChild),h._4e_remove()):h.html(i)):i?h=u(n(d),h):d._4e_moveChildren(h);d[0].parentNode.replaceChild(h[0],d[0]);if(g&&(d=h,g=void 0,(g=d._4e_previousSourceNode(k,z.NodeType.ELEMENT_NODE))&&
"pre"==g.nodeName()))h=l(g.html(),/\n$/,"")+"\n\n"+l(d.html(),/^\n/,""),L.ie?d[0].outerHTML="<pre>"+h+"</pre>":d.html(h),g._4e_remove()}b.moveToBookmark(a)}function l(b,a,c){var d="",e="",b=b.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(b,a,c){a&&(d=a);c&&(e=c);return""});return d+b.replace(a,c)+e}function n(b){var a=[];l(b.outerHTML(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(b,a,c){return a+"</pre>"+c+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(b,c){a.push(c)});return a}function u(b,a){for(var c=a[0].ownerDocument.createDocumentFragment(),d=0;d<b.length;d++){var e=b[d],e=e.replace(/(\r\n|\r)/g,"\n"),e=l(e,/^[ \t]*\n/,""),e=l(e,/\n$/,""),e=l(e,/^[ \t]+|[ \t]+$/g,function(b,a){return 1==b.length?"&nbsp;":a?" "+Array(b.length).join("&nbsp;"):Array(b.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(b){return Array(b.length).join("&nbsp;")+" "}),f=a.clone();f.html(e);c.appendChild(f[0])}return c}
function o(b){var a=b.document;if(b.collapsed)a=e(this,a,void 0),b.insertNode(a),b.moveToPosition(a,v.POSITION_BEFORE_END);else{var c=this.element,f=this._.definition,g,h=K[c];h||(g=k,h=K.span);var j=b.createBookmark();b.enlarge(v.ENLARGE_ELEMENT);b.trim();for(var i=b.createBookmark(),m=i.startNode,i=i.endNode,l=m,n;l&&l[0];){var o=s;if(z.equals(l,i))l=B,o=k;else{var p=l[0].nodeType,t=p==z.NodeType.ELEMENT_NODE?l.nodeName():B;if(t&&l.attr("_ke_bookmark")){l=l._4e_nextSourceNode(k);continue}if(!t||
h[t]&&(l._4e_position(i)|x.POSITION_PRECEDING|x.POSITION_IDENTICAL|x.POSITION_IS_CONTAINED)==x.POSITION_PRECEDING+x.POSITION_IDENTICAL+x.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(l))){var q=l.parent();if(q&&"a"==c&&q.nodeName()==c)p=e(this,a,void 0),q._4e_moveChildren(p),q[0].parentNode.replaceChild(p[0],q[0]),p._4e_mergeSiblings();else if(q&&q[0]&&((K[q.nodeName()]||K.span)[c]||g)&&(!f.parentRule||f.parentRule(q))){if(!n&&(!t||!K.$removeEmpty[t]||(l._4e_position(i)|x.POSITION_PRECEDING|x.POSITION_IDENTICAL|
x.POSITION_IS_CONTAINED)==x.POSITION_PRECEDING+x.POSITION_IDENTICAL+x.POSITION_IS_CONTAINED))n=new O(a),n.setStartBefore(l);if(p==z.NodeType.TEXT_NODE||p==z.NodeType.ELEMENT_NODE&&!l[0].childNodes.length){q=l;for(p=null;(o=!q.next(r,1))&&(p=q.parent())&&h[p.nodeName()]&&(p._4e_position(m)|x.POSITION_FOLLOWING|x.POSITION_IDENTICAL|x.POSITION_IS_CONTAINED)==x.POSITION_FOLLOWING+x.POSITION_IDENTICAL+x.POSITION_IS_CONTAINED&&(!f.childRule||f.childRule(p));)q=p;n.setEndAfter(q)}}else o=k}else o=k;l=l._4e_nextSourceNode()}if(o&&
n&&!n.collapsed){for(var o=e(this,a,void 0),q=n.getCommonAncestor(),p={},t={},u,w=null,y;o&&q&&o[0]&&q[0];){if(q.nodeName()==c){for(u in f.attributes)if(!t[u]&&(y=q.attr(w)))o.attr(u)==y?o.removeAttr(u):t[u]=1;for(w in f.styles)if(!p[w]&&(y=q.style(w)))o.style(w)==y?o.style(w,""):p[w]=1;if(!o._4e_hasAttributes()){o=B;break}}q=q.parent()}o?(o[0].appendChild(n.extractContents()),d(this,o),n.insertNode(o),o._4e_mergeSiblings(),L.ie||o[0].normalize()):(o=new G(a.createElement("span")),o[0].appendChild(n.extractContents()),
n.insertNode(o),d(this,o),o._4e_remove(!0));n=B}}m._4e_remove();i._4e_remove();b.moveToBookmark(j);b.shrink(v.SHRINK_TEXT)}}function w(a){a.enlarge(v.ENLARGE_ELEMENT);var d=a.createBookmark(),e=d.startNode;if(a.collapsed){for(var g=new N(e.parent()),h,j=0,i;j<g.elements.length&&(i=g.elements[j])&&!(i==g.block||i==g.blockLimit);j++)if(this.checkElementRemovable(i)){var k=a.checkBoundaryOfElement(i,v.END),m=!k&&a.checkBoundaryOfElement(i,v.START);m||k?(h=i,h.match=m?"start":"end"):(i._4e_mergeSiblings(),
i.nodeName()!=this.element?(k=c(this),f(i,k[i.nodeName()]||k["*"])):b(this,i))}if(h){i=e;for(j=0;;j++){k=g.elements[j];if(k.equals(h))break;else if(k.match)continue;else k=k.clone();k[0].appendChild(i[0]);i=k}i["start"==h.match?"insertBefore":"insertAfter"](h);g=h.html();!g||"\u200b"==g?h.remove():L.webkit&&C(a.document.createTextNode("\u200b")).insertBefore(i)}}else{var l=d.endNode,n=this;h=function(){for(var b=new N(e.parent()),a=new N(l.parent()),c=B,d=B,f=0;f<b.elements.length;f++){var g=b.elements[f];
if(g==b.block||g==b.blockLimit)break;n.checkElementRemovable(g)&&(c=g)}for(f=0;f<a.elements.length;f++){g=a.elements[f];if(g==a.block||g==a.blockLimit)break;n.checkElementRemovable(g)&&(d=g)}d&&l._4e_breakParent(d);c&&e._4e_breakParent(c)};h();for(g=new G(e[0].nextSibling);g[0]!==l[0];){j=g._4e_nextSourceNode();if(g[0]&&g[0].nodeType==z.NodeType.ELEMENT_NODE&&this.checkElementRemovable(g)&&(g.nodeName()==this.element?b(this,g):(i=c(this),f(g,i[g.nodeName()]||i["*"])),j[0].nodeType==z.NodeType.ELEMENT_NODE&&
j.contains(e)))h(),j=new G(e[0].nextSibling);g=j}}a.moveToBookmark(d)}function y(b){var a={};(""+b).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(b,c,d){a[c]=d});return a}function j(b,a){var c="";a!==s?(c=document.createElement("span"),c.style.cssText=b,c=c.style.cssText||""):c=b;return c.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function c(b){if(b._.overrides)return b._.overrides;var c=b._.overrides={},d=b._.definition.overrides;
if(d){a.isArray(d)||(d=[d]);for(var e=0;e<d.length;e++){var g=d[e],f,h,j;"string"==typeof g?f=g.toLowerCase():(f=g.element?g.element.toLowerCase():b.element,h=g.attributes,j=g.styles);g=c[f]||(c[f]={});if(h){f=g.attributes=g.attributes||[];for(var i in h)f.push([i.toLowerCase(),h[i]])}if(j){var g=g.styles=g.styles||[],k;for(k in j)g.push([k.toLowerCase(),j[k]])}}}return c}function b(b,d){var e=b._.definition,f=c(b),h=a.merge(e.attributes,(f[d.nodeName()]||f["*"]||{}).attributes),e=a.merge(e.styles,
(f[d.nodeName()]||f["*"]||{}).styles),f=a.isEmptyObject(h)&&a.isEmptyObject(e),j;for(j in h)("class"==j||b._.definition.fullMatch)&&d.attr(j)!=t(j,h[j])||(f=f||!!d.hasAttr(j),d.removeAttr(j));for(var i in e)b._.definition.fullMatch&&d.style(i)!=t(i,e[i],k)||(f=f||!!d.style(i),d.style(i,""));g(d)}function t(b,a,c){var d=new G("<span>");d[c?"style":"attr"](b,a);return d[c?"style":"attr"](b)}function d(a,d){for(var e=c(a),g=d.all(a.element),h=g.length;0<=--h;)b(a,new G(g[h]));for(var j in e)if(j!=a.element){g=
d.all(j);for(h=g.length-1;0<=h;h--){var i=new G(g[h]);f(i,e[j])}}}function f(b,a){var c,d=a&&a.attributes;if(d)for(c=0;c<d.length;c++){var e=d[c][0],f;if(f=b.attr(e)){var h=d[c][1];(h===B||h.test&&h.test(f)||"string"==typeof h&&f==h)&&b[0].removeAttribute(e)}}if(d=a&&a.styles)for(c=0;c<d.length;c++)if(e=d[c][0],h=b.css(e)){var j=d[c][1];(j===B||j.test&&j.test(f)||"string"==typeof j&&h==j)&&b.css(e,"")}g(b)}function g(b){if(!b._4e_hasAttributes()){var a=b[0].firstChild,c=b[0].lastChild;b._4e_remove(k);
a&&(a.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(a),c&&a!=c&&c.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(c))}}var k=!0,s=!1,B=null,C=a.all,z=a.DOM,E={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},v=i.RANGE,D=i.Selection,x=i.POSITION,O=i.Range,G=a.Node,L=a.UA,N=i.ElementPath,R={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},K=i.XHTML_DTD,P={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},Q=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;i.STYLE=
E;p.prototype={constructor:p,apply:function(b){h.call(this,b,s)},remove:function(b){h.call(this,b,k)},applyToRange:function(b){return(this.applyToRange=this.type==E.STYLE_INLINE?o:this.type==E.STYLE_BLOCK?m:B).call(this,b)},removeFromRange:function(b){return(this.removeFromRange=this.type==E.STYLE_INLINE?w:B).call(this,b)},checkElementRemovable:function(b,a){if(!b)return s;var d=this._.definition,e;if(b.nodeName()==this.element){if(!a&&!b._4e_hasAttributes())return k;var f=d._AC;if(f)d=f;else{var f=
{},g=0,h=d.attributes;if(h)for(var i in h)g++,f[i]=h[i];if(h=p.getStyleText(d))f.style||g++,f.style=h;f._length=g;d=d._AC=f}if(d._length){for(var m in d)if("_length"!=m){g=b.attr(m)||"";if("style"==m)a:{f=d[m];g=j(g,s);"string"==typeof f&&(f=y(f));"string"==typeof g&&(g=y(g));h=void 0;for(h in f)if(!(h in g&&(g[h]==f[h]||"inherit"==f[h]||"inherit"==g[h]))){f=s;break a}f=k}else f=d[m]==g;if(f){if(!a)return k}else if(a)return s}if(a)return k}else return k}m=c(this);if(m=m[b.nodeName()]||m["*"]){if(!(d=
m.attributes)&&!(e=m.styles))return k;if(d)for(f=0;f<d.length;f++)if(m=d[f][0],m=b.attr(m))if(g=d[f][1],g===B||"string"==typeof g&&m==g||g.test&&g.test(m))return k;if(e)for(f=0;f<e.length;f++)if(m=b.css(e[f][0]))if(d=e[f][1],d===B||"string"==typeof d&&m==d||d.test&&d.test(m))return k}return s},checkActive:function(b){switch(this.type){case E.STYLE_BLOCK:return this.checkElementRemovable(b.block||b.blockLimit,k);case E.STYLE_OBJECT:case E.STYLE_INLINE:for(var a=b.elements,c=0,d;c<a.length;c++)if(d=
a[c],!(this.type==E.STYLE_INLINE&&(z.equals(d,b.block)||z.equals(d,b.blockLimit))))if((this.type!=E.STYLE_OBJECT||d.nodeName()in P)&&this.checkElementRemovable(d,k))return k}return s}};p.getStyleText=function(b){var a=b._ST;if(a)return a;var a=b.styles,c=b.attributes&&b.attributes.style||"",d="";c.length&&(c=c.replace(Q,";"));for(var e in a){var f=a[e],g=(e+":"+f).replace(Q,";");"inherit"==f?d+=g:c+=g}c.length&&(c=j(c));return b._ST=c+d};return i.Style=p},{requires:["./base","./range","./selection",
"./domIterator","./elementPath"]});
KISSY.add("editor/core/utils",function(a){var i=a.Node,r=a.DOM,q=a.UA,p={debugUrl:function(h){var e=a.Config;e.debug||(h=h.replace(/\.(js|css)/i,"-min.$1"));-1==h.indexOf("?t")&&(h=-1!=h.indexOf("?")?h+"&":h+"?",h+="t="+encodeURIComponent(e.tag));return e.base+"editor/"+h},lazyRun:function(a,e,i){var l=a[e],n=a[i];a[e]=function(){l.apply(this,arguments);a[e]=a[i];return n.apply(this,arguments)}},getXY:function(a,e){var i=a.left,l=a.top,n=e.get("window")[0],i=i-r.scrollLeft(n),l=l-r.scrollTop(n),n=
e.get("iframe").offset(),i=i+n.left,l=l+n.top;return{left:i,top:l}},tryThese:function(a){for(var e,i=0,l=arguments.length;i<l;i++){var n=arguments[i];try{e=n();break}catch(p){}}return e},arrayCompare:function(a,e){if(!a&&!e)return!0;if(!a||!e||a.length!=e.length)return!1;for(var i=0;i<a.length;i++)if(a[i]!==e[i])return!1;return!0},clearAllMarkers:function(a){for(var e in a)a[e]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,
"")},isNumber:function(h){return/^\d+(.\d+)?$/.test(a.trim(h))},verifyInputs:function(h){for(var e=0;e<h.length;e++){var m=new i(h[e]),l=a.trim(p.valInput(m)),n=m.attr("data-verify"),m=m.attr("data-warning");if(n&&!RegExp(n).test(l))return alert(m),!1}return!0},sourceDisable:function(a,e){a.on("sourceMode",e.disable,e);a.on("wysiwygMode",e.enable,e)},resetInput:function(a){var e=a.attr("placeholder");e&&q.ie?(a.addClass("ks-editor-input-tip"),a.val(e)):q.ie||a.val("")},valInput:function(a,e){if(void 0===
e)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");a.val(e)},placeholder:function(h,e){h.attr("placeholder",e);q.ie&&(h.on("blur",function(){a.trim(h.val())||(h.addClass("ks-editor-input-tip"),h.val(e))}),h.on("focus",function(){h.removeClass("ks-editor-input-tip");a.trim(h.val())==e&&h.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(h){var h=a.clone(h),
e;for(e in h){var i=h[e];a.isFunction(i)&&(h[e]=i())}return h},map:function(a,e){for(var i=0;i<a.length;i++)a[i]=e(a[i]);return a},ieEngine:document.documentMode||q.ie,preventFocus:function(a){q.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(h){a.mix(r,h);for(var e in h)(function(e){i.prototype[e]=function(){var l=[].slice.call(arguments,0);l.unshift(this[0]);return(l=h[e].apply(null,l))&&(l.nodeType||a.isWindow(l))?new i(l):a.isArray(l)&&(l.__IS_NODELIST||l[0]&&l[0].nodeType)?
new i(l):l}})(e)},addRes:function(){var h=this.__res=this.__res||[];h.push.apply(h,a.makeArray(arguments))},destroyRes:function(){for(var h=this.__res||[],e=0;e<h.length;e++){var i=h[e];a.isFunction(i)?i():i.destroy?i.destroy():i.remove&&i.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,h){return h.toUpperCase()})+"Value"}};return a.Editor.Utils=p},{requires:["./base"]});
KISSY.add("editor/core/walker",function(a,i){function r(a,c){if(this._.end)return m;var d,f=this.range,g,i=this.guard,j=this.type,l=a?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,f.trim(),f.collapsed))return this.end(),m;if(!a&&!this._.guardLTR){var p=f.endContainer[0],q=p.childNodes[f.endOffset];this._.guardLTR=function(a,b){return b&&(p==a||"body"==n.nodeName(a))?!1:a!=q}}if(a&&!this._.guardRTL){var r=f.startContainer[0],v=0<f.startOffset&&r.childNodes[f.startOffset-
1]||null;this._.guardRTL=function(a,b){return b&&(r==a||"body"==n.nodeName(a))?!1:a!=v}}var u=a?this._.guardRTL:this._.guardLTR;g=i?function(a,b){return u(a,b)===e?e:i(a,b)}:u;this.current?d=this.current[l](e,j,g):a?(d=f.endContainer,0<f.endOffset?(d=new o(d[0].childNodes[f.endOffset-1]),g(d[0])===e&&(d=m)):d=g(d,h)===e?m:d._4e_previousSourceNode(h,j,g,void 0)):(d=f.startContainer,d=new o(d[0].childNodes[f.startOffset]),d.length?g(d[0])===e&&(d=m):d=g(f.startContainer,h)===e?m:f.startContainer._4e_nextSourceNode(h,
j,g,void 0));for(;d&&!this._.end;){this.current=d;if(!this.evaluator||this.evaluator(d[0])!==e){if(!c)return d}else if(c&&this.evaluator)return e;d=d[l](e,j,g)}this.end();return this.current=m}function q(a){for(var c,d=m;c=r.call(this,a);)d=c;return d}function p(a){this.range=a;this.guard=this.evaluator=m;this._={}}var h=!0,e=!1,m=null,l=a.UA,n=a.DOM,u=i.XHTML_DTD,o=a.Node;a.augment(p,{end:function(){this._.end=1},next:function(){return r.call(this)},previous:function(){return r.call(this,h)},checkForward:function(){return r.call(this,
e,h)!==e},checkBackward:function(){return r.call(this,h,h)!==e},lastForward:function(){return q.call(this)},lastBackward:function(){return q.call(this,h)},reset:function(){delete this.current;this._={}},_iterator:r});a.mix(p,{blockBoundary:function(a){return function(c){return!(c.nodeType==n.NodeType.ELEMENT_NODE&&n._4e_isBlockBoundary(c,a))}},bookmark:function(a,c){function d(a){return"span"==n.nodeName(a)&&n.attr(a,"_ke_bookmark")}return function(e){var g,h;g=e.nodeType==n.NodeType.TEXT_NODE&&(h=
e.parentNode)&&d(h);g=a?g:g||d(e);return!!(c^g)}},whitespaces:function(b){return function(c){c=c.nodeType==n.NodeType.TEXT_NODE&&!a.trim(c.nodeValue);return!!(b^c)}},invisible:function(a){var c=p.whitespaces();return function(d){d=c(d)||d.nodeType==n.NodeType.ELEMENT_NODE&&!d.offsetHeight;return!!(a^d)}}});var w=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,y=p.whitespaces(),j=p.bookmark(),c=function(a){var c=n.nodeName(a);return j(a)||y(a)||1==a.nodeType&&c in u.$inline&&!(c in u.$empty)};i.Utils.injectDom({_4e_getBogus:function(a){a=
new o(a);do a=a._4e_previousSourceNode();while(a&&c(a[0]));return a&&(!l.ie?"br"==a.nodeName():3==a[0].nodeType&&w.test(a.text()))?a[0]:!1}});return i.Walker=p},{requires:["./base","./utils","./dom"]});KISSY.add("editor/core/zIndexManager",function(a){var i=a.Editor,a=i.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};i.baseZIndex=function(a){return(i.Config.baseZIndex||1E4)+a};return a},{requires:["./base"]});
