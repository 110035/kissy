/*
Copyright 2013, KISSY UI Library v1.40dev
MIT Licensed
build time: May 30 01:34
*/
/*
 thanks to CKSource's intelligent work on CKEditor
 @author yiminghe@gmail.com
*/
KISSY.add("editor/core/base",function(a,n,s){n=s.Controller.extend({initializer:function(){this.__commands={};this.__controls={}}},{Config:{},XHTML_DTD:n.DTD,ATTRS:{textarea:{},iframe:{},window:{},document:{},toolBarEl:{},statusBarEl:{},handleMouseEvents:{value:!1},focusable:{value:!1},mode:{value:1},data:{getter:function(a){var n=this._getData();return void 0===n?a:n}},formatData:{getter:function(){return this._getData(1)}},customStyle:{value:""},customLink:{value:[]}}},{xclass:"editor"});n.HTML_PARSER=
{textarea:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea")},data:function(a){return a.one("."+this.get("prefixCls")+"editor-textarea").val()}};a.mix(n,a.EventTarget);return KISSY.Editor=n},{requires:["htmlparser","component/base","core"]});
KISSY.add("editor/core/utils",function(a){var n=a.Node,s=a.DOM,r=a.UA,p={debugUrl:function(m){var f=a.Config;f.debug||(m=m.replace(/\.(js|css)/i,"-min.$1"));-1==m.indexOf("?t")&&(m=-1!=m.indexOf("?")?m+"&":m+"?",m+="t="+encodeURIComponent(f.tag));return f.base+"editor/"+m},lazyRun:function(a,f,h){var o=a[f],q=a[h];a[f]=function(){o.apply(this,arguments);a[f]=a[h];return q.apply(this,arguments)}},getXY:function(a,f){var h=a.left,o=a.top,q=f.get("window")[0],h=h-s.scrollLeft(q),o=o-s.scrollTop(q),q=
f.get("iframe").offset(),h=h+q.left,o=o+q.top;return{left:h,top:o}},tryThese:function(a){for(var f,h=0,o=arguments.length;h<o;h++){var q=arguments[h];try{f=q();break}catch(n){}}return f},arrayCompare:function(a,f){if(!a&&!f)return!0;if(!a||!f||a.length!=f.length)return!1;for(var h=0;h<a.length;h++)if(a[h]!==f[h])return!1;return!0},clearAllMarkers:function(a){for(var f in a)a[f]._4e_clearMarkers(a,!0,void 0)},ltrim:function(a){return a.replace(/^\s+/,"")},rtrim:function(a){return a.replace(/\s+$/,
"")},isNumber:function(m){return/^\d+(.\d+)?$/.test(a.trim(m))},verifyInputs:function(m){for(var f=0;f<m.length;f++){var h=new n(m[f]),o=a.trim(p.valInput(h)),q=h.attr("data-verify"),h=h.attr("data-warning");if(q&&!RegExp(q).test(o))return alert(h),!1}return!0},sourceDisable:function(a,f){a.on("sourceMode",f.disable,f);a.on("wysiwygMode",f.enable,f)},resetInput:function(a){var f=a.attr("placeholder");f&&r.ie?(a.addClass("ks-editor-input-tip"),a.val(f)):r.ie||a.val("")},valInput:function(a,f){if(void 0===
f)return a.hasClass("ks-editor-input-tip")?"":a.val();a.removeClass("ks-editor-input-tip");a.val(f)},placeholder:function(m,f){m.attr("placeholder",f);r.ie&&(m.on("blur",function(){a.trim(m.val())||(m.addClass("ks-editor-input-tip"),m.val(f))}),m.on("focus",function(){m.removeClass("ks-editor-input-tip");a.trim(m.val())==f&&m.val("")}))},htmlEncode:function(a){return!a?a:(""+a).replace(/&/g,"&amp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},normParams:function(m){var m=a.clone(m),
f;for(f in m){var h=m[f];a.isFunction(h)&&(m[f]=h())}return m},map:function(a,f){for(var h=0;h<a.length;h++)a[h]=f(a[h]);return a},ieEngine:document.documentMode||r.ie,preventFocus:function(a){r.ie?a.unselectable():a.attr("onmousedown","return false;")},injectDom:function(m){a.mix(s,m);for(var f in m)(function(f){n.prototype[f]=function(){var o=[].slice.call(arguments,0);o.unshift(this[0]);return(o=m[f].apply(null,o))&&(o.nodeType||a.isWindow(o))?new n(o):a.isArray(o)&&(o.__IS_NODELIST||o[0]&&o[0].nodeType)?
new n(o):o}})(f)},addRes:function(){var m=this.__res=this.__res||[];m.push.apply(m,a.makeArray(arguments))},destroyRes:function(){for(var m=this.__res||[],f=0;f<m.length;f++){var h=m[f];a.isFunction(h)?h():h.destroy?h.destroy():h.remove&&h.remove()}this.__res=[]},getQueryCmd:function(a){return"query"+("-"+a).replace(/-(\w)/g,function(a,h){return h.toUpperCase()})+"Value"}};return a.Editor.Utils=p},{requires:["./base"]});
KISSY.add("editor/core/dom",function(a,n,s){function r(b,e){var d=b[e?"next":"prev"](p,1);if(d&&d[0].nodeType==h.ELEMENT_NODE){for(var c=[];d.attr("_ke_bookmark")||d._4e_isEmptyInlineRemovable(p);)if(c.push(d),d=e?d.next(p,1):d.prev(p,1),!d)return;if(b._4e_isIdentical(d,p)){for(var l=new q(e?b[0].lastChild:b[0].firstChild);c.length;)c.shift()._4e_move(b,!e,p);d._4e_moveChildren(b,!e,p);d.remove();l[0]&&l[0].nodeType==h.ELEMENT_NODE&&l._4e_mergeSiblings()}}}var p=p,m=n.XHTML_DTD,f=a.DOM,h=f.NodeType,
o=a.UA,q=a.Node,w={a:1,abbr:1,acronym:1,address:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,s:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};n.POSITION={POSITION_IDENTICAL:0,POSITION_DISCONNECTED:1,POSITION_FOLLOWING:2,POSITION_PRECEDING:4,POSITION_IS_CONTAINED:8,POSITION_CONTAINS:16};var j=n.POSITION,v={block:1,"list-item":1,table:1,"table-row-group":1,"table-header-group":1,"table-footer-group":1,"table-row":1,"table-column-group":1,
"table-column":1,"table-cell":1,"table-caption":1},x={hr:1},d=function(b){return b&&(b[0]||b)};s.injectDom({_4e_sameLevel:function(b,e){var e=d(e),a=b.parentNode;return a&&a==e.parentNode},_4e_isBlockBoundary:function(b,e){var d=a.merge(x,e);return!(!v[f.css(b,"display")]&&!d[f.nodeName(b)])},_4e_index:function(b,e){for(var d=b.parentNode.childNodes,c,l=-1,g=0;g<d.length;g++)if(c=d[g],!e||!(3==c.nodeType&&c.previousSibling&&3==c.previousSibling.nodeType))if(l++,c===b)return l;return-1},_4e_move:function(b,
e,a){e=d(e);a?e.insertBefore(b,e.firstChild):e.appendChild(b)},_4e_isIdentical:function(b,e){if(!e)return!1;e=d(e);if(f.nodeName(b)!=f.nodeName(e))return!1;var a=b.attributes,c=e.attributes,l=a.length,g=c.length;if(l!=g)return!1;for(var i=0;i<l;i++){var k=a[i],j=k.name;if(k.specified&&f.attr(b,j)!=f.attr(e,j))return!1}if(8>s.ieEngine)for(i=0;i<g;i++)if(k=c[i],j=k.name,k.specified&&f.attr(b,j)!=f.attr(e,j))return!1;return!0},_4e_isEmptyInlineRemovable:function(b){if(!m.$removeEmpty[f.nodeName(b)])return!1;
for(var b=b.childNodes,e=0,d=b.length;e<d;e++){var c=b[e],l=c.nodeType;if(!(l==h.ELEMENT_NODE&&c.getAttribute("_ke_bookmark"))&&(l==h.ELEMENT_NODE&&!f._4e_isEmptyInlineRemovable(c)||l==f.NodeType.TEXT_NODE&&a.trim(c.nodeValue)))return!1}return!0},_4e_moveChildren:function(b,e,a){e=d(e);if(b!=e)if(a)for(;a=b.lastChild;)e.insertBefore(b.removeChild(a),e.firstChild);else for(;a=b.firstChild;)e.appendChild(b.removeChild(a))},_4e_mergeSiblings:function(b){b=new q(b);w[b.nodeName()]&&(r(b,!0),r(b))},_4e_splitText:function(b,
e){var d=b.ownerDocument;if(b.nodeType==f.NodeType.TEXT_NODE){if(o.ie&&e==b.nodeValue.length){var c=d.createTextNode("");f.insertAfter(c,b);return c}c=b.splitText(e);d.documentMode&&(d=d.createTextNode(""),f.insertAfter(d,c),f.remove(d));return c}},_4e_parents:function(b,e){var d=[];d.__IS_NODELIST=1;do d[e?"push":"unshift"](b);while(b=b.parentNode);return d},_4e_nextSourceNode:function(b,e,a,c){if(c&&!c.call)var l=d(c),c=function(c){return c!==l};var e=!e&&b.firstChild,g=b;if(!e){if(b.nodeType==
h.ELEMENT_NODE&&c&&!1===c(b,!0))return null;e=b.nextSibling}for(;!e&&(g=g.parentNode);){if(c&&!1===c(g,!0))return null;e=g.nextSibling}return!e||c&&!1===c(e)?null:a&&a!=e.nodeType?f._4e_nextSourceNode(e,!1,a,c):e},_4e_previousSourceNode:function(b,e,a,c){if(c&&!c.call)var l=d(c),c=function(c){return c!==l};var e=!e&&b.lastChild,g=b;if(!e){if(b.nodeType==h.ELEMENT_NODE&&c&&!1===c(b,!0))return null;e=b.previousSibling}for(;!e&&(g=g.parentNode);){if(c&&!1===c(g,!0))return null;e=g.previousSibling}return!e||
c&&!1===c(e)?null:a&&e.nodeType!=a?f._4e_previousSourceNode(e,!1,a,c):e},_4e_commonAncestor:function(b,e){e=d(e);if(b===e)return b;if(f.contains(e,b))return e;var a=b;do if(f.contains(a,e))return a;while(a=a.parentNode);return null},_4e_hasAttributes:9>s.ieEngine?function(b){for(var e=b.attributes,d=0;d<e.length;d++){var c=e[d];switch(c.name){case "class":if(b.getAttribute("class"))return!0;break;default:if(c.specified)return!0}}return!1}:function(b){o.gecko&&b.removeAttribute("_moz_dirty");return b.hasAttributes()},
_4e_position:function(b,e){var a=d(e);if(b.compareDocumentPosition)return b.compareDocumentPosition(a);if(b==a)return j.POSITION_IDENTICAL;if(b.nodeType==h.ELEMENT_NODE&&a.nodeType==h.ELEMENT_NODE){if(f.contains(b,a))return j.POSITION_CONTAINS+j.POSITION_PRECEDING;if(f.contains(a,b))return j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING;if("sourceIndex"in b)return 0>b.sourceIndex||0>a.sourceIndex?j.POSITION_DISCONNECTED:b.sourceIndex<a.sourceIndex?j.POSITION_PRECEDING:j.POSITION_FOLLOWING}for(var c=
f._4e_address(b),a=f._4e_address(a),l=Math.min(c.length,a.length),g=0;g<=l-1;g++)if(c[g]!=a[g])return c[g]<a[g]?j.POSITION_PRECEDING:j.POSITION_FOLLOWING;return c.length<a.length?j.POSITION_CONTAINS+j.POSITION_PRECEDING:j.POSITION_IS_CONTAINED+j.POSITION_FOLLOWING},_4e_address:function(b,e){for(var d=[],c=b.ownerDocument.documentElement,l=b;l&&l!=c;)d.unshift(f._4e_index(l,e)),l=l.parentNode;return d},_4e_remove:function(b,e){var d=b.parentNode;if(d){if(e)for(var c;c=b.firstChild;)d.insertBefore(b.removeChild(c),
b);d.removeChild(b)}return b},_4e_trim:function(b){f._4e_ltrim(b);f._4e_rtrim(b)},_4e_ltrim:function(b){for(var e;e=b.firstChild;){if(e.nodeType==f.NodeType.TEXT_NODE){var d=s.ltrim(e.nodeValue),c=e.nodeValue.length;if(d)d.length<c&&(f._4e_splitText(e,c-d.length),b.removeChild(b.firstChild));else{b.removeChild(e);continue}}break}},_4e_rtrim:function(b){for(var e;e=b.lastChild;){if(e.type==f.NodeType.TEXT_NODE){var d=s.rtrim(e.nodeValue),c=e.nodeValue.length;if(d)d.length<c&&(f._4e_splitText(e,d.length),
b.removeChild(b.lastChild));else{b.removeChild(e);continue}}break}!o.ie&&!o.opera&&(e=b.lastChild)&&1==e.nodeType&&"br"==f.nodeName(e)&&b.removeChild(e)},_4e_appendBogus:function(b){for(var e=b.lastChild;e&&e.nodeType==f.NodeType.TEXT_NODE&&!a.trim(e.nodeValue);)e=e.previousSibling;if(!e||e.nodeType==f.NodeType.TEXT_NODE||"br"!==f.nodeName(e))e=o.opera?b.ownerDocument.createTextNode(""):b.ownerDocument.createElement("br"),b.appendChild(e)},_4e_setMarker:function(b,e,d,c){var b=new q(b),l=b.data("list_marker_id")||
b.data("list_marker_id",a.guid()).data("list_marker_id"),g=b.data("list_marker_names")||b.data("list_marker_names",{}).data("list_marker_names");e[l]=b;g[d]=1;return b.data(d,c)},_4e_clearMarkers:function(b,e,d){var b=new q(b),c=b.data("list_marker_names"),l=b.data("list_marker_id"),g;for(g in c)b.removeData(g);b.removeData("list_marker_names");d&&(b.removeData("list_marker_id"),delete e[l])},_4e_copyAttributes:function(b,e,d){for(var e=new q(e),c=b.attributes,d=d||{},l=0;l<c.length;l++){var g=c[l],
a=g.name.toLowerCase(),k;if(!(a in d))if("checked"==a&&(k=f.attr(b,a)))e.attr(a,k);else if(g.specified||o.ie&&g.value&&"value"==a)k=f.attr(b,a),null===k&&(k=g.nodeValue),e.attr(a,k)}""!==b.style.cssText&&(e[0].style.cssText=b.style.cssText)},_4e_isEditable:function(b){b=f.nodeName(b);return(b=!m.$nonEditable[b]&&(m[b]||m.span))&&b["#text"]},_4e_getByAddress:function(b,e,d){for(var b=b.documentElement,c=0;b&&c<e.length;c++){var a=e[c];if(d)for(var g=-1,i=0;i<b.childNodes.length;i++){var k=b.childNodes[i];
if(!(!0===d&&3==k.nodeType&&k.previousSibling&&3==k.previousSibling.nodeType)&&(g++,g==a)){b=k;break}}else b=b.childNodes[a]}return b}})},{requires:["./base","./utils"]});
KISSY.add("editor/core/focusManager",function(a){function n(){var a=this;a.__iframeFocus=o;h=a;f&&clearTimeout(f);f=setTimeout(function(){a.fire("focus")},30)}function s(){var a=this;a.__iframeFocus=q;h=w;f&&clearTimeout(f);f=setTimeout(function(){a.fire("blur")},30)}var r=a.Editor,p=a.Event,m={},f,h,a={refreshAll:function(){for(var a in m){var f=m[a].get("document")[0];f.designMode="off";f.designMode="on"}},currentInstance:function(){return h},getInstance:function(a){return m[a]},add:function(a){var f=
a.get("window")[0];p.on(f,"focus",n,a);p.on(f,"blur",s,a)},register:function(a){m[a._UUID]=a},remove:function(a){delete m[a._UUID];var f=a.get("window")[0];p.remove(f,"focus",n,a);p.remove(f,"blur",s,a)}},o=!0,q=!1,w=null;a.refreshAll=a.refreshAll;r.focusManager=a;r.getInstances=function(){return m};return a},{requires:["./base","./dom"]});
KISSY.add("editor/core/walker",function(a,n){function s(e,b){if(this._.end)return h;var c,a=this.range,g,d=this.guard,k=this.type,u=e?"_4e_previousSourceNode":"_4e_nextSourceNode";if(!this._.start&&(this._.start=1,a.trim(),a.collapsed))return this.end(),h;if(!e&&!this._.guardLTR){var o=a.endContainer[0],n=o.childNodes[a.endOffset];this._.guardLTR=function(c,a){return a&&(o==c||"body"==q.nodeName(c))?!1:c!=n}}if(e&&!this._.guardRTL){var r=a.startContainer[0],H=0<a.startOffset&&r.childNodes[a.startOffset-
1]||null;this._.guardRTL=function(c,a){return a&&(r==c||"body"==q.nodeName(c))?!1:c!=H}}var K=e?this._.guardRTL:this._.guardLTR;g=d?function(c,a){return K(c,a)===f?f:d(c,a)}:K;this.current?c=this.current[u](f,k,g):e?(c=a.endContainer,0<a.endOffset?(c=new j(c[0].childNodes[a.endOffset-1]),g(c[0])===f&&(c=h)):c=g(c,m)===f?h:c._4e_previousSourceNode(m,k,g,void 0)):(c=a.startContainer,c=new j(c[0].childNodes[a.startOffset]),c.length?g(c[0])===f&&(c=h):c=g(a.startContainer,m)===f?h:a.startContainer._4e_nextSourceNode(m,
k,g,void 0));for(;c&&!this._.end;){this.current=c;if(!this.evaluator||this.evaluator(c[0])!==f){if(!b)return c}else if(b&&this.evaluator)return f;c=c[u](f,k,g)}this.end();return this.current=h}function r(a){for(var b,c=h;b=s.call(this,a);)c=b;return c}function p(a){this.range=a;this.guard=this.evaluator=h;this._={}}var m=!0,f=!1,h=null,o=a.UA,q=a.DOM,w=n.XHTML_DTD,j=a.Node;a.augment(p,{end:function(){this._.end=1},next:function(){return s.call(this)},previous:function(){return s.call(this,m)},checkForward:function(){return s.call(this,
f,m)!==f},checkBackward:function(){return s.call(this,m,m)!==f},lastForward:function(){return r.call(this)},lastBackward:function(){return r.call(this,m)},reset:function(){delete this.current;this._={}},_iterator:s});a.mix(p,{blockBoundary:function(a){return function(b){return!(b.nodeType==q.NodeType.ELEMENT_NODE&&q._4e_isBlockBoundary(b,a))}},bookmark:function(a,b){function c(c){return"span"==q.nodeName(c)&&q.attr(c,"_ke_bookmark")}return function(d){var g,i;g=d.nodeType==q.NodeType.TEXT_NODE&&(i=
d.parentNode)&&c(i);g=a?g:g||c(d);return!!(b^g)}},whitespaces:function(b){return function(d){d=d.nodeType==q.NodeType.TEXT_NODE&&!a.trim(d.nodeValue);return!!(b^d)}},invisible:function(a){var b=p.whitespaces();return function(c){c=b(c)||c.nodeType==q.NodeType.ELEMENT_NODE&&!c.offsetHeight;return!!(a^c)}}});var v=/^[\t\r\n ]*(?:&nbsp;|\xa0)$/,x=p.whitespaces(),d=p.bookmark(),b=function(a){var b=q.nodeName(a);return d(a)||x(a)||1==a.nodeType&&b in w.$inline&&!(b in w.$empty)};n.Utils.injectDom({_4e_getBogus:function(a){a=
new j(a);do a=a._4e_previousSourceNode();while(a&&b(a[0]));return a&&(!o.ie?"br"==a.nodeName():3==a[0].nodeType&&v.test(a.text()))?a[0]:!1}});return n.Walker=p},{requires:["./base","./utils","./dom"]});
KISSY.add("editor/core/elementPath",function(a){function n(a){for(var q=m,n=m,j=[];a;){if(a[0].nodeType==r.NodeType.ELEMENT_NODE){this.lastElement||(this.lastElement=a);var v=a.nodeName();if(!n&&(!q&&f[v]&&(q=a),h[v])){var x;if(x=!q)if(x="div"==v){a:{x=a[0].childNodes;for(var d=0,b=x.length;d<b;d++){var e=x[d];if(e.nodeType==r.NodeType.ELEMENT_NODE&&p.$block[e.nodeName.toLowerCase()]){x=!0;break a}}x=!1}x=!x}x?q=a:n=a}j.push(a);if("body"==v)break}a=a.parent()}this.block=q;this.blockLimit=n;this.elements=
j}var s=a.Editor,r=a.DOM,p=s.XHTML_DTD,m=null,f={address:1,blockquote:1,dl:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1,li:1,dt:1,dd:1},h={body:1,div:1,table:1,tbody:1,tr:1,td:1,th:1,caption:1,form:1};n.prototype={constructor:n,compare:function(a){var f=this.elements,a=a&&a.elements;if(!a||f.length!=a.length)return!1;for(var h=0;h<f.length;h++)if(!r.equals(f[h],a[h]))return!1;return!0},contains:function(a){for(var f=this.elements,h=0;h<f.length;h++)if(f[h].nodeName()in a)return f[h];return m},toString:function(){var a=
this.elements,f,h=[];for(f=0;f<a.length;f++)h.push(a[f].nodeName());return h.toString()}};return s.ElementPath=n},{requires:["./base","./dom"]});
KISSY.add("editor/core/range",function(a,n,s,r,p){function m(b){var g=b.nodeType!=e.NodeType.TEXT_NODE&&e.nodeName(b)in c.$removeEmpty,d=b.nodeType==e.NodeType.TEXT_NODE&&!a.trim(b.nodeValue),b=!!b.parentNode.getAttribute("_ke_bookmark");return g||d||b}function f(a){return!k(a)&&!u(a)}function h(c){var b=v;return function(g){if(u(g))return j;if(g.nodeType==e.NodeType.TEXT_NODE){if(a.trim(g.nodeValue).length)return v}else if(g.nodeType==e.NodeType.ELEMENT_NODE&&(g=e.nodeName(g),!D[g]))if(!c&&!F.ie&&
"br"==g&&!b)b=j;else return v;return j}}function o(a,c){var b=a.startContainer,g=a.endContainer,d=a.startOffset,y=a.endOffset,i,k=v,f=v,h=void 0,u=a.document,n;0<c&&(h=u.createDocumentFragment());if(a.collapsed)return h;a.optimizeBookmark();g[0].nodeType==e.NodeType.TEXT_NODE?(f=j,g=g._4e_splitText(y)):0<g[0].childNodes.length&&(y>=g[0].childNodes.length?(g=new l(g[0].appendChild(u.createTextNode(""))),n=j):g=new l(g[0].childNodes[y]));b[0].nodeType==e.NodeType.TEXT_NODE?(k=j,b._4e_splitText(d)):
d?d>=b[0].childNodes.length?(b=new l(b[0].appendChild(u.createTextNode(""))),i=j):b=new l(b[0].childNodes[d].previousSibling):(i=new l(u.createTextNode("")),b.prepend(i),b=i,i=j);var I=b._4e_parents(),L=g._4e_parents();I.each(function(a,b){I[b]=a});L.each(function(a,b){L[b]=a});for(var E,N,u=0;u<I.length&&!(E=I[u],N=L[u],!E.equals(N));u++);for(var d=h,A,t,O=u;O<I.length;O++){A=I[O];y=0<c&&!A.equals(b)?d.appendChild(A.clone()[0]):null;A=A[0].nextSibling;t=L[O];for(var m=g[0],q=t&&t[0];A&&!(q==A||m==
A);)t=A.nextSibling,2==c?d.appendChild(A.cloneNode(j)):(e._4e_remove(A),1==c&&d.appendChild(A)),A=t;y&&(d=y)}for(d=h;u<L.length;u++){A=L[u];y=0<c&&!A.equals(g)?d.appendChild(A.clone()[0]):null;if(!I[u]||!A._4e_sameLevel(I[u]))for(A=A[0].previousSibling;A;)t=A.previousSibling,2==c?d.insertBefore(A.cloneNode(j),d.firstChild):(e._4e_remove(A),1==c&&d.insertBefore(A,d.firstChild)),A=t;y&&(d=y)}if(2==c){if(k&&(E=b[0],E.nodeType==e.NodeType.TEXT_NODE&&E.nextSibling&&E.nextSibling.nodeType==e.NodeType.TEXT_NODE&&
(E.data+=E.nextSibling.data,E.parentNode.removeChild(E.nextSibling))),f)f=g[0],f.nodeType==e.NodeType.TEXT_NODE&&f.previousSibling&&f.previousSibling.nodeType==e.NodeType.TEXT_NODE&&(f.previousSibling.data+=f.data,f.parentNode.removeChild(f))}else{if(E&&N&&(!b._4e_sameLevel(E)||!g._4e_sameLevel(N)))f=E._4e_index(),i&&E._4e_sameLevel(b)&&f--,a.setStart(E.parent(),f+1);a.collapse(j)}i&&b.remove();n&&g.remove();return h}function q(a){a.collapsed=a.startContainer&&a.endContainer&&a.startContainer[0]==
a.endContainer[0]&&a.startOffset==a.endOffset}function w(a){this.endOffset=this.endContainer=this.startOffset=this.startContainer=x;this.collapsed=j;this.document=a}n.RANGE={POSITION_AFTER_START:1,POSITION_BEFORE_END:2,POSITION_BEFORE_START:3,POSITION_AFTER_END:4,ENLARGE_ELEMENT:1,ENLARGE_BLOCK_CONTENTS:2,ENLARGE_LIST_ITEM_CONTENTS:3,START:1,END:2,SHRINK_ELEMENT:1,SHRINK_TEXT:2};var j=!0,v=!1,x=null,d=n.RANGE,b=n.POSITION,e=a.DOM,F=a.UA,c=n.XHTML_DTD,l=a.Node,g=l.all,i={area:1,base:1,br:1,col:1,hr:1,
img:1,input:1,link:1,meta:1,param:1},k=new r.whitespaces,u=new r.bookmark,t=r.whitespaces(j),z=r.bookmark(!1,!0),D={abbr:1,acronym:1,b:1,bdo:1,big:1,cite:1,code:1,del:1,dfn:1,em:1,font:1,i:1,ins:1,label:1,kbd:1,q:1,samp:1,small:1,span:1,strike:1,strong:1,sub:1,sup:1,tt:1,u:1,"var":1};a.augment(w,{toString:function(){var a=[],b=this.startContainer[0],c=this.endContainer[0];a.push((b.id||b.nodeName)+":"+this.startOffset);a.push((c.id||c.nodeName)+":"+this.endOffset);return a.join("<br/>")},optimize:function(){var a=
this.startContainer,b=this.startOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setStartAfter(a):this.setStartBefore(a));a=this.endContainer;b=this.endOffset;a[0].nodeType!=e.NodeType.ELEMENT_NODE&&(b?b>=a[0].nodeValue.length&&this.setEndAfter(a):this.setEndBefore(a))},setStartAfter:function(a){this.setStart(a.parent(),a._4e_index()+1)},setStartBefore:function(a){this.setStart(a.parent(),a._4e_index())},setEndAfter:function(a){this.setEnd(a.parent(),a._4e_index()+
1)},setEndBefore:function(a){this.setEnd(a.parent(),a._4e_index())},optimizeBookmark:function(){var a=this.startContainer,b=this.endContainer;a&&"span"==a.nodeName()&&a.attr("_ke_bookmark")&&this.setStartBefore(a);b&&"span"==b.nodeName()&&b.attr("_ke_bookmark")&&this.setEndAfter(b)},setStart:function(a,b){a[0].nodeType==e.NodeType.ELEMENT_NODE&&i[a.nodeName()]&&(a=a.parent(),b=a._4e_index());this.startContainer=a;this.startOffset=b;this.endContainer||(this.endContainer=a,this.endOffset=b);q(this)},
setEnd:function(a,b){a[0].nodeType==e.NodeType.ELEMENT_NODE&&i[a.nodeName()]&&(a=a.parent(),b=a._4e_index()+1);this.endContainer=a;this.endOffset=b;this.startContainer||(this.startContainer=a,this.startOffset=b);q(this)},setStartAt:function(a,b){switch(b){case d.POSITION_AFTER_START:this.setStart(a,0);break;case d.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setStart(a,a[0].nodeValue.length):this.setStart(a,a[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setStartBefore(a);
break;case d.POSITION_AFTER_END:this.setStartAfter(a)}q(this)},setEndAt:function(a,b){switch(b){case d.POSITION_AFTER_START:this.setEnd(a,0);break;case d.POSITION_BEFORE_END:a[0].nodeType==e.NodeType.TEXT_NODE?this.setEnd(a,a[0].nodeValue.length):this.setEnd(a,a[0].childNodes.length);break;case d.POSITION_BEFORE_START:this.setEndBefore(a);break;case d.POSITION_AFTER_END:this.setEndAfter(a)}q(this)},cloneContents:function(){return o(this,2)},deleteContents:function(){return o(this,0)},extractContents:function(){return o(this,
1)},collapse:function(a){a?(this.endContainer=this.startContainer,this.endOffset=this.startOffset):(this.startContainer=this.endContainer,this.startOffset=this.endOffset);this.collapsed=j},clone:function(){var a=new w(this.document);a.startContainer=this.startContainer;a.startOffset=this.startOffset;a.endContainer=this.endContainer;a.endOffset=this.endOffset;a.collapsed=this.collapsed;return a},getEnclosedNode:function(){var a=this.clone();a.optimize();if(a.startContainer[0].nodeType!=e.NodeType.ELEMENT_NODE||
a.endContainer[0].nodeType!=e.NodeType.ELEMENT_NODE)return x;var b=new r(a);b.evaluator=function(a){return t(a)&&z(a)};a=b.next();b.reset();b=b.previous();return a&&a.equals(b)?a:x},shrink:function(a,b){if(!this.collapsed){var a=a||d.SHRINK_TEXT,c=this.clone(),g=this.startContainer,i=this.endContainer,y=this.startOffset,l=this.endOffset,f=j,k,u,h=j;g&&g[0].nodeType==e.NodeType.TEXT_NODE&&(y?y>=g[0].nodeValue.length?c.setStartAfter(g):(c.setStartBefore(g),f=v):c.setStartBefore(g));i&&i[0].nodeType==
e.NodeType.TEXT_NODE&&(l?l>=i[0].nodeValue.length?c.setEndAfter(i):(c.setEndAfter(i),h=v):c.setEndBefore(i));if(f||h)u=new r(c),u.evaluator=function(b){return b.nodeType==(a==d.SHRINK_ELEMENT?e.NodeType.ELEMENT_NODE:e.NodeType.TEXT_NODE)},u.guard=function(b,c){if(a==d.SHRINK_ELEMENT&&b.nodeType==e.NodeType.TEXT_NODE||c&&b==k)return v;!c&&b.nodeType==e.NodeType.ELEMENT_NODE&&(k=b);return j};f&&(c=u[a==d.SHRINK_ELEMENT?"lastForward":"next"]())&&this.setStartAt(c,b?d.POSITION_AFTER_START:d.POSITION_BEFORE_START);
h&&(u.reset(),(u=u[a==d.SHRINK_ELEMENT?"lastBackward":"previous"]())&&this.setEndAt(u,b?d.POSITION_BEFORE_END:d.POSITION_AFTER_END));return f||h}},createBookmark2:function(a){var b=this.startContainer,c=this.endContainer,g=this.startOffset,d=this.endOffset,i,f;if(!b||!c)return{start:0,end:0};if(a){if(b[0].nodeType==e.NodeType.ELEMENT_NODE&&(i=new l(b[0].childNodes[g]))&&i[0]&&i[0].nodeType==e.NodeType.TEXT_NODE&&0<g&&i[0].previousSibling.nodeType==e.NodeType.TEXT_NODE)b=i,g=0;for(;b[0].nodeType==
e.NodeType.TEXT_NODE&&(f=b.prev(void 0,1))&&f[0].nodeType==e.NodeType.TEXT_NODE;)b=f,g+=f[0].nodeValue.length;if(!this.collapsed){if(c[0].nodeType==e.NodeType.ELEMENT_NODE&&(i=new l(c[0].childNodes[d]))&&i[0]&&i[0].nodeType==e.NodeType.TEXT_NODE&&0<d&&i[0].previousSibling.nodeType==e.NodeType.TEXT_NODE)c=i,d=0;for(;c[0].nodeType==e.NodeType.TEXT_NODE&&(f=c.prev(void 0,1))&&f[0].nodeType==e.NodeType.TEXT_NODE;)c=f,d+=f[0].nodeValue.length}}return{start:b._4e_address(a),end:this.collapsed?x:c._4e_address(a),
startOffset:g,endOffset:d,normalized:a,is2:j}},createBookmark:function(b){var c,g,e,i,f=this.collapsed;c=new l("<span>",x,this.document);c.attr("_ke_bookmark",1);c.css("display","none");c.html("&nbsp;");b&&(e=a.guid("ke_bm_"),c.attr("id",e+"S"));f||(g=c.clone(),g.html("&nbsp;"),b&&g.attr("id",e+"E"),i=this.clone(),i.collapse(),i.insertNode(g));i=this.clone();i.collapse(j);i.insertNode(c);g?(this.setStartAfter(c),this.setEndBefore(g)):this.moveToPosition(c,d.POSITION_AFTER_END);return{startNode:b?
e+"S":c,endNode:b?e+"E":g,serializable:b,collapsed:f}},moveToPosition:function(a,b){this.setStartAt(a,b);this.collapse(j)},trim:function(a,b){var c=this.startContainer,g=this.startOffset,d=this.collapsed;if((!a||d)&&c[0]&&c[0].nodeType==e.NodeType.TEXT_NODE){if(g)if(g>=c[0].nodeValue.length)g=c._4e_index()+1,c=c.parent();else{var i=c._4e_splitText(g),g=c._4e_index()+1,c=c.parent();e.equals(this.startContainer,this.endContainer)?this.setEnd(i,this.endOffset-this.startOffset):e.equals(c,this.endContainer)&&
(this.endOffset+=1)}else g=c._4e_index(),c=c.parent();this.setStart(c,g);if(d){this.collapse(j);return}}c=this.endContainer;g=this.endOffset;!b&&!d&&c[0]&&c[0].nodeType==e.NodeType.TEXT_NODE&&(g?(g>=c[0].nodeValue.length||c._4e_splitText(g),g=c._4e_index()+1):g=c._4e_index(),c=c.parent(),this.setEnd(c,g))},insertNode:function(a){this.optimizeBookmark();this.trim(v,j);var b=this.startContainer;b[0].insertBefore(a[0],b[0].childNodes[this.startOffset]||null);b[0]==this.endContainer[0]&&this.endOffset++;
this.setStartBefore(a)},moveToBookmark:function(b){var c=g(this.document);if(b.is2){var d=c._4e_getByAddress(b.start,b.normalized),e=b.startOffset,c=b.end&&c._4e_getByAddress(b.end,b.normalized),b=b.endOffset;this.setStart(d,e);c?this.setEnd(c,b):this.collapse(j)}else d=(e=b.serializable)?a.one("#"+b.startNode,c):b.startNode,b=e?a.one("#"+b.endNode,c):b.endNode,this.setStartBefore(d),d._4e_remove(),b&&b[0]?(this.setEndBefore(b),b._4e_remove()):this.collapse(j)},getCommonAncestor:function(a,b){var c=
this.startContainer,g=this.endContainer,c=c[0]==g[0]?a&&c[0].nodeType==e.NodeType.ELEMENT_NODE&&this.startOffset==this.endOffset-1?new l(c[0].childNodes[this.startOffset]):c:c._4e_commonAncestor(g);return b&&c[0].nodeType==e.NodeType.TEXT_NODE?c.parent():c},enlarge:function(){function a(b,c,d,i){var l=b[c?"startContainer":"endContainer"],f,h=c?0:1,j=0,t=c?"previousSibling":"nextSibling";f=b[c?"startOffset":"endOffset"];if(l[0].nodeType==e.NodeType.TEXT_NODE){if(c){if(f)return}else if(f<l[0].nodeValue.length)return;
f=l[0][t];l=l[0].parentNode}else f=l[0].childNodes[f+(c?-1:1)]||null,l=l[0];for(;l;){for(;f;)if(k(f)||u(f))f=f[t];else break;if(f){if(!j)b[c?"setStartAfter":"setEndBefore"](g(f));break}l=g(l);if("body"==l.nodeName())break;if(j||l.equals(i))d[h]=l,j=1;else b[c?"setStartBefore":"setEndAfter"](l);f=l[0][t];l=l[0].parentNode}}return function(b){switch(b){case d.ENLARGE_ELEMENT:if(this.collapsed)break;var b=this.getCommonAncestor(),c=[];a(this,1,c,b);a(this,0,c,b);c[0]&&c[1]&&(b=c[0].contains(c[1])?c[1]:
c[0],this.setStartBefore(b),this.setEndAfter(b));break;case d.ENLARGE_BLOCK_CONTENTS:case d.ENLARGE_LIST_ITEM_CONTENTS:var i=new w(this.document),c=new l(this.document.body);i.setStartAt(c,d.POSITION_AFTER_START);i.setEnd(this.startContainer,this.startOffset);var i=new r(i),f,k,u=r.blockBoundary(b==d.ENLARGE_LIST_ITEM_CONTENTS?{br:1}:x),h=function(a){var b=u(a);b||(f=g(a));return b},j=function(a){var b=h(a);!b&&"br"==e.nodeName(a)&&(k=g(a));return b};i.guard=h;i=i.lastBackward();f=f||c;this.setStartAt(f,
"br"!=f.nodeName()&&(!i&&this.checkStartOfBlock()||i&&f.contains(i))?d.POSITION_AFTER_START:d.POSITION_AFTER_END);i=this.clone();i.collapse();i.setEndAt(c,d.POSITION_BEFORE_END);i=new r(i);i.guard=b==d.ENLARGE_LIST_ITEM_CONTENTS?j:h;f=x;i=i.lastForward();f=f||c;this.setEndAt(f,!i&&this.checkEndOfBlock()||i&&f.contains(i)?d.POSITION_BEFORE_END:d.POSITION_BEFORE_START);k&&this.setEndAfter(k)}}}(),checkStartOfBlock:function(){var b=this.startContainer,c=this.startOffset;if(c&&b[0].nodeType==e.NodeType.TEXT_NODE&&
a.trim(b[0].nodeValue.substring(0,c)).length)return v;this.trim();b=new p(this.startContainer);c=this.clone();c.collapse(j);c.setStartAt(b.block||b.blockLimit,d.POSITION_AFTER_START);b=new r(c);b.evaluator=h(j);return b.checkBackward()},checkEndOfBlock:function(){var b=this.endContainer,c=this.endOffset;if(b[0].nodeType==e.NodeType.TEXT_NODE&&a.trim(b[0].nodeValue.substring(c)).length)return v;this.trim();b=new p(this.endContainer);c=this.clone();c.collapse(v);c.setEndAt(b.block||b.blockLimit,d.POSITION_BEFORE_END);
b=new r(c);b.evaluator=h(v);return b.checkForward()},checkBoundaryOfElement:function(a,b){var c=this.clone();c[b==d.START?"setStartAt":"setEndAt"](a,b==d.START?d.POSITION_AFTER_START:d.POSITION_BEFORE_END);c=new r(c);c.evaluator=m;return c[b==d.START?"checkBackward":"checkForward"]()},getBoundaryNodes:function(){var a=this.startContainer,c=this.endContainer,d=this.startOffset,i=this.endOffset,f;if(a[0].nodeType==e.NodeType.ELEMENT_NODE)if(f=a[0].childNodes.length,f>d)a=g(a[0].childNodes[d]);else if(0==
f)a=a._4e_previousSourceNode();else{for(a=a[0];a.lastChild;)a=a.lastChild;a=g(a);a=a._4e_nextSourceNode()||a}if(c[0].nodeType==e.NodeType.ELEMENT_NODE)if(f=c[0].childNodes.length,f>i)c=g(c[0].childNodes[i])._4e_previousSourceNode(j);else if(0==f)c=c._4e_previousSourceNode();else{for(c=c[0];c.lastChild;)c=c.lastChild;c=g(c)}a._4e_position(c)&b.POSITION_FOLLOWING&&(a=c);return{startNode:a,endNode:c}},fixBlock:function(a,b){var c=this.createBookmark(),i=g(this.document.createElement(b));this.collapse(a);
this.enlarge(d.ENLARGE_BLOCK_CONTENTS);i[0].appendChild(this.extractContents());i._4e_trim();F.ie||i._4e_appendBogus();this.insertNode(i);this.moveToBookmark(c);return i},splitBlock:function(b){var c=new p(this.startContainer),g=new p(this.endContainer),i=c.block,e=g.block,f=x;if(!c.blockLimit.equals(g.blockLimit))return x;"br"!=b&&(i||(i=this.fixBlock(j,b),e=(new p(this.endContainer)).block),e||(e=this.fixBlock(v,b)));b=i&&this.checkStartOfBlock();c=e&&this.checkEndOfBlock();this.deleteContents();
i&&i[0]==e[0]&&(c?(f=new p(this.startContainer),this.moveToPosition(e,d.POSITION_AFTER_END),e=x):b?(f=new p(this.startContainer),this.moveToPosition(i,d.POSITION_BEFORE_START),i=x):(e=this.splitElement(i),!F.ie&&!a.inArray(i.nodeName(),["ul","ol"])&&i._4e_appendBogus()));return{previousBlock:i,nextBlock:e,wasStartOfBlock:b,wasEndOfBlock:c,elementPath:f}},splitElement:function(a){if(!this.collapsed)return x;this.setEndAt(a,d.POSITION_BEFORE_END);var b=this.extractContents(),c=a.clone(v);c[0].appendChild(b);
c.insertAfter(a);this.moveToPosition(a,d.POSITION_AFTER_END);return c},moveToElementEditablePosition:function(a,b){for(var c=0;a;){if(a[0].nodeType==e.NodeType.TEXT_NODE){this.moveToPosition(a,b?d.POSITION_AFTER_END:d.POSITION_BEFORE_START);c=1;break}a[0].nodeType==e.NodeType.ELEMENT_NODE&&a._4e_isEditable()&&(this.moveToPosition(a,b?d.POSITION_BEFORE_END:d.POSITION_AFTER_START),c=1);var g=a,i=c,l=void 0;g[0].nodeType==e.NodeType.ELEMENT_NODE&&g._4e_isEditable()&&(l=g[b?"last":"first"](f,1));!i&&
!l&&(l=g[b?"prev":"next"](f,1));a=l}return!!c},selectNodeContents:function(a){var b=a[0];this.setStart(a,0);this.setEnd(a,b.nodeType==e.NodeType.TEXT_NODE?b.nodeValue.length:b.childNodes.length)},insertNodeByDtd:function(a){var b,g,d,i=a.nodeName();b=c.$block[i];this.deleteContents();if(b){for(b=this.getCommonAncestor(v,j);(g=c[b.nodeName()])&&(!g||!g[i]);){var e=b.parent();this.checkStartOfBlock()&&this.checkEndOfBlock()?(this.setStartBefore(b),this.collapse(j),b.remove()):d=b;b=e}d&&this.splitElement(d)}this.insertNode(a)}});
s.injectDom({_4e_breakParent:function(a,b){var b=g(b),a=g(a),c,d=new n.Range(a[0].ownerDocument);d.setStartAfter(a);d.setEndAfter(b);c=d.extractContents();d.insertNode(a.remove());a.after(c)}});return n.Range=w},{requires:["./base","./utils","./walker","./elementPath","./dom"]});
KISSY.add("editor/core/selection",function(a){function n(a){this.document=a;this._={cache:{}};if(j)try{var b=this.getNative().createRange();if(!b||b.item&&b.item(0).ownerDocument!=a||b.parentElement&&b.parentElement().ownerDocument!=a)this.isInvalid=p}catch(g){this.isInvalid=p}}function s(a){a=new n(a);return!a||a.isInvalid?m:a}var r=a.Editor;r.SELECTION={SELECTION_NONE:1,SELECTION_TEXT:2,SELECTION_ELEMENT:3};var p=!0,m=null,f=a.UA,h=a.DOM,o=a.Node,q=r.SELECTION,w=r.RANGE,j=f.ie,v=r.Walker,x=r.Range,
d={img:1,hr:1,li:1,table:1,tr:1,td:1,th:1,embed:1,object:1,ol:1,ul:1,a:1,input:1,form:1,select:1,textarea:1,button:1,fieldset:1,thead:1,tfoot:1};a.augment(n,{getNative:!j?function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=h.getWindow(this.document).getSelection())}:function(){var a=this._.cache;return a.nativeSel||(a.nativeSel=this.document.selection)},getType:!j?function(){var a=this._.cache;if(a.type)return a.type;var b=q.SELECTION_TEXT,g=this.getNative();if(g){if(1==g.rangeCount){var g=
g.getRangeAt(0),i=g.startContainer;i==g.endContainer&&i.nodeType==h.NodeType.ELEMENT_NODE&&1==Number(g.endOffset-g.startOffset)&&d[i.childNodes[g.startOffset].nodeName.toLowerCase()]&&(b=q.SELECTION_ELEMENT)}}else b=q.SELECTION_NONE;return a.type=b}:function(){var a=this._.cache;if(a.type)return a.type;var b=q.SELECTION_NONE;try{var g=this.getNative(),d=g.type;"Text"==d&&(b=q.SELECTION_TEXT);"Control"==d&&(b=q.SELECTION_ELEMENT);g.createRange().parentElement&&(b=q.SELECTION_TEXT)}catch(e){}return a.type=
b},getRanges:j?function(){var a=function(a,b){a=a.duplicate();a.collapse(b);for(var c=a.parentElement(),d=c.childNodes,e,f=0;f<d.length;f++){var j=d[f];if(j.nodeType==h.NodeType.ELEMENT_NODE){e=a.duplicate();e.moveToElementText(j);var j=e.compareEndPoints("StartToStart",a),n=e.compareEndPoints("EndToStart",a);e.collapse();if(0<j)break;else{if(!j||1==n&&-1==j)return{container:c,offset:f};if(!n)return{container:c,offset:f+1}}e=m}}e||(e=a.duplicate(),e.moveToElementText(c),e.collapse(!1));e.setEndPoint("StartToStart",
a);e=(""+e.text).replace(/\r\n|\r/g,"\n").length;try{for(;0<e;)e-=d[--f].nodeValue.length}catch(q){e=0}return 0===e?{container:c,offset:f}:{container:d[f],offset:-e}};return function(b){var g=this._.cache;if(g.ranges&&!b)return g.ranges;var d=this.getNative(),b=d&&d.createRange(),e=this.getType();if(!d)return[];if(e==q.SELECTION_TEXT)return d=new x(this.document),e=a(b,p),d.setStart(new o(e.container),e.offset),e=a(b),d.setEnd(new o(e.container),e.offset),g.ranges=[d];if(e==q.SELECTION_ELEMENT){g=
g.ranges=[];for(e=0;e<b.length;e++){for(var f=b.item(e),h=f.parentNode,j=0,d=new x(this.document);j<h.childNodes.length&&h.childNodes[j]!=f;j++);d.setStart(new o(h),j);d.setEnd(new o(h),j+1);g.push(d)}return g}return g.ranges=[]}}():function(a){var b=this._.cache;if(b.ranges&&!a)return b.ranges;var a=[],g=this.getNative();if(!g)return[];for(var d=0;d<g.rangeCount;d++){var e=g.getRangeAt(d),f=new x(this.document);f.setStart(new o(e.startContainer),e.startOffset);f.setEnd(new o(e.endContainer),e.endOffset);
a.push(f)}return b.ranges=a},getStartElement:function(){var a=this._.cache;if(void 0!==a.startElement)return a.startElement;var b,g=this.getNative();switch(this.getType()){case q.SELECTION_ELEMENT:return this.getSelectedElement();case q.SELECTION_TEXT:var d=this.getRanges()[0];if(d&&!d.collapsed){for(d.optimize();p;)if(b=d.startContainer,d.startOffset==(b[0].nodeType===h.NodeType.ELEMENT_NODE?b[0].childNodes.length:b[0].nodeValue.length)&&!b._4e_isBlockBoundary())d.setStartAfter(b);else break;b=d.startContainer;
if(b[0].nodeType!=h.NodeType.ELEMENT_NODE)return b.parent();b=new o(b[0].childNodes[d.startOffset]);if(!b[0]||b[0].nodeType!=h.NodeType.ELEMENT_NODE)return d.startContainer;for(d=b[0].firstChild;d&&d.nodeType==h.NodeType.ELEMENT_NODE;)b=new o(d),d=d.firstChild;return b}if(j)d=g.createRange(),d.collapse(p),b=new o(d.parentElement());else{if((b=g.anchorNode)&&b.nodeType!=h.NodeType.ELEMENT_NODE)b=b.parentNode;b&&(b=new o(b))}}return a.startElement=b},getSelectedElement:function(){var a,b=this._.cache;
if(void 0!==b.selectedElement)return b.selectedElement;j&&(a=this.getNative().createRange(),a=a.item&&a.item(0));var g;if(a)g=new o(a);else{a=this.getRanges()[0];for(var e,f=2;f&&(!(g=a.getEnclosedNode())||!(g[0].nodeType==h.NodeType.ELEMENT_NODE&&d[g.nodeName()]&&(e=g)));f--)a.shrink(w.SHRINK_ELEMENT);g=e}return b.selectedElement=g},reset:function(){this._.cache={}},selectElement:function(a){var b,d=this.document;if(j)try{b=d.body.createControlRange(),b.addElement(a[0]),b.select()}catch(e){b=d.body.createTextRange(),
b.moveToElementText(a[0]),b.select()}finally{}else b=d.createRange(),b.selectNode(a[0]),a=this.getNative(),a.removeAllRanges(),a.addRange(b);this.reset()},selectRanges:function(a){if(j){if(1<a.length){var b=a[a.length-1];a[0].setEnd(b.endContainer,b.endOffset);a.length=1}a[0]&&a[0].select()}else{b=this.getNative();if(!b)return;b.removeAllRanges();for(var d=0;d<a.length;d++){var e=a[d],k=this.document.createRange(),u=e.startContainer;if(e.collapsed&&(f.gecko&&1.09>f.gecko||f.opera||f.webkit)&&u[0].nodeType==
h.NodeType.ELEMENT_NODE&&!u[0].childNodes.length)u[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),e.startOffset++,e.endOffset++;k.setStart(u[0],e.startOffset);k.setEnd(e.endContainer[0],e.endOffset);b.addRange(k)}}this.reset()},createBookmarks2:function(a){for(var b=[],d=this.getRanges(),e=0;e<d.length;e++)b.push(d[e].createBookmark2(a));return b},createBookmarks:function(b,d){for(var g=[],e=this.document,f,d=d||this.getRanges(),j=d.length,n=0;n<j;n++){g.push(f=d[n].createBookmark(b,
p));var q=(b=f.serializable)?a.one("#"+f.startNode,e):f.startNode;f=b?a.one("#"+f.endNode,e):f.endNode;for(var m=n+1;m<j;m++){var o=d[m],r=o.startContainer,v=o.endContainer;h.equals(r,q.parent())&&o.startOffset++;h.equals(r,f.parent())&&o.startOffset++;h.equals(v,q.parent())&&o.endOffset++;h.equals(v,f.parent())&&o.endOffset++}}return g},selectBookmarks:function(a){for(var b=[],d=0;d<a.length;d++){var e=new x(this.document);e.moveToBookmark(a[d]);b.push(e)}this.selectRanges(b);return this},getCommonAncestor:function(){var a=
this.getRanges();return a[0].startContainer._4e_commonAncestor(a[a.length-1].endContainer)},scrollIntoView:function(){var a=this.getStartElement();a&&a.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0})},removeAllRanges:function(){var a=this.getNative();j?a&&a.clear():a&&a.removeAllRanges()}});var b={table:1,tbody:1,tr:1},e=v.whitespaces(p),F=/\ufeff|\u00a0/;x.prototype.select=x.prototype.select=!j?function(){var a=this.startContainer;this.collapsed&&a[0].nodeType==
h.NodeType.ELEMENT_NODE&&!a[0].childNodes.length&&(a[0].appendChild(this.document.createTextNode(f.webkit?"\u200b":"")),this.startOffset++,this.endOffset++);var b=this.document.createRange();b.setStart(a[0],this.startOffset);try{b.setEnd(this.endContainer[0],this.endOffset)}catch(d){if(0<=d.toString().indexOf("NS_ERROR_ILLEGAL_VALUE"))this.collapse(p),b.setEnd(this.endContainer[0],this.endOffset);else throw d;}a=s(this.document).getNative();a.removeAllRanges();a.addRange(b)}:function(a){var d=this.collapsed,
g,f;if(this.startContainer[0]===this.endContainer[0]&&1==this.endOffset-this.startOffset){var k=this.startContainer[0].childNodes[this.startOffset];if(k.nodeType==h.NodeType.ELEMENT_NODE){(new n(this.document)).selectElement(new o(k));return}}(this.startContainer[0].nodeType==h.NodeType.ELEMENT_NODE&&this.startContainer.nodeName()in b||this.endContainer[0].nodeType==h.NodeType.ELEMENT_NODE&&this.endContainer.nodeName()in b)&&this.shrink(w.SHRINK_ELEMENT,p);var j=this.createBookmark(),k=j.startNode,
m;d||(m=j.endNode);j=this.document.body.createTextRange();j.moveToElementText(k[0]);j.moveStart("character",1);if(m)a=this.document.body.createTextRange(),a.moveToElementText(m[0]),j.setEndPoint("EndToEnd",a),j.moveEnd("character",-1);else{for(g=k[0].nextSibling;g&&!e(g);)g=g.nextSibling;g=!(g&&g.nodeValue&&g.nodeValue.match(F))&&(a||!k[0].previousSibling||k[0].previousSibling&&"br"==h.nodeName(k[0].previousSibling));f=new o(this.document.createElement("span"));f.html("&#65279;");f.insertBefore(k);
g&&h.insertBefore(this.document.createTextNode("\ufeff"),k[0]||k)}this.setStartBefore(k);k._4e_remove();if(d){if(g?(j.moveStart("character",-1),j.select(),this.document.selection.clear()):j.select(),f)this.moveToPosition(f,w.POSITION_BEFORE_START),f._4e_remove()}else this.setEndBefore(m),m._4e_remove(),j.select()};n.getSelection=s;return r.Selection=n},{requires:["./base","./walker","./range","./dom"]});
KISSY.add("editor/core/domIterator",function(a){function n(a){1>arguments.length||(this.range=a,this.forceBrBreak=r,this.enlargeBr=s,this.enforceRealBlocks=r,this._||(this._={}))}var s=!0,r=!1,p=a.Editor,m=a.UA,f=p.Walker,h=p.Range,o=p.RANGE,q=p.ElementPath,w=a.Node,j=a.DOM,v=/^[\r\n\t ]*$/;a.augment(n,{getNextParagraph:function(n){var d,b,e,p,c;if(!this._.lastNode){b=this.range.clone();b.shrink(o.SHRINK_ELEMENT,s);b.enlarge(this.forceBrBreak||!this.enlargeBr?o.ENLARGE_LIST_ITEM_CONTENTS:o.ENLARGE_BLOCK_CONTENTS);
var l=new f(b),g=f.bookmark(s,s);l.evaluator=g;this._.nextNode=l.next();l=new f(b);l.evaluator=g;l=l.previous();this._.lastNode=l._4e_nextSourceNode(s);this._.lastNode&&this._.lastNode[0].nodeType==j.NodeType.TEXT_NODE&&!a.trim(this._.lastNode[0].nodeValue)&&this._.lastNode.parent()._4e_isBlockBoundary()&&(g=new h(b.document),g.moveToPosition(this._.lastNode,o.POSITION_AFTER_END),g.checkEndOfBlock()&&(g=new q(g.endContainer),this._.lastNode=(g.block||g.blockLimit)._4e_nextSourceNode(s)));this._.lastNode||
(this._.lastNode=this._.docEndMarker=new w(b.document.createTextNode("")),j.insertAfter(this._.lastNode[0],l[0]));b=null}g=this._.nextNode;l=this._.lastNode;for(this._.nextNode=null;g;){var i=r,k=g[0].nodeType!=j.NodeType.ELEMENT_NODE,u=r;if(k)g[0].nodeType==j.NodeType.TEXT_NODE&&v.test(g[0].nodeValue)&&(k=r);else{var t=g.nodeName();if(g._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){if("br"==t)k=s;else if(!b&&!g[0].childNodes.length&&"hr"!=t){d=g;e=g.equals(l);break}b&&(b.setEndAt(g,o.POSITION_BEFORE_START),
"br"!=t&&(this._.nextNode=g));i=s}else{if(g[0].firstChild){b||(b=new h(this.range.document),b.setStartAt(g,o.POSITION_BEFORE_START));g=new w(g[0].firstChild);continue}k=s}}k&&!b&&(b=new h(this.range.document),b.setStartAt(g,o.POSITION_BEFORE_START));e=(!i||k)&&g.equals(l);if(b&&!i)for(;!g[0].nextSibling&&!e;){t=g.parent();if(t._4e_isBlockBoundary(this.forceBrBreak&&{br:1})){i=s;e||t.equals(l);break}g=t;k=s;e=g.equals(l);u=s}k&&b.setEndAt(g,o.POSITION_AFTER_END);g=g._4e_nextSourceNode(u,null,l);if((e=
!g)||i&&b)break}if(!d){if(!b)return this._.docEndMarker&&this._.docEndMarker._4e_remove(),this._.nextNode=null;d=new q(b.startContainer);g=d.blockLimit;i={div:1,th:1,td:1};d=d.block;if((!d||!d[0])&&!this.enforceRealBlocks&&i[g.nodeName()]&&b.checkStartOfBlock()&&b.checkEndOfBlock())d=g;else if(!d||this.enforceRealBlocks&&"li"==d.nodeName())d=new w(this.range.document.createElement(n||"p")),d[0].appendChild(b.extractContents()),d._4e_trim(),b.insertNode(d),p=c=s;else if("li"!=d.nodeName()){if(!b.checkStartOfBlock()||
!b.checkEndOfBlock())d=d.clone(r),d[0].appendChild(b.extractContents()),d._4e_trim(),c=b.splitBlock(),p=!c.wasStartOfBlock,c=!c.wasEndOfBlock,b.insertNode(d)}else e||(this._.nextNode=d.equals(l)?null:b.getBoundaryNodes().endNode._4e_nextSourceNode(s,null,l))}p&&(b=new w(d[0].previousSibling),b[0]&&b[0].nodeType==j.NodeType.ELEMENT_NODE&&("br"==b.nodeName()?b._4e_remove():b[0].lastChild&&"br"==j.nodeName(b[0].lastChild)&&j._4e_remove(b[0].lastChild)));c&&(b=f.bookmark(r,s),p=new w(d[0].lastChild),
p[0]&&p[0].nodeType==j.NodeType.ELEMENT_NODE&&"br"==p.nodeName()&&(m.ie||p.prev(b,1)||p.next(b,1))&&p.remove());this._.nextNode||(this._.nextNode=e||d.equals(l)?null:d._4e_nextSourceNode(s,null,l));return d}});h.prototype.createIterator=function(){return new n(this)};return n},{requires:["./base","./range","./elementPath","./walker"]});
KISSY.add("editor/core/styles",function(a,n){function s(a){return!z.attr(a,"_ke_bookmark")}function r(a,b){for(var d in a)"string"==typeof a[d]?a[d]=a[d].replace(S,function(a,d){return b[d]}):r(a[d],b)}function p(b,d){d&&(b=a.clone(b),r(b,d));var c=this.element=this.element=(b.element||"*").toLowerCase();this.type=this.type="#text"==c||B[c]?D.STYLE_BLOCK:Q[c]?D.STYLE_OBJECT:D.STYLE_INLINE;this._={definition:b}}function m(a,b){var d=b?this.removeFromRange:this.applyToRange;a.body.focus();for(var c=
new K(a),g=c.getRanges(),e=0;e<g.length;e++)d.call(this,g[e]);c.selectRanges(g)}function f(a,b,d){var c=a.element;"*"==c&&(c="span");b=new G(b.createElement(c));d&&d._4e_copyAttributes(b);d=a._.definition;a=d.attributes;d=p.getStyleText(d);if(a)for(var g in a)b.attr(g,a[g]);d&&(b[0].style.cssText=d);return b}function h(a){var b=a.createBookmark(i),d=a.createIterator();d.enforceRealBlocks=i;d.enlargeBr=i;for(var c,g=a.document;c=d.getNextParagraph();){var e=f(this,g,c),k=e,e="pre"==k.nodeName,j="pre"==
c.nodeName,h=!e&&j;e&&!j?(j=c,h=j.html(),h=o(h,/(?:^[ \t\n\r]+)|(?:[ \t\n\r]+$)/g,""),h=h.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"$1"),h=h.replace(/([ \t\n\r]+|&nbsp;)/g," "),h=h.replace(/<br\b[^>]*>/gi,"\n"),y.ie?(j=j[0].ownerDocument.createElement("div"),j.appendChild(k[0]),k[0].outerHTML="<pre>"+h+"</pre>",k=new G(j.firstChild),k._4e_remove()):k.html(h)):h?k=w(q(c),k):c._4e_moveChildren(k);c[0].parentNode.replaceChild(k[0],c[0]);if(e&&(c=k,e=void 0,(e=c._4e_previousSourceNode(i,z.NodeType.ELEMENT_NODE))&&
"pre"==e.nodeName()))k=o(e.html(),/\n$/,"")+"\n\n"+o(c.html(),/^\n/,""),y.ie?c[0].outerHTML="<pre>"+k+"</pre>":c.html(k),e._4e_remove()}a.moveToBookmark(b)}function o(a,b,d){var c="",e="",a=a.replace(/(^<span[^>]+_ke_bookmark.*?\/span>)|(<span[^>]+_ke_bookmark.*?\/span>$)/gi,function(a,b,d){b&&(c=b);d&&(e=d);return""});return c+a.replace(b,d)+e}function q(a){var b=[];o(a.outerHTML(),/(\S\s*)\n(?:\s|(<span[^>]+_ck_bookmark.*?\/span>))*\n(?!$)/gi,function(a,b,d){return b+"</pre>"+d+"<pre>"}).replace(/<pre\b.*?>([\s\S]*?)<\/pre>/gi,
function(a,d){b.push(d)});return b}function w(a,b){for(var d=b[0].ownerDocument.createDocumentFragment(),c=0;c<a.length;c++){var e=a[c],e=e.replace(/(\r\n|\r)/g,"\n"),e=o(e,/^[ \t]*\n/,""),e=o(e,/\n$/,""),e=o(e,/^[ \t]+|[ \t]+$/g,function(a,b){return 1==a.length?"&nbsp;":b?" "+Array(a.length).join("&nbsp;"):Array(a.length).join("&nbsp;")+" "}),e=e.replace(/\n/g,"<br>"),e=e.replace(/[ \t]{2,}/g,function(a){return Array(a.length).join("&nbsp;")+" "}),g=b.clone();g.html(e);d.appendChild(g[0])}return d}
function j(a){var b=a.document;if(a.collapsed)b=f(this,b,void 0),a.insertNode(b),a.moveToPosition(b,H.POSITION_BEFORE_END);else{var d=this.element,e=this._.definition,g,h=M[d];h||(g=i,h=M.span);var j=a.createBookmark();a.enlarge(H.ENLARGE_ELEMENT);a.trim();for(var l=a.createBookmark(),J=l.startNode,l=l.endNode,B=J,n;B&&B[0];){var m=k;if(z.equals(B,l))B=u,m=i;else{var o=B[0].nodeType,q=o==z.NodeType.ELEMENT_NODE?B.nodeName():u;if(q&&B.attr("_ke_bookmark")){B=B._4e_nextSourceNode(i);continue}if(!q||
h[q]&&(B._4e_position(l)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(B))){var t=B.parent();if(t&&"a"==d&&t.nodeName()==d)o=f(this,b,void 0),t._4e_moveChildren(o),t[0].parentNode.replaceChild(o[0],t[0]),o._4e_mergeSiblings();else if(t&&t[0]&&((M[t.nodeName()]||M.span)[d]||g)&&(!e.parentRule||e.parentRule(t))){if(!n&&(!q||!M.$removeEmpty[q]||(B._4e_position(l)|C.POSITION_PRECEDING|C.POSITION_IDENTICAL|
C.POSITION_IS_CONTAINED)==C.POSITION_PRECEDING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED))n=new P(b),n.setStartBefore(B);if(o==z.NodeType.TEXT_NODE||o==z.NodeType.ELEMENT_NODE&&!B[0].childNodes.length){t=B;for(o=null;(m=!t.next(s,1))&&(o=t.parent())&&h[o.nodeName()]&&(o._4e_position(J)|C.POSITION_FOLLOWING|C.POSITION_IDENTICAL|C.POSITION_IS_CONTAINED)==C.POSITION_FOLLOWING+C.POSITION_IDENTICAL+C.POSITION_IS_CONTAINED&&(!e.childRule||e.childRule(o));)t=o;n.setEndAfter(t)}}else m=i}else m=i;B=B._4e_nextSourceNode()}if(m&&
n&&!n.collapsed){for(var m=f(this,b,void 0),t=n.getCommonAncestor(),o={},q={},p,r=null,v;m&&t&&m[0]&&t[0];){if(t.nodeName()==d){for(p in e.attributes)if(!q[p]&&(v=t.attr(r)))m.attr(p)==v?m.removeAttr(p):q[p]=1;for(r in e.styles)if(!o[r]&&(v=t.style(r)))m.style(r)==v?m.style(r,""):o[r]=1;if(!m._4e_hasAttributes()){m=u;break}}t=t.parent()}m?(m[0].appendChild(n.extractContents()),c(this,m),n.insertNode(m),m._4e_mergeSiblings(),y.ie||m[0].normalize()):(m=new G(b.createElement("span")),m[0].appendChild(n.extractContents()),
n.insertNode(m),c(this,m),m._4e_remove(!0));n=u}}J._4e_remove();l._4e_remove();a.moveToBookmark(j);a.shrink(H.SHRINK_TEXT)}}function v(a){a.enlarge(H.ENLARGE_ELEMENT);var d=a.createBookmark(),c=d.startNode;if(a.collapsed){for(var g=new J(c.parent()),f,i=0,k;i<g.elements.length&&(k=g.elements[i])&&!(k==g.block||k==g.blockLimit);i++)if(this.checkElementRemovable(k)){var h=a.checkBoundaryOfElement(k,H.END),j=!h&&a.checkBoundaryOfElement(k,H.START);j||h?(f=k,f.match=j?"start":"end"):(k._4e_mergeSiblings(),
k.nodeName()!=this.element?(h=b(this),l(k,h[k.nodeName()]||h["*"])):e(this,k))}if(f){k=c;for(i=0;;i++){h=g.elements[i];if(h.equals(f))break;else if(h.match)continue;else h=h.clone();h[0].appendChild(k[0]);k=h}k["start"==f.match?"insertBefore":"insertAfter"](f);g=f.html();!g||"\u200b"==g?f.remove():y.webkit&&t(a.document.createTextNode("\u200b")).insertBefore(k)}}else{var m=d.endNode,B=this;f=function(){for(var a=new J(c.parent()),b=new J(m.parent()),d=u,e=u,g=0;g<a.elements.length;g++){var f=a.elements[g];
if(f==a.block||f==a.blockLimit)break;B.checkElementRemovable(f)&&(d=f)}for(g=0;g<b.elements.length;g++){f=b.elements[g];if(f==b.block||f==b.blockLimit)break;B.checkElementRemovable(f)&&(e=f)}e&&m._4e_breakParent(e);d&&c._4e_breakParent(d)};f();for(g=new G(c[0].nextSibling);g[0]!==m[0];){i=g._4e_nextSourceNode();if(g[0]&&g[0].nodeType==z.NodeType.ELEMENT_NODE&&this.checkElementRemovable(g)&&(g.nodeName()==this.element?e(this,g):(k=b(this),l(g,k[g.nodeName()]||k["*"])),i[0].nodeType==z.NodeType.ELEMENT_NODE&&
i.contains(c)))f(),i=new G(c[0].nextSibling);g=i}}a.moveToBookmark(d)}function x(a){var b={};(""+a).replace(/&quot;/g,'"').replace(/\s*([^ :;]+)\s*:\s*([^;]+)\s*(?=;|$)/g,function(a,d,c){b[d]=c});return b}function d(a,b){var d="";b!==k?(d=document.createElement("span"),d.style.cssText=a,d=d.style.cssText||""):d=a;return d.replace(/\s*([;:])\s*/,"$1").replace(/([^\s;])$/,"$1;").replace(/,\s+/g,",").toLowerCase()}function b(b){if(b._.overrides)return b._.overrides;var d=b._.overrides={},c=b._.definition.overrides;
if(c){a.isArray(c)||(c=[c]);for(var e=0;e<c.length;e++){var g=c[e],f,i,k;"string"==typeof g?f=g.toLowerCase():(f=g.element?g.element.toLowerCase():b.element,i=g.attributes,k=g.styles);g=d[f]||(d[f]={});if(i){f=g.attributes=g.attributes||[];for(var h in i)f.push([h.toLowerCase(),i[h]])}if(k){var g=g.styles=g.styles||[],y;for(y in k)g.push([y.toLowerCase(),k[y]])}}}return d}function e(d,c){var e=d._.definition,f=b(d),k=a.merge(e.attributes,(f[c.nodeName()]||f["*"]||{}).attributes),e=a.merge(e.styles,
(f[c.nodeName()]||f["*"]||{}).styles),f=a.isEmptyObject(k)&&a.isEmptyObject(e),h;for(h in k)("class"==h||d._.definition.fullMatch)&&c.attr(h)!=F(h,k[h])||(f=f||!!c.hasAttr(h),c.removeAttr(h));for(var y in e)d._.definition.fullMatch&&c.style(y)!=F(y,e[y],i)||(f=f||!!c.style(y),c.style(y,""));g(c)}function F(a,b,d){var c=new G("<span>");c[d?"style":"attr"](a,b);return c[d?"style":"attr"](a)}function c(a,d){for(var c=b(a),g=d.all(a.element),f=g.length;0<=--f;)e(a,new G(g[f]));for(var i in c)if(i!=a.element){g=
d.all(i);for(f=g.length-1;0<=f;f--){var k=new G(g[f]);l(k,c[i])}}}function l(a,b){var d,c=b&&b.attributes;if(c)for(d=0;d<c.length;d++){var e=c[d][0],f;if(f=a.attr(e)){var i=c[d][1];(i===u||i.test&&i.test(f)||"string"==typeof i&&f==i)&&a[0].removeAttribute(e)}}if(c=b&&b.styles)for(d=0;d<c.length;d++)if(e=c[d][0],i=a.css(e)){var k=c[d][1];(k===u||k.test&&k.test(f)||"string"==typeof k&&i==k)&&a.css(e,"")}g(a)}function g(a){if(!a._4e_hasAttributes()){var b=a[0].firstChild,d=a[0].lastChild;a._4e_remove(i);
b&&(b.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(b),d&&b!=d&&d.nodeType==z.NodeType.ELEMENT_NODE&&z._4e_mergeSiblings(d))}}var i=!0,k=!1,u=null,t=a.all,z=a.DOM,D={STYLE_BLOCK:1,STYLE_INLINE:2,STYLE_OBJECT:3},H=n.RANGE,K=n.Selection,C=n.POSITION,P=n.Range,G=a.Node,y=a.UA,J=n.ElementPath,B={address:1,div:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,p:1,pre:1},M=n.XHTML_DTD,Q={embed:1,hr:1,img:1,li:1,object:1,ol:1,table:1,td:1,tr:1,th:1,ul:1,dl:1,dt:1,dd:1,form:1},R=/\s*(?:;\s*|$)/g,S=/#\((.+?)\)/g;n.STYLE=
D;p.prototype={constructor:p,apply:function(a){m.call(this,a,k)},remove:function(a){m.call(this,a,i)},applyToRange:function(a){return(this.applyToRange=this.type==D.STYLE_INLINE?j:this.type==D.STYLE_BLOCK?h:u).call(this,a)},removeFromRange:function(a){return(this.removeFromRange=this.type==D.STYLE_INLINE?v:u).call(this,a)},checkElementRemovable:function(a,c){if(!a)return k;var g=this._.definition,e;if(a.nodeName()==this.element){if(!c&&!a._4e_hasAttributes())return i;var f=g._AC;if(f)g=f;else{var f=
{},h=0,y=g.attributes;if(y)for(var j in y)h++,f[j]=y[j];if(y=p.getStyleText(g))f.style||h++,f.style=y;f._length=h;g=g._AC=f}if(g._length){for(var l in g)if("_length"!=l){h=a.attr(l)||"";if("style"==l)a:{f=g[l];h=d(h,k);"string"==typeof f&&(f=x(f));"string"==typeof h&&(h=x(h));y=void 0;for(y in f)if(!(y in h&&(h[y]==f[y]||"inherit"==f[y]||"inherit"==h[y]))){f=k;break a}f=i}else f=g[l]==h;if(f){if(!c)return i}else if(c)return k}if(c)return i}else return i}l=b(this);if(l=l[a.nodeName()]||l["*"]){if(!(g=
l.attributes)&&!(e=l.styles))return i;if(g)for(f=0;f<g.length;f++)if(l=g[f][0],l=a.attr(l))if(h=g[f][1],h===u||"string"==typeof h&&l==h||h.test&&h.test(l))return i;if(e)for(f=0;f<e.length;f++)if(l=a.css(e[f][0]))if(g=e[f][1],g===u||"string"==typeof g&&l==g||g.test&&g.test(l))return i}return k},checkActive:function(a){switch(this.type){case D.STYLE_BLOCK:return this.checkElementRemovable(a.block||a.blockLimit,i);case D.STYLE_OBJECT:case D.STYLE_INLINE:for(var b=a.elements,d=0,c;d<b.length;d++)if(c=
b[d],!(this.type==D.STYLE_INLINE&&(z.equals(c,a.block)||z.equals(c,a.blockLimit))))if((this.type!=D.STYLE_OBJECT||c.nodeName()in Q)&&this.checkElementRemovable(c,i))return i}return k}};p.getStyleText=function(a){var b=a._ST;if(b)return b;var b=a.styles,c=a.attributes&&a.attributes.style||"",g="";c.length&&(c=c.replace(R,";"));for(var e in b){var f=b[e],i=(e+":"+f).replace(R,";");"inherit"==f?g+=i:c+=i}c.length&&(c=d(c));return a._ST=c+g};return n.Style=p},{requires:["./base","./range","./selection",
"./domIterator","./elementPath"]});KISSY.add("editor/core/zIndexManager",function(a){var n=a.Editor,a=n.zIndexManager={BUBBLE_VIEW:1100,POPUP_MENU:1200,STORE_FLASH_SHOW:99999,MAXIMIZE:900,OVERLAY:9999,LOADING:11E3,LOADING_CANCEL:12E3,SELECT:1200};n.baseZIndex=function(a){return(n.Config.baseZIndex||1E4)+a};return a},{requires:["./base"]});
KISSY.add("editor/core/clipboard",function(a,n,s,r){function p(a){this.editor=a;this._init()}function m(a){var b=a.get("document")[0],e=a.getSelection(),h;if(e.getType()==r.SELECTION_ELEMENT&&(h=e.getSelectedElement())){var a=e.getRanges()[0],c=f(b.createTextNode(""));c.insertBefore(h);a.setStartBefore(c);a.setEndAfter(h);e.selectRanges([a]);setTimeout(function(){h.parent()&&(c.remove(),e.selectElement(h))},0)}}var f=a.all,h=a.UA,o=h.ie?"beforepaste":"paste",q=n.RANGE;a.augment(p,{_init:function(){var a=
this,b=a.editor,e=b.get("document"),f=e.one("body"),c=function(a){this.type=a};c.prototype={exec:function(b){var c=this.type;b.focus();setTimeout(function(){h.ie&&("cut"==c?m(b):"paste"==c&&(a._preventPasteEvent(),a._getClipboardDataFromPasteBin()));j(b,c)||alert(v[c])},0)}};f.on(o,a._getClipboardDataFromPasteBin,a);h.ie&&(f.on("paste",a._iePaste,a),e.on("keydown",a._onKeyDown,a),e.on("contextmenu",function(){a._isPreventBeforePaste=1;setTimeout(function(){a._isPreventBeforePaste=0},0)}));b.addCommand("copy",
new c("copy"));b.addCommand("cut",new c("cut"));b.addCommand("paste",new c("paste"))},_onKeyDown:function(a){this.editor.get("mode")==n.Mode.WYSIWYG_MODE&&(a.ctrlKey&&86==a.keyCode||a.shiftKey&&45==a.keyCode)&&this._preventPasteEvent()},_stateFromNamedCommand:function(a){var b,e=this.editor;if("paste"==a){this._isPreventBeforePaste=1;try{b=e.get("document")[0].queryCommandEnabled(a)}catch(f){}this._isPreventBeforePaste=0}else b=(a=(a=e.getSelection())&&a.getRanges())&&!(1==a.length&&a[0].collapsed);
return b},_preventPasteEvent:function(){var a=this;a._preventPasteTimer&&clearTimeout(a._preventPasteTimer);a._isPreventPaste=1;a._preventPasteTimer=setTimeout(function(){a._isPreventPaste=0},70)},_iePaste:function(a){var b=this.editor;this._isPreventPaste||(a.preventDefault(),b.execCommand("paste"))},_getClipboardDataFromPasteBin:function(){if(!this._isPreventBeforePaste){var d=this.editor,b=d.get("document")[0];if(!b.getElementById("ke_pastebin")){var e=d.getSelection(),j=new s(b),c=f(h.webkit?
"<body></body>":b.createElement("div"),null,b);c.attr("id","ke_pastebin");h.webkit&&c[0].appendChild(b.createTextNode("\u200b"));b.body.appendChild(c[0]);c.css({position:"absolute",top:e.getStartElement().offset().top+"px",width:"1px",height:"1px",overflow:"hidden"});c.css("left","-1000px");var l=e.createBookmarks();j.setStartAt(c,q.POSITION_AFTER_START);j.setEndAt(c,q.POSITION_BEFORE_END);j.select(!0);setTimeout(function(){var b,f=c;c=h.webkit&&(b=c.first())&&b.hasClass("Apple-style-span")?b:c;e.selectBookmarks(l);
var k=c.html();f.remove();if(k=a.trim(k.replace(/<span[^>]+_ke_bookmark[^<]*?<\/span>(&nbsp;)*/ig,"")))b=d.fire("paste",{html:k}),!1!==b&&(void 0!==b&&(k=b),/(class="?Mso|style="[^"]*\bmso\-|w:WordDocument)/.test(k)?a.use("editor/plugin/word-filter",function(a,b){d.insertHTML(b.toDataFormat(k,d))}):d.insertHTML(k))},0)}}}});var w=function(a,b){var e=a.get("document")[0],j=f(e.body),c=!1,l=function(){c=!0};j.on(b,l);(7<h.ie?e:e.selection.createRange()).execCommand(b);j.detach(b,l);return c},j=h.ie?
function(a,b){return w(a,b)}:function(a,b){try{return a.get("document")[0].execCommand(b)}catch(e){return!1}},v={cut:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u526a\u5207\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+X)\u6765\u5b8c\u6210",copy:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u590d\u5236\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+C)\u6765\u5b8c\u6210",paste:"\u60a8\u7684\u6d4f\u89c8\u5668\u5b89\u5168\u8bbe\u7f6e\u4e0d\u5141\u8bb8\u7f16\u8f91\u5668\u81ea\u52a8\u6267\u884c\u7c98\u8d34\u64cd\u4f5c\uff0c\u8bf7\u4f7f\u7528\u952e\u76d8\u5feb\u6377\u952e(Ctrl/Cmd+V)\u6765\u5b8c\u6210"},x={copy:"\u590d\u5236",paste:"\u7c98\u8d34",cut:"\u526a\u5207"};return{init:function(a){var b;a.docReady(function(){b=new p(a)});var e={copy:1,cut:1,paste:1},f=["copy","cut","paste"];a.on("contextmenu",function(c){var h=c.contextmenu;if(!h.__copy_fix){h.__copy_fix=
1;for(c=0;c<f.length;c++)h.addChild({content:x[f[c]],value:f[c]});h.on("click",function(b){var c=b.target.get("value");e[c]&&(h.hide(),setTimeout(function(){a.execCommand("save");a.execCommand(c);setTimeout(function(){a.execCommand("save")},10)},30))})}for(var g=h.get("children"),c=g.length-1;c--;0<=c){var i=g[c],k;k=i.get?i.get("value"):i.value;e[k]&&(k=!b._stateFromNamedCommand(k),i.set?i.set("disabled",k):i.disabled=k)}})}}},{requires:["./base","./range","./selection"]});
KISSY.add("editor/core/enterKey",function(a,n,s,r){function p(j){var m;m=j.getSelection().getRanges();for(var n=m.length-1;0<n;n--)m[n].deleteContents();m=m[0];n=m.document;if(m.checkStartOfBlock()&&m.checkEndOfBlock()){var d=(new r(m.startContainer)).block;if(d&&("li"==d.nodeName()||"li"==d.parent().nodeName()))return j.hasCommand("outdent")?(j.execCommand("save"),j.execCommand("outdent"),j.execCommand("save"),!0):!1}var b=m.splitBlock("p");if(!b)return!0;var j=b.previousBlock,d=b.nextBlock,e=b.wasStartOfBlock,
p=b.wasEndOfBlock,c;if(d)c=d.parent(),"li"==c.nodeName()&&(d._4e_breakParent(c),d._4e_move(d.next(),!0));else if(j&&(c=j.parent())&&"li"==c.nodeName())j._4e_breakParent(c),m.moveToElementEditablePosition(j.next()),j._4e_move(j.prev());if(!e&&!p){if("li"==d.nodeName()&&(c=d.first(s.invisible(!0)))&&a.inArray(c.nodeName(),["ul","ol"]))(f.ie?new q(n.createTextNode("\u00a0")):new q(n.createElement("br"))).insertBefore(c);d&&m.moveToElementEditablePosition(d)}else{var l;if(j){if("li"==j.nodeName()||!h.test(j.nodeName()))l=
j.clone()}else d&&(l=d.clone());l||(l=new q("<p>",null,n));if(c=b.elementPath)for(var b=0,g=c.elements.length;b<g;b++){var i=c.elements[b];if(i.equals(c.block)||i.equals(c.blockLimit))break;o.$removeEmpty[i.nodeName()]&&(i=i.clone(),l._4e_moveChildren(i),l.append(i))}f.ie||l._4e_appendBogus();m.insertNode(l);if(f.ie&&e&&(!p||!j[0].childNodes.length))m.moveToElementEditablePosition(p?j:l),m.select();m.moveToElementEditablePosition(e&&!p?d:l)}f.ie||(d?(l=new q(n.createElement("span")),l.html("&nbsp;"),
m.insertNode(l),l.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}),m.deleteContents()):l.scrollIntoView(void 0,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0}));m.select();return!0}function m(a){var f=a.get("document")[0];w.on(f,"keydown",function(f){if(13===f.keyCode&&!f.shiftKey&&!f.ctrlKey&&!f.metaKey){a.execCommand("save");var d=a.execCommand("enterBlock");a.execCommand("save");!1!==d&&f.preventDefault()}})}var f=a.UA,h=/^h[1-6]$/,o=n.XHTML_DTD,
q=a.Node,w=a.Event;return{init:function(a){a.addCommand("enterBlock",{exec:p});a.docReady(function(){m(a)})}}},{requires:["./base","./walker","./elementPath"]});
KISSY.add("editor/core/htmlDataProcessor",function(a,n){return{init:function(s){function r(b){var b=b.childNodes,c,d,e,f=b.length;if(f){e=1;for(c=0;c<f;c++)if(d=b[c],d.nodeType!=a.DOM.NodeType.TEXT_NODE||d.nodeValue){e=0;break}return e?!1:void 0}return!1}function p(a){return a.replace(v,function(a,b,c){return"<"+b+c.replace(x,function(a,b){return-1==c.indexOf("_ke_saved_"+b)?" _ke_saved_"+a+" "+a:a})+">"})}function m(a){return a.replace(b,function(a){return"<ke:encoded>"+encodeURIComponent(a)+"</ke:encoded>"})}
function f(b){return b.replace(e,function(b,c){return a.urlDecode(c)})}var h=a.Node,o=a.UA,q=a.require("htmlparser"),w=new q.Filter,j=new q.Filter;(function(){function b(a){a=q.serialize(a);return new q.Comment(d+encodeURIComponent(a).replace(/--/g,"%2D%2D"))}var c={tagNames:[[/^\?xml.*$/i,""],[/^.*namespace.*$/i,""]],attributeNames:[[/^on/,"ke_on"],[/^lang$/,""]],tags:{script:b,noscript:b,span:r}},e={tagNames:[[/^ke:/,""],[/^\?xml:namespace$/,""]],tags:{$:function(a){if(a.attributes.length)for(var b=
["name","href","src"],c,d=0;d<b.length;d++)c="_ke_saved_"+b[d],a.getAttribute(c)&&a.removeAttribute(b[d]);return a},embed:function(a){var b=a.parentNode;if(b&&"object"==b.nodeName){var c=b.getAttribute("width"),b=b.getAttribute("height");c&&a.setAttribute("width",c);b&&a.setAttribute("width",b)}},a:function(a){if(!a.childNodes.length&&!a.attributes.length)return!1},span:r,strong:r,em:r,del:r,u:r},attributes:{style:function(b){if(!a.trim(b))return!1}},attributeNames:[[/^_ke_saved_/,""],[/^ke_on/,"on"],
[/^_ke.*/,""],[/^ke:.*$/,""],[/^_ks.*/,""]],comment:function(b){if(b.substr(0,d.length)==d)return b=a.trim(a.urlDecode(b.substr(d.length))),q.parse(b).childNodes[0]}};o.ie&&(e.attributes.style=function(a){return a.replace(/(^|;)([^:]+)/g,function(a){return a.toLowerCase()})});w.addRules(e);j.addRules(c)})();(function(){function b(c){for(var c=c.childNodes,d=c.length,e=c[d-1];e&&3==e.nodeType&&!a.trim(e.nodeValue);)e=c[--d];return e}function c(a){var d=b(a);d&&(1==d.nodeType&&"br"==d.nodeName?a.removeChild(d):
3==d.nodeType&&h.test(d.nodeValue)&&a.removeChild(d))}function d(a){var c=b(a);return!c||"form"==a.nodeName&&"input"==c.nodeName}function e(a){c(a);d(a)&&(o.ie||a.appendChild(new q.Tag("br")))}function f(a){c(a);d(a)&&a.appendChild(new q.Text("\u00a0"))}var h=/^[\t\r\n ]*(?:&nbsp;|\xa0)[\t\r\n ]*$/,l=n.XHTML_DTD,m=a.merge(l.$block,l.$listItem,l.$tableContent),p;for(p in m)"br"in l[p]||delete m[p];delete m.pre;var l={tags:{}},r={tags:{}};for(p in m)l.tags[p]=e,r.tags[p]=f;j.addRules(l);w.addRules(r)})();
w.addRules({text:function(a){return a.replace(/\xa0/g,"&nbsp;")}});var v=/<(a|area|img|input)\b([^>]*)>/gi,x=/\b(href|src|name)\s*=\s*(?:(?:"[^"]*")|(?:'[^']*')|(?:[^ "'>]+))/gi,d="{ke_protected}",b=/(?:<textarea[^>]*>[\s\S]*<\/textarea>)|(?:<style[^>]*>[\s\S]*<\/style>)|(?:<(:?link|meta|base)[^>]*>)/gi,e=/<ke:encoded>([^<]*)<\/ke:encoded>/gi,F=/(<\/?)((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,c=/(<\/?)ke:((?:object|embed|param|html|body|head|title|script|noscript)[^>]*>)/gi,
l=/<ke:(param|embed)([^>]*?)\/?>(?!\s*<\/ke:\1)/gi;s.htmlDataProcessor={dataFilter:j,htmlFilter:w,toHTML:function(a){o.webkit&&(a=a.replace(/\u200b/g,""));var b=new q.BeautifyWriter;(new q.Parser(a)).parse().writeHTML(b,w);return a=b.getHTML()},toDataFormat:function(a,b){var b=b||j,a=m(a),a=p(a),a=a.replace(F,"$1ke:$2"),a=a.replace(l,"<ke:$1$2></ke:$1>"),d=new h("<div>");d.html("a"+a);a=d.html().substr(1);a=a.replace(c,"$1$2");a=f(a);d=new q.BasicWriter;(new q.Parser(a)).parse().writeHTML(d,b);return a=
d.getHTML()},toServer:function(a){var b=new q.MinifyWriter;(new q.Parser(a)).parse().writeHTML(b,w);return b.getHTML()}}}}},{requires:["./base"]});
KISSY.add("editor/core/selectionFix",function(a,n){function s(a){function b(a,b){var c=g.body.createTextRange();try{c.moveToPoint(a,b)}catch(d){c=o}return c}function e(){var a=g.selection.createRange();i&&!a.item&&0===a.compareEndPoints("StartToEnd",a)&&i.select();w.remove(g,"mouseup",e);w.remove(g,"mousemove",f);i=c=0}function f(a){if(a.button){if(a=b(a.pageX,a.pageY))0<a.compareEndPoints("StartToStart",i)?a.setEndPoint("StartToStart",i):a.setEndPoint("EndToEnd",i),a.select()}else e()}var c,h=a.get("window")[0],
g=a.get("document")[0],i;w.on(g,"mousedown contextmenu",function(a){var d=g.documentElement;if(a.target===d&&(c&&e(),!(d.scrollHeight>d.clientHeight)&&(c=1,i=b(a.pageX,a.pageY))))w.on(g,"mouseup",e),w.on(g,"mousemove",f),h.focus(),i.select()})}function r(a){function b(c){if(g){var h=a.getSelection(),i=h&&h.getType(),j=h&&e.selection;if(c&&j&&i==x.SELECTION_NONE&&!e.queryCommandEnabled("InsertImage"))setTimeout(function(){b(f)},50);else{var m;if(!j||!j.type||!("Control"!=j.type&&(m=j.createRange())&&
(m=m.parentElement())&&(m=m.nodeName)&&m.toLowerCase()in{input:1,textarea:1}))l=j&&h.getRanges()[0],a.checkSelectionChange()}}}var e=a.get("document")[0],j=new v(e.body),c=new v(e.documentElement);if(8>n.Utils.ieEngine)c.on("click",function(b){"html"===(new v(b.target)).nodeName()&&a.getSelection().getNative().createRange().select()});var l,g,i=f;c.on("mousedown",function(){i=h});c.on("mouseup",function(){i=f});j.on("focusin",function(a){if("body"==(new v(a.target)).nodeName()&&l){try{i&&l.select()}catch(b){}l=
o}});j.on("focus",function(){g=f;b()});j.on("beforedeactivate",function(a){a.relatedTarget||(g=h,i=f)});j.on("mousedown",function(){g=h});j.on("mouseup",function(){g=f;setTimeout(function(){b(f)},0)});j.on("keydown",function(){g=h});j.on("keyup",function(){g=f;setTimeout(function(){b()},0)})}function p(a){var b=a.get("document")[0];w.on(b,"mouseup keyup selectionchange",function(){a.checkSelectionChange()})}function m(a){function b(a){var b=n.XHTML_DTD;return a._4e_isBlockBoundary()&&b.$empty[a.nodeName()]}
function e(a){return c(a)&&l(a)}var m=/\s*<(p|div|address|h\d|center)[^>]*>\s*(?:<br[^>]*>|&nbsp;|\u00A0|&#160;|(<\!--[\s\S]*?--\>))?\s*(:?<\/\1>)?(?=\s*$|<\/body>)/gi,c=n.Walker.whitespaces(f),l=n.Walker.bookmark(h,f),g=function(a){return c(a)&&8!=a.nodeType};a.on("selectionChange",function(c){var k=c.path,l=new v(a.get("document")[0].body),c=(c=c.selection)&&c.getRanges()[0],o=k.blockLimit;if(q.gecko){var p=k.block||k.blockLimit,r=p&&p.last(e);p&&p._4e_isBlockBoundary()&&(!r||!(1==r[0].nodeType&&
r._4e_isBlockBoundary()))&&"pre"!=p.nodeName()&&!p._4e_getBogus()&&p._4e_appendBogus()}if(c&&c.collapsed&&!k.block){if("body"==o.nodeName()){if((k=c.fixBlock(f,"p"))&&k[0]!=l[0].lastChild&&k.outerHTML().match(m))if((o=k.next(g,1))&&o[0].nodeType==j.NodeType.ELEMENT_NODE&&!b[o])c.moveToElementEditablePosition(o),k._4e_remove();else if((o=k.prev(g,1))&&o[0].nodeType==j.NodeType.ELEMENT_NODE&&!b[o])c.moveToElementEditablePosition(o,o.outerHTML().match(m)?h:f),k._4e_remove();c.select();a.notifySelectionChange()}k=
a.get("document")[0];c=new n.Range(k);c.moveToElementEditablePosition(l,f);"body"!==(new n.ElementPath(c.startContainer)).blockLimit.nodeName()&&(l=(new v(k.createElement("p"))).appendTo(l),q.ie||l._4e_appendBogus())}})}var f=!0,h=!1,o=null,q=a.UA,w=a.Event,j=a.DOM,v=a.Node,x=n.SELECTION;return{init:function(a){a.docReady(function(){q.ie?(s(a),r(a)):p(a)});m(a)}}},{requires:["./base","./selection"]});
KISSY.add("editor/core",function(a,n,s,r,p,m,f,h,o,q){function w(a,d){var e=a.body;D(function(){a.designMode="on";setTimeout(function(){a.designMode="off";e.focus();arguments.callee.retry||(arguments.callee.retry=b)},50)},function(){a.designMode="off";k.attr(e,"contentEditable",c);k.attr(e,"contentEditable",b);!d&&w(a,1)})}function j(b){b.get("iframe");var d=b.get("textarea")[0],e=b.get("window")[0],f=b.get("document")[0];g.webkit&&(z.on(f,"click",function(b){var c=new t(b.target);a.inArray(c.nodeName(),
["input","select"])&&b.preventDefault()}),z.on(f,"mouseup",function(b){var c=new t(b.target);a.inArray(c.nodeName(),["input","textarea"])&&b.preventDefault()}));if(g.gecko||i||g.opera){var h;h=(new t('<span tabindex="-1" style="position:absolute; left:-10000" role="presentation"></span>')).insertAfter(d);h.on("focus",function(){b.focus()});b.activateGecko=function(){g.gecko&&b.__iframeFocus&&h[0].focus()};b.on("destroy",function(){h.detach();h.remove()})}z.on(e,"focus",function(){g.gecko?w(f,c):g.opera&&
f.body.focus();b.notifySelectionChange()});if(g.gecko)z.on(f,"mousedown",function(){b.__iframeFocus||w(f,c)});if(i&&(z.on(f,"keydown",function(a){if(a.keyCode in{8:1,46:1}){var c=b.getSelection(),d=c.getSelectedElement();if(d){b.execCommand("save");var e=c.getRanges()[0].createBookmark();d.remove();c.selectBookmarks([e]);b.execCommand("save");a.preventDefault()}}}),"CSS1Compat"==f.compatMode)){var j={33:1,34:1};z.on(f,"keydown",function(a){a.keyCode in j&&setTimeout(function(){b.getSelection().scrollIntoView()},
0)})}if(g.webkit)z.on(f,"mousedown",function(c){c=new t(c.target);a.inArray(c.nodeName(),["img","hr","input","textarea","select"])&&b.getSelection().selectElement(c)});if(g.gecko)z.on(f,"dragstart",function(a){var b=new t(a.target);b.nodeName()==="img"&&/ke_/.test(b[0].className)&&a.preventDefault()});r.add(b)}function v(b,c,d,e){var f="",g;g=s.debugUrl("theme/editor-iframe.css");d=d.concat([]);d.unshift(g);for(g=0;g<d.length;g++)f+=a.substitute('<link href="{href}" rel="stylesheet" />',{href:d[g]});
return a.substitute(H,{doctype:8===l.documentMode?'<meta http-equiv="X-UA-Compatible" content="IE=7" />':"",title:"${title}",links:f,style:c,data:e||"",script:b?'<script id="ke_active_script">'+(k.isCustomDomain()?'document.domain="'+l.domain+'";':"")+'parent.KISSY.Editor._initIFrame("'+b+'");<\/script>':""})}function x(a,b){function c(){h=g.document;a.setInternal("document",new t(h));a.setInternal("window",new t(g));d.detach();h.open("text/html","replace");h.write(e);h.close()}var d=a.get("iframe"),
e=v(a._UUID,a.get("customStyle"),a.get("customLink"),b),f=d[0],g=f.contentWindow,h;d.__loaded=1;try{h=g.document}catch(j){if(f.src=f.src,7>i){setTimeout(c,10);return}}c()}function d(b,c){var d=k.getEmptyIframeSrc()||"";d&&(d=' src="'+d+'" ');var d=new t(a.substitute(K,{iframeSrc:d})),e=b.get("textarea");e.hasAttr("tabindex")&&d.attr("tabindex",g.webkit?-1:e.attr("tabindex"));e.parent().prepend(d);b.set("iframe",d);b.__docReady=0;if(g.gecko&&!d.__loaded)d.on("load",function(){x(b,c)},b);else x(b,c)}
var b=!0,e=e,F=a.all,c=!1,l=document,g=a.UA,i=g.ie,k=a.DOM,u=k.NodeType,t=a.Node,z=a.Event,D=s.tryThese,H='<!doctype html><html><head>{doctype}<title>{title}</title><style>{style}</style>{links}</head><body class="ks-editor" >{data}{script}</body></html>',K='<iframe style="width:100%;height:100%;border:none;"  frameborder="0"  title="kissy-editor"  allowTransparency="true"  {iframeSrc} ></iframe>',C=/^(?:<(p)>)?(?:(?:&nbsp;)|\s|<br[^>]*>)*(?:<\/\1>)?$/i,P='<div class="{prefixCls}editor-tools"></div><div class="{prefixCls}editor-textarea-wrap" '+
(g.mobile?'style="overflow:scroll;-webkit-overflow-scrolling:touch;"':"")+'></div><div class="{prefixCls}editor-status"></div>';n.Mode={SOURCE_MODE:0,WYSIWYG_MODE:1};a.augment(n,{createDom:function(){var b,c=this.prefixCls,d=this.get("textarea"),e;d?(this.set("textarea",d=F(d)),d[0].parentNode&&d.remove()):(b=this.get("data"),this.set("textarea",d=F('<textarea class="'+c+'-editor-textarea"></textarea>')),d.val(b));e=this.get("el");e.html(a.substitute(P,{prefixCls:c}));b=e.one(a.substitute(".{prefixCls}editor-textarea-wrap",
{prefixCls:c}));this._UUID=a.guid();this.set({toolBarEl:e.one(a.substitute(".{prefixCls}editor-tools",{prefixCls:c})),statusBarEl:e.one(a.substitute(".{prefixCls}editor-status",{prefixCls:c}))},{silent:1});d.css("width","100%");d.css("display","none");b.append(d);r.register(this)},renderUI:function(){f.init(this);h.init(this);o.init(this);q.init(this)},bindUI:function(){function a(){b.detach("docReady",a);if(b.get("focused"))b.focus();else{var c=b.getSelection();c&&c.removeAllRanges()}}var b=this,
c,d=b.prefixCls,e=b.get("textarea");if(b.get("attachForm")&&(c=e[0].form))z.on(c,"submit",b.sync,b);b.on("docReady",a);b.on("blur",function(){b.get("el").removeClass(d+"editor-focused")});b.on("focus",function(){b.get("el").addClass(d+"editor-focused")})},syncUI:function(){this.get("rendered")&&this.get("textarea").val(this.get("data"))},_onSetHeight:function(a){var b=this.get("textarea"),c=this.get("toolBarEl"),d=this.get("statusBarEl"),a=parseInt(a,10),a=a-((c&&c.outerHeight()||0)+(d&&d.outerHeight()||
0));b.parent().css("height",a);b.css("height",a)},_onSetMode:function(a){this.get("rendered");var b=this.get("iframe"),c=this.get("textarea");1==a?(this._setData(c.val()),c.hide(),this.fire("wysiwygMode")):(b&&(c.val(this._getData(1,1)),b.hide()),c.show(),this.fire("sourceMode"))},_onSetFocused:function(a){a&&this.__docReady&&this.focus()},_onSetData:function(a){this.get("rendered")&&this._setData(a)},destructor:function(){var b,c=this.get("textarea"),d=this.get("document")[0],e=this.get("window");
this.get("attachForm")&&(b=c[0].form)&&z.detach(b,"submit",this.sync,this);r.remove(this);z.remove([d,d.documentElement,d.body,e[0]]);a.each(this.__controls,function(a){a.destroy&&a.destroy()});this.__commands={};this.__controls={}},getControl:function(a){return this.__controls[a]},getControls:function(){return this.__controls},addControl:function(a,b){this.__controls[a]=b},showDialog:function(a,b){var a=a+"/dialog",c=this.__controls[a];c.show(b);this.fire("dialogShow",{dialog:c.dialog,pluginDialog:c,
dialogName:a})},addCommand:function(a,b){this.__commands[a]=b},hasCommand:function(a){return this.__commands[a]},execCommand:function(b){var c=this.__commands[b],d=a.makeArray(arguments);d.shift();d.unshift(this);return c?c.exec.apply(c,d):e},queryCommandValue:function(a){return this.execCommand(s.getQueryCmd(a))},_getData:function(b,c){var d=this.htmlDataProcessor,f;if(!this.get("rendered"))return e;c==e&&(c=this.get("mode"));f=1==c&&this.isDocReady()?this.get("document")[0].body.innerHTML:d.toDataFormat(this.get("textarea").val());
f=b?d.toHTML(f):d.toServer(f);f=a.trim(f);C.test(f)&&(f="");return f},_setData:function(a){var b,c=a;if(1!=this.get("mode"))this.get("textarea").val(a);else{if(b=this.htmlDataProcessor)c=b.toDataFormat(a);if(this.get("iframe")){a=this.get("iframe");b=this.get("window")[0];var e=this.get("document")[0];z.remove([e,e.documentElement,e.body,b]);a.remove()}d(this,c)}},getDocHTML:function(){return v(0,this.get("customStyle"),this.get("customLink"),this.get("formatData"))},getDocHtml:function(){return this.getDocHTML()},
getSelection:function(){return n.Selection.getSelection(this.get("document")[0])},getSelectedHTML:function(){var a=this.getSelection().getRanges()[0],b;a&&(a=a.cloneContents(),b=this.get("document")[0].createElement("div"),b.appendChild(a),b=b.innerHTML);return b},focus:function(){var a=this.get("window");if(a){var b=this.get("document")[0],a=a[0];g.ie||a&&a.parent&&a.parent.focus();a&&a.focus();try{b.body.focus()}catch(c){}this.notifySelectionChange()}},blur:function(){this.get("window")[0].blur();
this.get("document")[0].body.blur()},addCustomStyle:function(a,b){var c=this.get("window"),d=this.get("customStyle")||"";this.set("customStyle",d+("\n"+a));c&&k.addStyleSheet(c,a,b)},removeCustomStyle:function(a){k.remove(k.get("#"+a,this.get("window")[0]))},addCustomLink:function(a){var b=this.get("customLink"),c=this.get("document")[0];b.push(a);this.set("customLink",b);b=c.createElement("link");b.rel="stylesheet";c.getElementsByTagName("head")[0].appendChild(b);b.href=a},removeCustomLink:function(b){for(var c=
this.get("document")[0],c=k.query("link",c),d=0;d<c.length;d++)k.attr(c[d],"href")==b&&k.remove(c[d]);c=this.get("customLink");b=a.indexOf(b,c);-1!=b&&c.splice(b,1)},docReady:function(a){this.on("docReady",a);this.__docReady&&a.call(this)},isDocReady:function(){return this.__docReady},checkSelectionChange:function(){var a=this;a.__checkSelectionChangeId&&clearTimeout(a.__checkSelectionChangeId);a.__checkSelectionChangeId=setTimeout(function(){var b=a.getSelection();if(b&&!b.isInvalid){var c=b.getStartElement(),
d=new n.ElementPath(c);if(!a.__previousPath||!a.__previousPath.compare(d))a.__previousPath=d,a.fire("selectionChange",{selection:b,path:d,element:c})}},100)},notifySelectionChange:function(){this.__previousPath=null;this.checkSelectionChange()},insertElement:function(a){if(1!==this.get("mode"))return e;this.focus();var c,d=a.nodeName(),f=n.XHTML_DTD,g=f.$block[d],h=n.RANGE,i=(d=this.getSelection())&&d.getRanges(),j,l,k;if(!i||0==i.length)return e;this.execCommand("save");for(l=i.length-1;0<=l;l--)j=
i[l],c=!l&&a||a.clone(b),j.insertNodeByDtd(c),k||(k=c);if(!k)return e;j.moveToPosition(k,h.POSITION_AFTER_END);g&&(a=n.Walker.whitespaces(!0),(a=(k=k.next(a,1))&&k[0].nodeType==u.ELEMENT_NODE&&k.nodeName())&&f.$block[a]&&f[a]["#text"]&&j.moveToElementEditablePosition(k));d.selectRanges([j]);this.focus();c&&1==c[0].nodeType&&c.scrollIntoView(e,{alignWithTop:!1,allowHorizontalScroll:!0,onlyScrollIfNeeded:!0});G.call(this);return c},insertHTML:function(a,b){var d=this,f,g=d.get("document")[0];if(1===
d.get("mode")){if(f=d.htmlDataProcessor)a=f.toDataFormat(a,b);d.focus();d.execCommand("save");if(i){f=g.selection;"Control"==f.type&&f.clear();try{f.createRange().pasteHTML(a)}catch(h){}}else try{g.execCommand("inserthtml",c,a)}catch(j){setTimeout(function(){if(0==d.getSelection().getRanges().length){var b=new n.Range(g),f=k.first(g.body,function(a){return 1==a.nodeType&&"br"!=k.nodeName(a)});f||(f=new t(g.createElement("p")),f._4e_appendBogus(e),g.body.appendChild(f[0]));b.setStartAt(f,n.RANGE.POSITION_AFTER_START);
b.select()}g.execCommand("inserthtml",c,a)},50)}setTimeout(function(){d.getSelection().scrollIntoView()},50);G.call(d)}}});n._initIFrame=function(a){var d=r.getInstance(a),e=d.get("document")[0],a=e.getElementById("ke_active_script");k.remove(a);j(d);var f=e.body;i?(f.hideFocus=b,f.disabled=b,f.contentEditable=b,f.removeAttribute("disabled")):setTimeout(function(){g.gecko||g.opera?f.contentEditable=b:g.webkit?f.parentNode.contentEditable=b:e.designMode="on"},0);if(g.gecko||g.opera){var h=e.documentElement;
z.on(h,"mousedown",function(a){if(a.target==h){g.gecko&&w(e,c);d.activateGecko()}})}setTimeout(function(){i&&setTimeout(function(){if(e){f.runtimeStyle.marginBottom="0px";f.runtimeStyle.marginBottom=""}},1E3)},0);setTimeout(function(){d.__docReady=1;d.fire("docReady");var a=d.get("disableObjectResizing"),b=d.get("disableInlineTableEditing");if(a||b)try{e.execCommand("enableObjectResizing",c,!a);e.execCommand("enableInlineTableEditing",c,!b)}catch(g){z.on(f,i?"resizestart":"resize",function(c){var d=
new t(c.target);(a||d.nodeName()==="table"&&b)&&c.preventDefault()})}},10)};var G=a.buffer(function(){this.execCommand("save")},50);return n},{requires:"editor/core/base,editor/core/utils,editor/core/focusManager,editor/core/styles,editor/core/zIndexManager,editor/core/clipboard,editor/core/enterKey,editor/core/htmlDataProcessor,editor/core/selectionFix".split(",")});
